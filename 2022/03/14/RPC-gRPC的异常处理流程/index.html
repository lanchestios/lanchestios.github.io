<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="封装 gRPC 调用异常处理的流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="RPC gRPC异常处理流程设计">
<meta property="og:url" content="http://example.com/2022/03/14/RPC-gRPC%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Lanchester Blog">
<meta property="og:description" content="封装 gRPC 调用异常处理的流程。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-03-14T14:05:00.000Z">
<meta property="article:modified_time" content="2023-01-30T05:43:10.827Z">
<meta property="article:author" content="Wang Zihao">
<meta property="article:tag" content="RPC">
<meta property="article:tag" content="gRPC">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/03/14/RPC-gRPC%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>RPC gRPC异常处理流程设计 | Lanchester Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lanchester Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Leave a leaf</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/14/RPC-gRPC%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Wang Zihao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lanchester Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RPC gRPC异常处理流程设计
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-14 22:05:00" itemprop="dateCreated datePublished" datetime="2022-03-14T22:05:00+08:00">2022-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-30 13:43:10" itemprop="dateModified" datetime="2023-01-30T13:43:10+08:00">2023-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>封装 gRPC 调用异常处理的流程。</p>
<span id="more"></span>
<p>gRPC 内部拥有简单的异常传递机制，通过以下方式以客户端可感知的方式生成异常。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 实现在 proto 文件定义的 rpc 接口</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">GreeterImpl</span> <span class="token keyword">extends</span> <span class="token class-name">GreeterGrpc<span class="token punctuation">.</span>GreeterImplBase</span> <span class="token punctuation">&#123;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">URB<span class="token punctuation">.</span>HelloRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">URB<span class="token punctuation">.</span>HelloReply</span><span class="token punctuation">></span></span> responseObserver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">StatusRuntimeException</span> e <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>INTERNAL
                                     <span class="token punctuation">.</span><span class="token function">withCause</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                     <span class="token punctuation">.</span><span class="token function">withDescription</span><span class="token punctuation">(</span><span class="token string">"This is a description"</span><span class="token punctuation">)</span>
                                     <span class="token punctuation">.</span><span class="token function">asRuntimeException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    responseObserver<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 <code>onError</code> 可以传递四种信息：</p>
<ol>
<li>代表该异常类型的 Status</li>
<li>代表抛出异常的 Cause</li>
<li>代表对异常的描述描述信息 Description</li>
<li>代表附加信息的元数据 Metadata</li>
</ol>
<p>但是在客户端只能接收到 Status、Description 和 Metadata 三种信息，丢失了异常堆栈信息。</p>
<p>此时，对于业务来说有以下两个问题：</p>
<ol>
<li>Status 应用于 gRPC 内部，但对于业务消费来说，有可能对于异常状态有着层级和粒度更加细致的要求。比如业务的一级异常为参数错误，其还有下设的二级异常为整型溢出等等。</li>
<li>Cause 是不会传递给客户端的，因此客户端并不能感知到哪里出问题了。是中间件报错？还是业务抛出的错误提示信息？如果对每一种异常（Exception）进行区分，在大多数业务系统中都会变成一种灾难。</li>
</ol>
<p>针对上述两个问题，我们需要从两方面着手解决：</p>
<ol>
<li>分门别类收敛繁杂的业务异常</li>
<li>将业务异常提示信息传递给客户端</li>
<li>（可选）将异常堆栈传递给客户端</li>
</ol>
<p>对于将业务异常提示信息传递给客户端也有两种方式：</p>
<ol>
<li>文本信息传递的方式</li>
<li>抛异常传递的方式</li>
</ol>
<h1 id="收敛业务异常"><a href="#收敛业务异常" class="headerlink" title="收敛业务异常"></a>收敛业务异常</h1><blockquote>
<p>  详细的定义及异常理论浅析请看 《架构设计 异常处理方案》</p>
</blockquote>
<p>简单来讲，层级式的异常（也就是通过继承的方式来组成异常的层级结构，如 Exception -&gt; SQLException -&gt; SQLTimeoutException）更适用于中间件的开发设计，因为中间件的调用方通常是代码，编程语言级别的异常能让使用者更方便的处理针对各个不同异常的情况。而业务代码通常在返回异常信息后，将其通过 TCP 或 UDP 传递给前端界面，显示的结果为字符串，因此以错误码的形式多级管理可能是一种更好的方式。并且业务代码通常比较灵活，并不能很好的抽象为某些固定的类型，因此错误码附加个性化描述的形式更能适应业务的表达及更好地收敛编码所用到的异常类型。</p>
<p>因此我们需要一个方便易用的模型来管理这些业务异常。</p>
<p>下面是异常通用错误码定义的类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * &#123;@link Exceptions&#125; 异常处理流程通用错误码
 * 规则如下：
 * 1. 通过收集通用错误码的方式收敛错误码爆炸的问题
 * 2. 通过 Exceptions 工具中的 desc 和 meta 信息完善业务异常
 * @author wangzihao
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Code</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// COMMON 也是给USR返回的数据内容，</span>
    <span class="token comment">// 如果同类别错误过多，则需要抽象更细化的错误类型</span>
    <span class="token function">COMMON_ERROR</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token string">"通用错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//用于 Asserts 断言</span>
    <span class="token comment">//////</span>
    <span class="token comment">// USR</span>
    <span class="token comment">//////</span>
    <span class="token function">INVALID_PARAMETER</span><span class="token punctuation">(</span><span class="token number">100001</span><span class="token punctuation">,</span> <span class="token string">"非法参数"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//////</span>
    <span class="token comment">// TPY</span>
    <span class="token comment">//////</span>
    <span class="token function">TRANSACTION_EXECUTE_FAIL</span><span class="token punctuation">(</span><span class="token number">100002</span><span class="token punctuation">,</span> <span class="token string">"事务执行失败"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//////</span>
    <span class="token comment">// INR</span>
    <span class="token comment">//////</span>
    <span class="token function">DATABASE_ROW_NOT_EXIST</span><span class="token punctuation">(</span><span class="token number">100003</span><span class="token punctuation">,</span> <span class="token string">"数据库不存在查询内容"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">CACHE_KEY_NOT_EXIST</span><span class="token punctuation">(</span><span class="token number">100004</span><span class="token punctuation">,</span> <span class="token string">"缓存不存在查询内容"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DISTRIBUTED_LOCK_BLOCKING</span><span class="token punctuation">(</span><span class="token number">100005</span><span class="token punctuation">,</span> <span class="token string">"分布式锁阻塞中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Code</span><span class="token punctuation">></span></span> relationship <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token operator">::</span><span class="token function">code</span><span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Code</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 各系统间 code 是通用的，但描述文案可以是不同的。</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Code</span> <span class="token function">parseFrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> relationship<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面是异常的 Builder：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Exception 异常处理流程
 * Exceptions.&#123;Type&#125;.&#123;withXXX&#125;.&#123;asException&#125; 的形式
 * Type 分为三种：
 * 1. USR 用户级，异常抛出可被用户看到
 * 2. INR 系统内部异常
 * 3. TPY 第三方系统异常（如中间件、其他服务等）
 * with可装填的信息有以下几种：
 * 1. Code 通用错误码，用于给各异常做个大体上的区分
 * 2. Description 附加错误信息，用于给 Code 细化其业务含义
 * 3. Meta 附加日志信息，用于给日志一些快速定位的条件
 * 4. cause 异常，如果异常来源于其他程序抛出的异常，由此统一引入调用栈
 * @author wangzihao
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exceptions</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Type</span> <span class="token punctuation">&#123;</span>
        USR<span class="token punctuation">,</span> <span class="token comment">// User 用户角色异常，需要对异常进行页面上的正确提示</span>
        INR<span class="token punctuation">,</span> <span class="token comment">// Inner System 系统内部级别的异常，需要将关键信息记录入日志</span>
        TPY<span class="token punctuation">;</span> <span class="token comment">// Third Party System 第三方系统，涉及到调用 RPC MQ 等服务的失败</span>

        <span class="token keyword">public</span> <span class="token class-name">Exceptions</span> <span class="token function">toExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> EXCEPTIONS_MAP<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">Exceptions</span><span class="token punctuation">></span></span> EXCEPTIONS_MAP <span class="token operator">=</span> <span class="token function">buildExceptionsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用单例生成填写Type的Exceptions优化生成速度，</span>
    <span class="token comment">// 且方便做统一初始化</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">Exceptions</span><span class="token punctuation">></span></span> <span class="token function">buildExceptionsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">Exceptions</span><span class="token punctuation">></span></span> canonicalizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> type <span class="token operator">:</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Exceptions</span> replaced <span class="token operator">=</span> canonicalizer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Exceptions</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>replaced <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Code value duplication between "</span>
                        <span class="token operator">+</span> replaced<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" &amp; "</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>canonicalizer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Exceptions</span> USR <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>USR<span class="token punctuation">.</span><span class="token function">toExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Exceptions</span> INR <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>INR<span class="token punctuation">.</span><span class="token function">toExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Exceptions</span> TPY <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>TPY<span class="token punctuation">.</span><span class="token function">toExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Type</span> type<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Code</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> meta<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">;</span>

    <span class="token class-name">Exceptions</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token class-name">Code</span><span class="token punctuation">.</span>COMMON_ERROR<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">Exceptions</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token class-name">Code</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> meta<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>meta <span class="token operator">=</span> meta<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cause <span class="token operator">=</span> cause<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Type</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Code</span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> meta<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Throwable</span> <span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> cause<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Exceptions</span> <span class="token function">withCode</span><span class="token punctuation">(</span><span class="token class-name">Code</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Exceptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>meta<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Exceptions</span> <span class="token function">withCause</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> cause<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cause<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Exceptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>meta<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Exceptions</span> <span class="token function">withDescription</span><span class="token punctuation">(</span><span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>description <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> description<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> description<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Exceptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> description<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>meta<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Exceptions</span> <span class="token function">withMeta</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> meta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>meta <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> meta<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>meta<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>meta <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> meta<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Exceptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> description<span class="token punctuation">,</span> meta<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">FundxException</span> <span class="token function">asCheckedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">validateParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FundxException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">FundxException</span> <span class="token function">asCheckedException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">validateParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FundxException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FundxException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>x <span class="token operator">-></span> x<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> exception<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">FundxRuntimeException</span> <span class="token function">asUncheckedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">validateParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FundxRuntimeException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">FundxRuntimeException</span> <span class="token function">asUncheckedException</span><span class="token punctuation">(</span><span class="token class-name">ExceptionHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">validateParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FundxRuntimeException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FundxRuntimeException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>x <span class="token operator">-></span> x<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> exception<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span>INR<span class="token punctuation">.</span><span class="token function">withCode</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span>INVALID_PARAMETER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDescription</span><span class="token punctuation">(</span><span class="token string">"Vertify type 参数不能为空."</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asUncheckedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span>INR<span class="token punctuation">.</span><span class="token function">withCode</span><span class="token punctuation">(</span><span class="token class-name">Code</span><span class="token punctuation">.</span>INVALID_PARAMETER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDescription</span><span class="token punctuation">(</span><span class="token string">"Vertify code 参数不能为空."</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asUncheckedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>  注意由于 Exceptions 的成员变量都是 final 类型，因此每次使用 withCode、withDescription、withCause、withMeta 都需要重新 new 一个对象。这通过 Immutable 的线程模式以一种较大的代价保证其线程安全，但由于 Exception 本身是低频的程序分支，因此在处理流程中也可以接受。</p>
</blockquote>
<p>下面是依赖的两个 Exception 类及其函数定义的扩展接口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FundxVirtualException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Exceptions<span class="token punctuation">.</span>Type</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Code</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FundxRuntimeException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token keyword">implements</span> <span class="token class-name">FundxVirtualException</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Exceptions</span> exceptions<span class="token punctuation">;</span>

    <span class="token class-name">FundxRuntimeException</span><span class="token punctuation">(</span><span class="token class-name">Exceptions</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exceptions<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exceptions <span class="token operator">=</span> exceptions<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Exceptions<span class="token punctuation">.</span>Type</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Code</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FundxException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token keyword">implements</span> <span class="token class-name">FundxVirtualException</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Exceptions</span> exceptions<span class="token punctuation">;</span>

    <span class="token class-name">FundxException</span><span class="token punctuation">(</span><span class="token class-name">Exceptions</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exceptions<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exceptions <span class="token operator">=</span> exceptions<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Exceptions<span class="token punctuation">.</span>Type</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Code</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> exceptions<span class="token punctuation">.</span><span class="token function">meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面是依赖的 Exception 后处理器的定义接口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExceptionHandler</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">FundxException</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">FundxRuntimeException</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>  使用后处理器可以很方便的集成功能插件，对抛出的异常做链式处理（如飞书报警、日志个性化打印、MQ 通知、短信通知等）。</p>
</blockquote>
<h1 id="传递异常"><a href="#传递异常" class="headerlink" title="传递异常"></a>传递异常</h1><p>根据异常设计的理论，异常需要通过网的方式被拦截，最后依次被个性化处理、统一处理，不应有未处理的异常被抛出在主线程。因此我们需要实现以下功能：</p>
<ol>
<li>客户端对服务端的异常是有感知的（✓）</li>
<li>客户端能从服务端获取特定的异常（✓）</li>
<li>客户端能从服务端获取自定义异常的文本信息（×）</li>
<li>客户端能从服务端获取自定义异常的堆栈信息（×）</li>
<li>客户端能抛出服务端自定义的异常（×）</li>
</ol>
<p>以上五条 <code>✓</code> 表示 gRPC 框架已实现， <code>×</code> 表示需要自己实现。</p>
<h2 id="获取自定义异常文本信息"><a href="#获取自定义异常文本信息" class="headerlink" title="获取自定义异常文本信息"></a>获取自定义异常文本信息</h2><p>传递文本信息在 gRPC 框架中本身就有着较好的支持，只需要通过 gRPC 内部的 <code>StatusRuntimeException</code> 传递即可。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Status</span><span class="token punctuation">.</span>INTERNAL
        <span class="token punctuation">.</span><span class="token function">withDescription</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withCause</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">asRuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>也可以通过 Metadata 的方式传递序列化的信息。</p>
<pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">message</span> <span class="token class-name">Error</span> <span class="token punctuation">&#123;</span>
  <span class="token builtin">string</span> type <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> code <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> description <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> cause <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> meta <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token class-name">Metadata</span> trailers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Base<span class="token punctuation">.</span>Error</span> error <span class="token operator">=</span> <span class="token class-name">Base<span class="token punctuation">.</span>Error</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">defaultIfBlank</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setCause</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">putAllMeta</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trailers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Metadata<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"error-bin"</span><span class="token punctuation">,</span> <span class="token class-name">Metadata</span><span class="token punctuation">.</span>BINARY_BYTE_MARSHALLER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Metadata</span><span class="token punctuation">.</span>BINARY_BYTE_MARSHALLER<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">.</span>INTERNAL<span class="token punctuation">.</span><span class="token function">withCause</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asRuntimeException</span><span class="token punctuation">(</span>trailers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决了客户端和服务端异常时数据相互传递的问题，接下来的问题是解决客户端能从服务端获取自定义异常的堆栈信息。</p>
<h2 id="获取自定义异常的堆栈信息"><a href="#获取自定义异常的堆栈信息" class="headerlink" title="获取自定义异常的堆栈信息"></a>获取自定义异常的堆栈信息</h2><p>需要知道的是，通过 gRPC 提供的异常 StatusRuntimeException 并不会序列化它的异常堆栈信息（其实也并没有必要，客户端在大多数情况下并不需要知道服务端为什么返回一个未知的报错，唯一我能想到的场景就是在 CS 两端联调的时候），那我们如何传递这个信息呢？</p>
<p>其实市面上有非常多的序列化类的方式：protobuf、thrift、JDK 提供的序列化方式等等，这里就不再赘述。只是简单地采用 JDK 自带的序列化工具。作为对端调试的能力并不需要考虑性能以及带宽等。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ByteString</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">FundxVirtualException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">ObjectOutputStream</span> oo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oo<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oo<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            oo<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ByteString</span><span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"StreamObserverDelegate IO 异常, 内容：&#123;&#125;"</span><span class="token punctuation">,</span> exception<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Throwable</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ByteString</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>byteArrayInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FundxVirtualException</span> ex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FundxVirtualException</span><span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            byteArrayInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ex<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Result IO 异常或 Cast 异常, 内容：&#123;&#125;"</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="抛出服务端自定义的异常"><a href="#抛出服务端自定义的异常" class="headerlink" title="抛出服务端自定义的异常"></a>抛出服务端自定义的异常</h2><p>我们有多个切入点去做这件事，如修改 GRPC 中 ServerCalls 和 ClientCalls 的源码让其支持这样一件事，但对于实现业务功能而修改中间件源码会带来更加复杂的问题。作者实现的思路：</p>
<ol>
<li>Server 端通过对 StreamObserver 的委托为其 onError 调用增加一条边路，通过 Metadata 传递自封装的业务异常信息。</li>
<li>Client 端通过对 Stub 的调用封装，对不同结果进行处理。</li>
</ol>
<p>以下是服务端封装思路：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamObserverDelegate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RespT</span> <span class="token keyword">extends</span> <span class="token class-name">Message</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RespT</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>


    <span class="token keyword">private</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RespT</span><span class="token punctuation">></span></span> origin<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">StreamObserverDelegate</span><span class="token punctuation">(</span><span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RespT</span><span class="token punctuation">></span></span> origin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"StreamObserverDelegate parameter can't be null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">=</span> origin<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">RespT</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">FundxException</span> <span class="token operator">||</span> t <span class="token keyword">instanceof</span> <span class="token class-name">FundxRuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// 业务异常，返回错误码和默认文案到客户端</span>
            <span class="token class-name">FundxVirtualException</span> exception <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FundxVirtualException</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span>

            <span class="token class-name">Metadata</span> trailers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Base<span class="token punctuation">.</span>Error</span> error <span class="token operator">=</span> <span class="token class-name">Base<span class="token punctuation">.</span>Error</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">defaultString</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setCause</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">putAllMeta</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            trailers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Metadata<span class="token punctuation">.</span>Key</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"error-bin"</span><span class="token punctuation">,</span> <span class="token class-name">Metadata</span><span class="token punctuation">.</span>BINARY_BYTE_MARSHALLER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Metadata</span><span class="token punctuation">.</span>BINARY_BYTE_MARSHALLER<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">.</span>INTERNAL<span class="token punctuation">.</span><span class="token function">withCause</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asRuntimeException</span><span class="token punctuation">(</span>trailers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 非业务异常，返回异常详情到客户端。</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">.</span>INTERNAL
                    <span class="token punctuation">.</span><span class="token function">withDescription</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">withCause</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">asRuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        origin<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">ByteString</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">FundxVirtualException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">ObjectOutputStream</span> oo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oo<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            oo<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            oo<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ByteString</span><span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"StreamObserverDelegate IO 异常, 内容：&#123;&#125;"</span><span class="token punctuation">,</span> exception<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对结果调用的封装：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">
public class Result &#123;

    private boolean isSuccess;
    private Object result;

    private Result(Object result, boolean isSuccess) &#123;
        this.result &#x3D; result;
        this.isSuccess &#x3D; isSuccess;
    &#125;

    public static &lt;T&gt; Result success(T result) &#123;
        return new Result(result, true);
    &#125;

    public static Result error(Base.Error result) &#123;
        return new Result(result, false);
    &#125;

    public boolean isSuccess() &#123;
        return isSuccess;
    &#125;

    public &lt;T&gt; T success() &#123;
        return isSuccess() ? (T) result : null;
    &#125;

    public Base.Error failure() &#123;
        return isSuccess() ? null : (Base.Error) result;
    &#125;

    public &lt;T&gt; T peek(Consumer&lt;T&gt; handler) &#123;

        try &#123;
            if (isSuccess()) &#123;
                T succeed &#x3D; (T) result;
                handler.accept(succeed);
                return succeed;
            &#125;
        &#125; catch (ClassCastException e) &#123;
            throw new ClassCastException(&quot;Result.peek 类型转换错误.&quot;);
        &#125;

        Base.Error error &#x3D; (Base.Error) result;
        throw Exceptions.Type.valueOf(error.getType()).toExceptions()
                .withCode(Code.parseFrom(error.getCode()))
                .withDescription(error.getDescription())
                .withCause(decode(error.getCause()))
                .withMeta(error.getMetaMap())
                .asUncheckedException();
    &#125;

    public &lt;T, R&gt; R map(Function&lt;T, R&gt; handler) &#123;

        try &#123;
            if (isSuccess()) &#123;
                return handler.apply((T) result);
            &#125;
        &#125; catch (ClassCastException e) &#123;
            throw new ClassCastException(&quot;Result.map 类型转换错误.&quot;);
        &#125;

        Base.Error error &#x3D; (Base.Error) result;
        throw Exceptions.Type.valueOf(error.getType()).toExceptions()
                .withCode(Code.parseFrom(error.getCode()))
                .withDescription(StringUtils.defaultIfBlank(error.getDescription(), null))
                .withCause(decode(error.getCause()))
                .withMeta(error.getMetaMap())
                .asUncheckedException();
    &#125;

    private Throwable decode(ByteString content) &#123;

        if (content.isEmpty())
            return null;

        try &#123;
            ByteArrayInputStream byteArrayInputStream &#x3D; new ByteArrayInputStream(content.toByteArray());
            ObjectInputStream ois &#x3D; new ObjectInputStream(byteArrayInputStream);
            FundxVirtualException ex &#x3D; (FundxVirtualException) ois.readObject();
            ois.close();
            byteArrayInputStream.close();
            return ex.getThrowable();
        &#125; catch (IOException | ClassNotFoundException e) &#123;
            log.error(&quot;Result IO 异常或 Cast 异常, 内容：&#123;&#125;&quot;, content, e);
            return null;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下是客户端封装思路：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public class Rpcs &#123;
    private static final Metadata.Key&lt;byte[]&gt; ERROR_KEY &#x3D; Metadata.Key.of(&quot;error-bin&quot;, Metadata.BINARY_BYTE_MARSHALLER);

    public static &lt;T, R&gt; Result execute(T item, Function&lt;T, R&gt; function) &#123;
        try &#123;
            R r &#x3D; function.apply(item);

            return Result.success(r);
        &#125; catch (StatusRuntimeException e) &#123;
            if (e.getTrailers() !&#x3D; null &amp;&amp; e.getTrailers().containsKey(ERROR_KEY)) &#123;
                try &#123;
                    return Result.error(Base.Error.parseFrom(e.getTrailers().get(ERROR_KEY)));
                &#125; catch (InvalidProtocolBufferException ipbe)&#123;
                    return Result.error(
                            Base.Error.newBuilder()
                                    .setType(Exceptions.Type.INR.name())
                                    .setCode(Code.INVALID_PARAMETER.code())
                                    .setDescription(&quot;未得到正确的序列化异常&quot;)
                                    .build());
                &#125;
            &#125; else &#123;
                throw e;
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="最终的实现效果"><a href="#最终的实现效果" class="headerlink" title="最终的实现效果"></a>最终的实现效果</h2><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">private class GreeterImpl extends GreeterGrpc.GreeterImplBase &#123;
  @Override
  public void sayHello(Base.HelloRequest req, StreamObserver&lt;Base.HelloReply&gt; responseObserver)&#123;
    StreamObserverDelegate&lt;Base.HelloReply&gt; delegate &#x3D; new StreamObserverDelegate&lt;&gt;(responseObserver);
    delegate.onError(
      Exceptions.USR
      .withCode(Code.COMMON_ERROR)
      .withDescription(&quot;测试业务描述&quot;)
      .withCause(new RuntimeException(&quot;测试Runtime异常&quot;))
      .asUncheckedException());
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过委托 StreamObserver 抛出封装的业务异常 FundxRuntimeException。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">Base.HelloRequest request &#x3D; Base.HelloRequest.newBuilder().setName(name).build();
Base.Error error &#x3D; Rpcs.execute(request, blockingStub::sayHello).success();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>客户端通过委托调用器获取最终的执行结果。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" exception.FundxRuntimeException: 测试业务描述
	at exception.Exceptions.asUncheckedException(Exceptions.java:132)
	at Result.peek(Result.java:62)
	at GrpcClient.greet(GrpcClient.java:35)
	at GrpcClient.main(GrpcClient.java:49)
Caused by: exception.FundxRuntimeException: 测试业务描述
	at exception.Exceptions.asUncheckedException(Exceptions.java:132)
	at HelloWorld_Server$GreeterImpl.sayHello(HelloWorld_Server.java:80)
	at com.elijah.grpc.GreeterGrpc$MethodHandlers.invoke(GreeterGrpc.java:236)
	at io.grpc.stub.ServerCalls$UnaryServerCallHandler$UnaryServerCallListener.onHalfClose(ServerCalls.java:171)
	at io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.halfClosed(ServerCallImpl.java:283)
	at io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed.runInContext(ServerImpl.java:707)
	at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)
	at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.lang.RuntimeException: 测试Runtime异常
	at HelloWorld_Server$GreeterImpl.sayHello(HelloWorld_Server.java:78)
	... 9 more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>日志获取到服务端的异常调用栈用于调试当前的程序。如果是非指定异常则与 gRPC 一般报错相同。</p>
<h1 id="传递信息"><a href="#传递信息" class="headerlink" title="传递信息"></a>传递信息</h1><p>但对于 gRPC 来说更好的实践应该是制定合理统一的错误码及返回文案，并且各调用方严格执行，但这种情况更适用于类似 IM 系统的产品，如石墨文档、聊天软件等。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/RPC/" rel="tag"># RPC</a>
              <a href="/tags/gRPC/" rel="tag"># gRPC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/22/SE-MessageQueue%E6%9E%B6%E6%9E%84%E6%96%B9%E6%A1%88/" rel="prev" title="架构设计 MessageQueue方案">
      <i class="fa fa-chevron-left"></i> 架构设计 MessageQueue方案
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/21/Linux-VIM%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/" rel="next" title="Linux VIM文本编辑器">
      Linux VIM文本编辑器 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%B6%E6%95%9B%E4%B8%9A%E5%8A%A1%E5%BC%82%E5%B8%B8"><span class="nav-number">1.</span> <span class="nav-text">收敛业务异常</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%A0%E9%80%92%E5%BC%82%E5%B8%B8"><span class="nav-number">2.</span> <span class="nav-text">传递异常</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E6%96%87%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-number">2.1.</span> <span class="nav-text">获取自定义异常文本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%9A%84%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF"><span class="nav-number">2.2.</span> <span class="nav-text">获取自定义异常的堆栈信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%9B%E5%87%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%BC%82%E5%B8%B8"><span class="nav-number">2.3.</span> <span class="nav-text">抛出服务端自定义的异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C"><span class="nav-number">2.4.</span> <span class="nav-text">最终的实现效果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%A0%E9%80%92%E4%BF%A1%E6%81%AF"><span class="nav-number">3.</span> <span class="nav-text">传递信息</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Wang Zihao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">143</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">286</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Zihao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
