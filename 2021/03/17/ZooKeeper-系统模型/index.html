<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="从数据节点、Watcher 和 ACL 五方面来讲述 ZooKeeper 的系统模型。">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper 系统模型">
<meta property="og:url" content="http://example.com/2021/03/17/ZooKeeper-%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9E%8B/index.html">
<meta property="og:site_name" content="Lanchester Blog">
<meta property="og:description" content="从数据节点、Watcher 和 ACL 五方面来讲述 ZooKeeper 的系统模型。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Zookeeper数据模型.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Stat对象状态属性说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/数据节点版本类型说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Watche机制概述.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Watcher通知状态与事件类型一览.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Watcher工作机制.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/客户端Watcher注册流程图.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/服务端处理Watcher的序列图.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/WatchManager数据结构.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/EventThread数据结构.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Scheme权限模式区别.png">
<meta property="article:published_time" content="2021-03-17T10:10:11.000Z">
<meta property="article:modified_time" content="2023-08-07T06:52:51.978Z">
<meta property="article:author" content="Wang Zihao">
<meta property="article:tag" content="ZooKeeper">
<meta property="article:tag" content="数据节点">
<meta property="article:tag" content="Watcher">
<meta property="article:tag" content="ACL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/ZooKeeper/Zookeeper数据模型.png">

<link rel="canonical" href="http://example.com/2021/03/17/ZooKeeper-%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9E%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ZooKeeper 系统模型 | Lanchester Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lanchester Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Leave a leaf</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/17/ZooKeeper-%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Wang Zihao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lanchester Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ZooKeeper 系统模型
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-17 18:10:11" itemprop="dateCreated datePublished" datetime="2021-03-17T18:10:11+08:00">2021-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-07 14:52:51" itemprop="dateModified" datetime="2023-08-07T14:52:51+08:00">2023-08-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index"><span itemprop="name">ZooKeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>从数据节点、Watcher 和 ACL 五方面来讲述 ZooKeeper 的系统模型。</p>
<span id="more"></span>
<h1 id="数据节点"><a href="#数据节点" class="headerlink" title="数据节点"></a>数据节点</h1><h2 id="节点结构"><a href="#节点结构" class="headerlink" title="节点结构"></a>节点结构</h2><p>ZooKeeper 的视图结构和使用了其特有的“数据节点”概念，我们称之为 ZNode。ZNode 是 ZooKeeper 中数据的最小单元，每个 ZNode 上都可以保存数据，同时还可以挂载子节点，因此构成了一个层次化的命名空间，我们称之为树。</p>
<p><img src="/images/ZooKeeper/Zookeeper数据模型.png" alt=""></p>
<h2 id="节点特性"><a href="#节点特性" class="headerlink" title="节点特性"></a>节点特性</h2><p><strong>节点类型</strong></p>
<p>在 ZooKeeper 中，每个数据节点都是有生命周期的，其生命周期的长短取决于数据节点的节点类型。在 ZooKeeper 中，节点类型可以分为持久节点（PERSISTENT）、临时节点（EPHEMERAL）和顺序节点（SEQUENTIAL）三大类，具体在节点创建过程中，通过组合使用，可以生成以下四种组合型节点类型：</p>
<p><em>持久节点（PERSISTENT）</em></p>
<p>持久节点是指该数据节点被创建后，就会一直存在于 ZK 服务器上，直到有删除操作来主动清除这个节点。</p>
<p><em>持久顺序节点（PERSISTENT SEQUENTIAL）</em></p>
<p>持久顺序节点的基本特性和持久节点是一致的，额外的特性表现在顺序性上。在 ZK 中，每个父节点都会为它的第一级子节点维护一份顺序，用于记录下每个子节点创建的先后顺序。基于这个顺序特性，在创建子节点的时候，可以设置这个标记，那么在创建节点过程中，ZK 会自动为给定节点名加上一个数字后缀，作为一个新的、完整的节点名。另外需要注意的是，这个数字后缀的上限是整型的最大值。</p>
<p><em>临时节点（EPHEMERAL）</em></p>
<p>和持久节点不同的是，临时节点的生命周期和客户端的会话绑定在一起，也就是说，如果客户端会话失效，那么这个节点就会被自动清理掉。注意，这里提到的是客户端会话失效，而非 TCP 连接断开。另外， ZK 规定了不能基于临时节点来创建子节点，即临时节点只能作为叶子节点。</p>
<p><em>临时顺序节点（EPHEMERAL SEQUENTIAL）</em></p>
<p>临时顺序节点的基本特性和临时节点也是一致的，同样是在临时节点的基础上，添加了顺序的特性。</p>
<p><strong>状态信息</strong></p>
<p><img src="/images/ZooKeeper/Stat对象状态属性说明.png" alt=""></p>
<h2 id="版本（保证分布式数据原子性操作）"><a href="#版本（保证分布式数据原子性操作）" class="headerlink" title="版本（保证分布式数据原子性操作）"></a>版本（保证分布式数据原子性操作）</h2><p><img src="/images/ZooKeeper/数据节点版本类型说明.png" alt=""></p>
<p>ZooKeeper 中的版本表示的是对数据节点的数据内容、子节点列表，或是节点 ACL 信息的修改次数，我们以其中的 version 这种版本类型为例来说明。</p>
<p>在一个数据节点<code>/zk-node</code>被创建完毕之后，节点的 version 值是 0，表示的含义是“当前节点自从创建之后，被更新过 0 次”。如果现在对该节点的数据内容进行更新操作，那么随后，version 的值就会变成 1。同时需要注意的是，在上文中提到的关于 version 的说明，其表示的是对数据节点数据内容的变更次数，强调的是变更次数，因此即使前后两次变更并没有使得数据内容的值发生变化，version 的值依然会变更。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">version &#x3D; setDataRequest.getversion();
int currentVersion &#x3D; nodeRecord.stat.getVersion();
if (version &#x3D; -1 &amp;&amp; version !&#x3D; currentVersion) &#123;
	throw new KeeperException.BadVersionException(path);
&#125;
version &#x3D; currentVersion + 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的执行逻辑中，我们可以看出，在进行一次 setDataRequest 请求处理时，首先进行了版本检查： ZooKeeper 会从 setDataRequest 请求中获取到当前请求的版本 version，同时从数据记录 nodeRecord 中获取到当前服务器上该数据的最新版本 currentVersion。</p>
<p>如果 version 为“-1”，那么说明客户端并不要求使用乐观锁，可以忽略版本比对；如果 version 不是“-1”，那么就比对 version 和 currentVersion，如果两个版本不匹配，那么将会抛出 BadVersionException 异常。</p>
<h1 id="Watcher（数据变更的通知）"><a href="#Watcher（数据变更的通知）" class="headerlink" title="Watcher（数据变更的通知）"></a>Watcher（数据变更的通知）</h1><p>ZooKeeper 提供了分布式数据的发布/订阅功能。一个典型的发布/订阅模型系统定义了一种一对多的订阅关系，能够让多个订阅者同时监听某个主题对象，当这个主题对象自身状态变化时，会通知所有订阅者，使它们能够做出相应的处理。在 ZooKeeper 中，引入了 Watcher 机制来实现这种分布式的通知功能。</p>
<p>ZooKeeper 允许客户端向服务端注册一个 Watcher 监听，当服务端的一些指定事件触发了这个 Watcher，那么就会向指定客户端发送一个事件通知来实现分布式的通知功能。整个 Watcher 注册与通知过程如图所示。</p>
<p><img src="/images/ZooKeeper/Watche机制概述.png" alt=""></p>
<p>ZooKeeper 的 Watcher 机制主要包括客户端线程、客户端 WatchManager 和 ZooKeeper 服务器三部分。在具体工作流程上，简单地讲，客户端在向 ZooKeeper 服务器注册 Watcher 的同时，会将 Watcher 对象存储在客户端的 WatchManager 中。当 ZooKeeper 服务器端触发 Watcher 事件后，会向客户端发送通知，客户端线程从 WatchManager 中取出对应的 Watcher 对象来执行回调逻辑。</p>
<h2 id="参数组成"><a href="#参数组成" class="headerlink" title="参数组成"></a>参数组成</h2><p><strong>Watcher接口</strong></p>
<p>在 ZooKeeper 中，接口类 Watcher 用于表示一个标准的事件处理器，其定义了事件通知相关的逻辑，包含 KeeperState 和 EventType 两个枚举类，分别代表了通知状态和事件类型，同时定义了事件的回调方法：<code>process(WatchedEvent event)</code></p>
<p><strong>Watcher事件</strong></p>
<p>同一个事件类型在不同的通知状态中代表的含义有所不同，下表列举了常见的通知状态和事件类型</p>
<p><img src="/images/ZooKeeper/Watcher通知状态与事件类型一览.png" alt=""></p>
<p>其中，针对 NodeDataChanged 事件的变更，包括节点的数据内容和数据的版本号 dataVersion。因此，即使使用相同的数据内容来更新，还是会触发这个事件通知，因为对于 ZooKeeper 来说，无论数据内容是否变更，一旦有客户端调用了数据更新的接口，且更新成功，就会更新 dataVersion 值。</p>
<blockquote>
<p>WatchedEvent 事件只包含 KeeperState、EventType 以及 Path，并没有传输数据，因此客户端无法直接从该事件中获取到对应数据节点的原始数据内容以及变更后的新数据内容，而是需要客户端再次主动去重新获取数据——这也是 ZooKeeper Watcher 机制的一个非常重要的特性。</p>
</blockquote>
<h2 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h2><p>如下图所示，客户端通过 SendThread 发送注册请求到 ZkServer 端；ZkServer 端通过 WatcherManager 管理所有的 Watcher，ZkClient 通过 ZKWatcherManager 管理所有的watcher。</p>
<p><img src="/images/ZooKeeper/Watcher工作机制.png" alt=""></p>
<h3 id="客户端注册Watcher"><a href="#客户端注册Watcher" class="headerlink" title="客户端注册Watcher"></a>客户端注册Watcher</h3><p>向构造方法传入一个默认的 Watcher</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public ZooKeeper(String connectString, int sessionTimeout, Watcher watcher);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个 Watcher 将作为整个 ZooKeeper 会话期间的负责监听会话变更状态的默认 Watcher，会一直被保存在客户端 ZKWatchManager 的 defaultWatcher 中。</p>
<p>另外也可以通过<code>getData()</code>、<code>getChildren()</code>、<code>exist()</code>三个接口来向 ZooKeeper 服务器注册 Watcher。</p>
<p>拿<code>getData()</code>举例，注册原理如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">,</span> <span class="token class-name">Stat</span> stat<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> clientPath <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token class-name">PathUtils</span><span class="token punctuation">.</span><span class="token function">validatePath</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// the watch contains the un-chroot path</span>
    <span class="token class-name">WatchRegistration</span> wcb <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//封装一个 Watcher 的注册信息 WatchRegistration 对象，</span>
    <span class="token comment">//用于暂时保存数据节点的路径和 Watcher 的对应关系</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        wcb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataWatchRegistration</span><span class="token punctuation">(</span>watcher<span class="token punctuation">,</span> clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">final</span> <span class="token class-name">String</span> serverPath <span class="token operator">=</span> <span class="token function">prependChroot</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RequestHeader</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    h<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs<span class="token punctuation">.</span>OpCode</span><span class="token punctuation">.</span>getData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetDataRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetDataRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>serverPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//对Request请求进行标记，将其设置为使用监听</span>
    request<span class="token punctuation">.</span><span class="token function">setWatch</span><span class="token punctuation">(</span>watcher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetDataResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetDataResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ReplyHeader</span> r <span class="token operator">=</span> cnxn<span class="token punctuation">.</span><span class="token function">submitRequest</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> wcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token class-name">KeeperException</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">KeeperException<span class="token punctuation">.</span>Code</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DataTree</span><span class="token punctuation">.</span><span class="token function">copyStat</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 ZooKeeper 中，Packet 可以被看作一个最小的通信协议单元，用于进行客户端与服务端之间的网络传输，任何需要传输的对象都需要包装成一个 Packet 对象。因此，在 ClientCnxn 中 WatchRegistration 又会被封装到 Packet 中去，然后放入发送队列中等待客户端发送。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Packet</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span>
    <span class="token class-name">RequestHeader</span> h<span class="token punctuation">,</span>
    <span class="token class-name">ReplyHeader</span> r<span class="token punctuation">,</span>
    <span class="token class-name">Record</span> request<span class="token punctuation">,</span>
    <span class="token class-name">Record</span> response<span class="token punctuation">,</span>
    <span class="token class-name">AsyncCallback</span> cb<span class="token punctuation">,</span>
    <span class="token class-name">String</span> clientPath<span class="token punctuation">,</span>
    <span class="token class-name">String</span> serverPath<span class="token punctuation">,</span>
    <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span>
    <span class="token class-name">WatchRegistration</span> watchRegistration<span class="token punctuation">,</span>
    <span class="token class-name">WatchDeregistration</span> watchDeregistration<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Packet</span> packet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// Note that we do not generate the Xid for the packet yet. It is</span>
    <span class="token comment">// generated later at send-time, by an implementation of ClientCnxnSocket::doIO(),</span>
    <span class="token comment">// where the packet is actually sent.</span>
    packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Packet</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> watchRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The synchronized block here is for two purpose:</span>
    <span class="token comment">// 1. synchronize with the final cleanup() in SendThread.run() to avoid race</span>
    <span class="token comment">// 2. synchronized against each packet. So if a closeSession packet is added,</span>
    <span class="token comment">// later packet will be notified.</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> closing<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">conLossPacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// If the client is asking to close the session then</span>
            <span class="token comment">// mark as closing</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>closeSession<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                closing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            outgoingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    sendThread<span class="token punctuation">.</span><span class="token function">getClientCnxnSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">packetAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> packet<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>随后，ZooKeeper 客户端就会向服务端发送这个请求，同时等待请求的返回。完成请求发送后，会由客户端 SendThread 线程的 readResponse 方法负责接收来自服务端的响应，finishPacket 方法会从 Packet 中取出对应的 Watcher 并注册到 ZKWatchManager 中去。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// @VisibleForTesting</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishPacket</span><span class="token punctuation">(</span><span class="token class-name">Packet</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span>replyHeader<span class="token punctuation">.</span><span class="token function">getErr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>watchRegistration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        p<span class="token punctuation">.</span>watchRegistration<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Add all the removed watch events to the event queue, so that the</span>
    <span class="token comment">// clients will be notified with 'Data/Child WatchRemoved' event type.</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>cb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            p<span class="token punctuation">.</span>finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        p<span class="token punctuation">.</span>finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        eventThread<span class="token punctuation">.</span><span class="token function">queuePacket</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的内容中，我们已经了解到客户端已经将 Watcher 暂时封装在了 WatchRegistration 对象中，现在就需要从这个封装对象中再次提取出 Watcher 来：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAddWatch</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span><span class="token punctuation">></span></span> watches <span class="token operator">=</span> <span class="token function">getWatches</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>watches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> watchers <span class="token operator">=</span> watches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>watchers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                watchers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                watches<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">,</span> watchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            watchers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 register 方法中，客户端会将之前暂时保存的 Watcher 对象转交给 ZKWatchManager，并最终保存到 dataWatches 中去。ZKWatchManager.dataWatches 是一个<code>Map&lt;String,Set&lt;Watcher&gt;&gt;</code>类型的数据结构，用于将数据节点的路径和 Watcher 对象进行一一映射后管理起来。整个客户端 Watcher 的注册流程如下图所示。</p>
<p><img src="/images/ZooKeeper/客户端Watcher注册流程图.png" alt=""></p>
<p>通过上面的讲解，相信读者已经对客户端的 Watcher 注册流程有了一个大概的了解。但同时我们也可以发现，极端情况下，客户端毎调用一次<code>getData()</code>接口，就会注册上个 Watcher，那么这些 Watcher 实体都会随着客户端请求被发送到服务端去吗？</p>
<p>答案是否定的。如果客户端注册的所有 Watcher 都被传递到服务端的话，那么服务端肯定会出现内存紧张或其他性能问题了，幸运的是，在 ZooKeeper 的设计中充分考虑到了这个问题。在上面的流程中，我们提到把 WatchRegistration 封装到了 Packet 对象中去，但事实上，在底层实际的网络传输序列化过程中，并没有将 WatchRegistration 对象完全地序列化到底层字节数组中去。为了证实这一点，我们可以看下 Packet 内部的序列化过程</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createBB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BinaryOutputArchive</span> boa <span class="token operator">=</span> <span class="token class-name">BinaryOutputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        boa<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// We'll fill this in later</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>boa<span class="token punctuation">,</span> <span class="token string">"header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">ConnectRequest</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            request<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>boa<span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// append "am-I-allowed-to-be-readonly" flag</span>
            boa<span class="token punctuation">.</span><span class="token function">writeBool</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">,</span> <span class="token string">"readOnly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            request<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>boa<span class="token punctuation">,</span> <span class="token string">"request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        baos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bb <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bb<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bb<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bb<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的代码片段中，我们可以看到，在<code>Packet.create()</code>方法中，ZooKeeper 只会将 requestHeader 和 request 两个属性进行序列化，也就是说，尽管 WatchRegistration 被封装在了 Packet 中，但是并没有被序列化到底层字节数组中去，因此也就不会进行网络传输了。</p>
<h3 id="服务端处理Watcher"><a href="#服务端处理Watcher" class="headerlink" title="服务端处理Watcher"></a>服务端处理Watcher</h3><h4 id="ServerCnxn存储"><a href="#ServerCnxn存储" class="headerlink" title="ServerCnxn存储"></a><strong>ServerCnxn存储</strong></h4><p><img src="/images/ZooKeeper/服务端处理Watcher的序列图.png" alt=""></p>
<p>从上图中我们可以看到，服务端收到来自客户端的请求之后，在<code>FinalRequestProcessor.processRequest()</code>中会判断当前请求是否需要注册 Watcher：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">case OpCode.getData:
    rec &#x3D; handleGetDataRequest(readOp.toRequestRecord(), cnxn, request.authInfo);
    GetDataResponse gdr &#x3D; (GetDataResponse) rec;
    subResult &#x3D; new GetDataResult(gdr.getData(), gdr.getStat());
    break;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Record</span> <span class="token function">handleGetDataRequest</span><span class="token punctuation">(</span><span class="token class-name">Record</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerCnxn</span> cnxn<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">></span></span> authInfo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">GetDataRequest</span> getDataRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GetDataRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
    <span class="token class-name">String</span> path <span class="token operator">=</span> getDataRequest<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataNode</span> n <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    zks<span class="token punctuation">.</span><span class="token function">checkACL</span><span class="token punctuation">(</span>cnxn<span class="token punctuation">,</span> zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aclForNode</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span>READ<span class="token punctuation">,</span> authInfo<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Stat</span> stat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> stat<span class="token punctuation">,</span> getDataRequest<span class="token punctuation">.</span><span class="token function">getWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> cnxn <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GetDataResponse</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从 getData 请求的处理逻辑中，我们可以看到，当<code>getDataRequest.getWatch()</code>为 true 的时侯，ZooKeeper 就认为当前客户端请求需要进行 Watcher 注册，于是就会将当前的 ServerCnxn 对象和数据节点路径传入 getData 方法中去。那么为什么要传入ServerCnxn 呢？ServerCnxn 是一个 ZooKeeper 客户端和服务器之间的连接接口，代表了一个客户端和服务器的连接。ServerCnxn 接口的默认实现是 NIOServerCnxn，同时从3.4.0版本开始，引入了基于 Netty 的实现：NettyServerCnxn。无论采用哪种实现方式，都实现了 Watcher 的 process 接口，因此我们可以把 ServerCnxn 看作是一个 Watcher对象。数据节点的节点路径和 ServerCnxn 最终会被存储在 WatchManager 的 watchTable 和 watch2Paths 中。</p>
<p>WatchManager 是 ZooKeeper 服务端 Watcher 的管理者，其内部管理的 watchTable 和 watch2Paths 两个存储结构，分别从两个维度对 Watcher 进行存储。</p>
<ul>
<li>watchTable 是从数据节点路径的粒度来托管 Watcher。</li>
<li>watch2Paths 是从 Watcher 的粒度来控制事件触发需要触发的数据节点。</li>
</ul>
<p>同时，WatchManager 还负责 Watcher 事件的触发，并移除那些已经被触发的 Watcher。注意，WatchManager 只是一个统称，在服务端，DataTree 中会托管两个 WatchManager，分别是 dataWatches 和 childWatches，分别对应数据变更 Watcher 和子节点变更 Watcher。在本例中，因为是 getData 接口，因此最终会被存储在 dataWatches 中，其数据结构如下图所示。</p>
<p><img src="/images/ZooKeeper/WatchManager数据结构.png" alt=""></p>
<h4 id="Watcher触发"><a href="#Watcher触发" class="headerlink" title="Watcher触发"></a>Watcher触发</h4><p>对于标记了 Watcher 注册的请求，ZooKeeper 会将其对应的 ServerCnxn 存储到 WatchManager 中，下面我们来看看服务端是如何触发 Watcher 的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Stat</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DataNode</span> n <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token comment">//...</span>
    
    <span class="token function">updateWriteStat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> dataBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataWatches<span class="token punctuation">.</span><span class="token function">triggerWatch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">EventType<span class="token punctuation">.</span>NodeDataChanged</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">WatcherOrBitSet</span> <span class="token function">triggerWatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">EventType</span> type<span class="token punctuation">,</span> <span class="token class-name">WatcherOrBitSet</span> supress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">WatchedEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchedEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token class-name">KeeperState<span class="token punctuation">.</span>SyncConnected</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> watchers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PathParentIterator</span> pathParentIterator <span class="token operator">=</span> <span class="token function">getPathParentIterator</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//...</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Watcher</span> w <span class="token operator">:</span> watchers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supress <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> supress<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        w<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token class-name">NodeCreated</span><span class="token operator">:</span>
            <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NODE_CREATED_WATCHER<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token class-name">NodeDeleted</span><span class="token operator">:</span>
            <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NODE_DELETED_WATCHER<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token class-name">NodeDataChanged</span><span class="token operator">:</span>
            <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NODE_CHANGED_WATCHER<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token class-name">NodeChildrenChanged</span><span class="token operator">:</span>
            <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NODE_CHILDREN_WATCHER<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token comment">// Other types not logged.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WatcherOrBitSet</span><span class="token punctuation">(</span>watchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="过程总结"><a href="#过程总结" class="headerlink" title="过程总结"></a>过程总结</h4><ol>
<li><p>封装 WatchedEvent</p>
<p> 首先将通知状态（KeeperState）、事件类型（EventType）以及节点路径（Path）封装成一个 WatchedEvent 对象。</p>
</li>
<li><p>查询 Watcher<br> 根据数据节点的节点路径从 watchTable 中取出对应的 Watcher。如果没有找到 Watcher，说明没有任何客户端在该数据节点上注册过 Watcher，直接退出。而如果找到了这个 Watcher，会将其提取出来，同时会直接从 watchTable 和 watch2Paths 中将其删除 —— 从这里我们也可以看出，Watcher 在服务端是一次性的，即触发一次就失效了。</p>
</li>
<li><p>调用 process 方法来触发 Watcher</p>
<p> 在这一步中，会逐个依次地调用从步骤 2 中找出的所有 Watcher 的 process 方法。那么这里的 process 方法究竟做了些什么呢？在上文中我们已经提到，对于需要注册 Watcher 的请求，ZooKeeper 会把当前请求对应的 ServerCnxn 作为一个 Watcher 进行存储，因此，这里调用的 process 方法，事实上就是 ServerCnxn 的对应方法：</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public void process(WatchedEvent event) &#123;
    ReplyHeader h &#x3D; new ReplyHeader(ClientCnxn.NOTIFICATION_XID, -1L, 0);

    &#x2F;&#x2F; Convert WatchedEvent to a type that can be sent over the wire
    WatcherEvent e &#x3D; event.getWrapper();

    &#x2F;&#x2F; The last parameter OpCode here is used to select the response cache.
    &#x2F;&#x2F; Passing OpCode.error (with a value of -1) means we don&#39;t care, as we don&#39;t need
    &#x2F;&#x2F; response cache on delivering watcher events.
    sendResponse(h, e, &quot;notification&quot;, null, null, ZooDefs.OpCode.error);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 从上面的代码片段中，我们可以看出在 process 方法中，主要逻辑如下。</p>
<ul>
<li>在请求头中标记“-1”，表明当前是一个通知。</li>
<li>将 WatchedEvent 包装成 WatcherEvent，以便进行网络传输序列化。</li>
<li><p>向客户端发送该通知。</p>
<p>从以上几个步骤中可以看到，ServerCnxn 的 process 方法中的逻辑非常简单，本质上并不是处理客户端 Watcher 真正的业务逻辑，而是借助当前客户端连接的 ServerCnxn 对象来实现对客户端的 WatchedEvent 传递，真正的客户端 Watcher 回调与业务逻辑执行都在客户端。</p>
</li>
</ul>
</li>
</ol>
<h3 id="客户端回调Watcher"><a href="#客户端回调Watcher" class="headerlink" title="客户端回调Watcher"></a>客户端回调Watcher</h3><h4 id="SendThread接收时间通知"><a href="#SendThread接收时间通知" class="headerlink" title="SendThread接收时间通知"></a>SendThread接收时间通知</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SendThread</span> <span class="token keyword">extends</span> <span class="token class-name">ZooKeeperThread</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">readResponse</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> incomingBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//..</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于一个来自服务端的响应，客户端都是由<code>Sendthread.readResponse(ByteBuffer incomingBuffer)</code>方法来统一进行处理的，如果响应头 replyHdr 中标识了 XID 为 -1，表明这是一个通知类型的响应，对其的处理大体上分为以下 4 个主要步骤。</p>
<ol>
<li>反序列化<br> ZooKeeper 客户端接到请求后，首先会将字节流转换成 WatcherEvent 对象。</li>
<li>处理 chrootPath<br> 如果客户端设置了 chrootPath 属性，那么需要对服务端传过来的完整的节点路径进行 chrootPath 处理，生成客户端的一个相对节点路径。例如客户端设置了 chrootPath 为<code>/app1</code>，那么针对服务端传过来的响应包含的节点路径为<code>/app1/locks</code>，经过 chrootPath 处理后，就会变成一个相对路径：<code>/locks</code>。关于 ZooKeeper 的 chrootPath。</li>
<li><p>还原 WatchedEvent<br> process 接口的参数定义是 WatchedEvent，因此这里需要将 WatcherEvent 对象转换成 WatchedEvent。</p>
</li>
<li><p>回调 Watcher</p>
<p> 最后将 WatchedEvent 对象交给 EventThread 线程，在下一个轮询周期中进行 Watcher 回调。</p>
</li>
</ol>
<h4 id="EventThread处理事件通知"><a href="#EventThread处理事件通知" class="headerlink" title="EventThread处理事件通知"></a>EventThread处理事件通知</h4><p><img src="/images/ZooKeeper/EventThread数据结构.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queueEvent</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> materializedWatchers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EventType<span class="token punctuation">.</span>None</span> <span class="token operator">&amp;&amp;</span> sessionState <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    sessionState <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> watchers<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>materializedWatchers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// materialize the watchers based on the event</span>
        watchers <span class="token operator">=</span> watcher<span class="token punctuation">.</span><span class="token function">materialize</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        watchers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        watchers<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>materializedWatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">WatcherSetEventPair</span> pair <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatcherSetEventPair</span><span class="token punctuation">(</span>watchers<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// queue the pair (watch set &amp; event) for later processing</span>
    waitingEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>queueEvent 方法首先会根据该通知事件，从 ZKWatchManager 中取出所有相关的 Watcher</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> <span class="token function">materialize</span><span class="token punctuation">(</span>
        <span class="token class-name">Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState</span> state<span class="token punctuation">,</span>
        <span class="token class-name">Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>EventType</span> type<span class="token punctuation">,</span>
        <span class="token class-name">String</span> clientPath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token class-name">None</span><span class="token operator">:</span>
            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>defaultWatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> clear <span class="token operator">=</span> disableAutoWatchReset <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> <span class="token class-name">Watcher<span class="token punctuation">.</span>Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> ws <span class="token operator">:</span> dataWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    dataWatches<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>existWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> ws <span class="token operator">:</span> existWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    existWatches<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> ws <span class="token operator">:</span> childWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    childWatches<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>persistentWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> ws<span class="token operator">:</span> persistentWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>persistentRecursiveWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> ws<span class="token operator">:</span> persistentRecursiveWatches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">NodeDataChanged</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token class-name">NodeCreated</span><span class="token operator">:</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">addTo</span><span class="token punctuation">(</span>dataWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>existWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">addTo</span><span class="token punctuation">(</span>existWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">addPersistentWatches</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">NodeChildrenChanged</span><span class="token operator">:</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">addTo</span><span class="token punctuation">(</span>childWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">addPersistentWatches</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">NodeDeleted</span><span class="token operator">:</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">addTo</span><span class="token punctuation">(</span>dataWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// TODO This shouldn't be needed, but just in case</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>existWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> existWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">addTo</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"We are triggering an exists watch for delete! Shouldn't happen!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">addTo</span><span class="token punctuation">(</span>childWatches<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">addPersistentWatches</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">"Unhandled watch event type %s with state %s on path %s"</span><span class="token punctuation">,</span>
                type<span class="token punctuation">,</span>
                state<span class="token punctuation">,</span>
                clientPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addPersistentWatches</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientPath<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Watcher</span><span class="token punctuation">></span></span> result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>persistentWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">addTo</span><span class="token punctuation">(</span>persistentWatches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>persistentRecursiveWatches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> path <span class="token operator">:</span> <span class="token class-name">PathParentIterator</span><span class="token punctuation">.</span><span class="token function">forAll</span><span class="token punctuation">(</span>clientPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asIterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">addTo</span><span class="token punctuation">(</span>persistentRecursiveWatches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>客户端在识别出事件类型 EventType 后，会从相应的 Watcher 存储（即 dataWatches、existWatches 或 childWatches 中的一个或多个）中去除对应的 Watcher。注意，此处使用的是 remove 接口，因此也表明了客户端的 Watcher 机制同样也是一次性的，即一旦被触发后，该 Watcher 就失效了。</p>
<p>获取到相关的所有 Watcher 之后，会将其放入 waitingEvents 这个队列中去。WaitingEvents 是一个待处理 Watcher 的队列，EventThread 的 run 方法会不断对该队列进行处理。EventThread 线程每次都会从 waitingEvents 队列中取出一个 Watcher，并进行串行同步处理。注意，此处 processEvent 方法中的 Watcher 才是之前客户端真正注册的 Watcher，调用其 process 方法就可以实现 Watcher 的回调了。</p>
<h2 id="特性总结"><a href="#特性总结" class="headerlink" title="特性总结"></a>特性总结</h2><p><strong>一次性</strong></p>
<p>一次使用后就会被移除，这样的设计有效地减轻了服务端的压力。如果注册一个 Watcher 之后一直有效，那么，针对那些更新非常频繁的节点，服务端会不断地向客户端发送事件通知，这无论对于网络还是服务端性能的影响都非常大。</p>
<p><strong>客户端串行执行</strong></p>
<p>客户端 Watcher 回调的过程是一个串行同步的过程，这为我们保证了顺序，同时，需要开发人员注意的一点是，千万不要因为一个 Watcher 的处理逻辑影响了整个客户端的 Watcher 回调。</p>
<p><strong>轻量</strong></p>
<p>WatchedEvent 是 ZooKeeper 整个 Watcher 通知机制的最小通知单元，这个数据结构中只包含三部分内容：通知状态、事件类型和节点路径。也就是说，Watcher 通知非常简单，只会告诉客户端发生了事件，而不会说明事件的具体内容。例如针对 NodeDataChanged 事件，ZooKeeper 的 Watcher 只会通知客户端指定数据节点的数据内容发生了变更，而对于原始数据以及变更后的新数据都无法从这个事件中直接获取到，而是需要客户端主动重新去获取数据 —— 这也是 ZooKeeper 的 Watcher 机制的一个非常重要的特性。</p>
<p>另外，客户端向服务端注册 Watcher 的时候，并不会把客户端真实的 Watcher 对象传递到服务端，仅仅只是在客户端请求中使用 boolean 类型属性进行了标记，同时服务端也仅仅只是保存了当前连接的 ServerCnxn 对象。</p>
<h1 id="ACL（保障数据安全）"><a href="#ACL（保障数据安全）" class="headerlink" title="ACL（保障数据安全）"></a>ACL（保障数据安全）</h1><p>ZooKeeper 提供了一套完善的 ACL（Access Control List）权限控制机制来保障数据的安全。</p>
<p>提到权限控制，在 Unix/Linux 文件系统中使用的，也是目前应用最广泛的权限控制方式 —— UGO（User、Group 和 Others）权限控制机制。简单地讲，UGO 就是针对一个文件或目录，对创建者（User）、创建者所在的组（Group）和其他用户（Other）分别配置不同的权限。从这里可以看出，UGO 其实是一种粗粒度的文件系统权限控制模式，利用 UGO 只能对三类用户进行权限控制，即文件的创建者、创建者所在的组以及其他所有用户，很显然，UGO 无法解决下面这个场景：</p>
<blockquote>
<p>用户 U1 创建了文件 F1，希望 U1 所在的用户组 G1 拥有对 F1 读写和执行的权限，另一个用户组 G2 拥有读权限，而另外一个用户 U3 则没有任何权限。</p>
</blockquote>
<p>接下去我们来看另外一种典型的权限控制方式：ACL。ACL，即访问控制列表，是一种相对来说比较新颖且更细粒度的权限管理方式，可以针对任意用户和组进行细粒度的权限控制。目前绝大部分 Unix 系统都已经支持了 ACL 方式的权限控制，Linux 也从 2.6 版本的内核开始支持这个特性。</p>
<h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><h3 id="权限模式：Scheme"><a href="#权限模式：Scheme" class="headerlink" title="权限模式：Scheme"></a>权限模式：Scheme</h3><p>权限模式用来确定权限验证过程中使用的检验策略。在 ZooKeeper 中，开发人员使用最多的就是以下四种权限模式。</p>
<p><em>IP</em></p>
<p>IP 模式通过 IP 地址粒度来进行权限控制，例如配置了<code>ip:192.168.0.110</code>，即表示权限控制都是针对这个 IP 地址的。同时，IP 模式也支持按照网段的方式进行配置，例如<code>ip:192.168.0.1/24</code>表示针对<code>192.168.0.*</code>这个 IP 段进行权限控制。</p>
<p><em>Digest</em></p>
<p>Digest 是最常用的权限控制模式，也更符合我们对于权限控制的认识，其以类似于<code>username:password</code>形式的权限标识来进行权限配置，便于区分不同应用来进行权限控制。</p>
<p>当我们通过<code>username:password</code>形式配置了权限标识后，ZooKeeper 会对其先后进行两次编码处理，分别是 SHA-1 算法加密和 BASE64 编码，其具体实现由<code>DigestAuthenticationProvider.generateDigest(String idPassword)</code>函数进行封装。</p>
<p><em>World</em></p>
<p>World 是一种最开放的权限控制模式，从其名字中也可以看出，事实上这种权限控制方式几乎没有任何作用，数据节点的访问权限对所有用户开放，即所有用户都可以在不进行任何权限校验的情况下操作 ZooKeeper 上的数据。另外，World 模式也可以看作是一种特殊的 Digest 模式，它只有一个权限标识，即“world:anyone”。</p>
<p><em>Super</em></p>
<p>Super 模式，顾名思义就是超级用户的意思，也是一种特殊的 Digest 模式。在 Super 模式下，超级用户可以对任意 ZooKeeper 上的数据节点进行任何操作。</p>
<p>下图为四种权限模式的区别</p>
<p><img src="/images/ZooKeeper/Scheme权限模式区别.png" alt=""></p>
<h3 id="权限模式：Permission"><a href="#权限模式：Permission" class="headerlink" title="权限模式：Permission"></a>权限模式：Permission</h3><p>权限就是指那些通过权限检査后可以被允许执行的操作。在 ZooKeeper 中，所有对数据的操作权限分为以下五大类：</p>
<ul>
<li>CREATE（C）：数据节点的创建权限，允许授权对象在该数据节点下创建子节点。</li>
<li>DELETE（D）：子节点的删除权限，允许授权对象删除该数据节点的子节点。</li>
<li>READ（R）：数据节点的读取权限，允许授权对象访问该数据节点并读取其数据内容或子节点列表等。</li>
<li>WRITE（W）：数据节点的更新权限，允许授权对象对该数据节点进行更新操作。</li>
<li>ADMIN（A）：数据节点的管理权限，允许授权对象对该数据节点进行 ACL 相关的设置操作。</li>
</ul>
<h2 id="权限扩展体系"><a href="#权限扩展体系" class="headerlink" title="权限扩展体系"></a>权限扩展体系</h2><p>同时，ZooKeeper 提供了特殊的权限控制插件体系，允许开发人员通过指定方式对 ZooKeeper 的杈限进行扩展。这些扩展的权限控制方式就像插件一样插入到 ZooKeeper 的权限体系中去，因此在 ZooKeeper 的官方文档中，也称该机制为“Pluggable ZooKeeper Authentication”。</p>
<h3 id="实现自定义权限控制器"><a href="#实现自定义权限控制器" class="headerlink" title="实现自定义权限控制器"></a>实现自定义权限控制器</h3><p>用户可以基于<code>org.apache.zookeeper.server.auth.AuthenticationProvider</code>来进行自定义权限控制器的实现。事实上，在前面内容中提到的几个权限模式，对应的就是 ZooKeeper 自带的 DigestAuthenticationProvider 和 IPAuthenticationProvider 两个权限控制器。</p>
<h3 id="注册自定义权限控制器"><a href="#注册自定义权限控制器" class="headerlink" title="注册自定义权限控制器"></a>注册自定义权限控制器</h3><p>完成自定义权限控制器的开发后，接下去就需要将该权限控制器注册到 ZooKeeper 服务器中去了。ZooKeeper 支持通过系统属性和配置文件两种方式来注册自定义的权限控制器。</p>
<p><strong>系统属性 -Dzookeeper.authProvider.X</strong></p>
<p>在 ZooKeeper 启动参数中配置类似于如下的系统属性</p>
<blockquote>
<p>-Dzookeeper.authProvider.1=com.zkbook.CustomAuthenticationProvider</p>
</blockquote>
<p><strong>配置文件方式</strong></p>
<p>在 zoo.cfg 配置文件中配置类似于如下的配置项：</p>
<blockquote>
<p>authProvider.1=com.zkbook.CustomAuthenticationProvider</p>
</blockquote>
<p>对于权限控制器的注册，ZooKeeper 采用了延迟加载的策略，即只有在第一次处理包含权限控制的客户端请求时，才会进行权限控制器的初始化。同时，ZooKeeper 还会将所有的权限控制器都注册到 ProviderRegistry 中去。在具体的实现中，ZooKeeper 首先会将 DigestAuthenticationProvider 和 IPAuthenticationProvider 这两个默认的控制器初始化，然后通过扫描<code>zookeeper.authProvider.</code>这一系统属性，获取到所有用户配置的自定义权限控制器，并完成其初始化。</p>
<h2 id="Super模式"><a href="#Super模式" class="headerlink" title="Super模式"></a>Super模式</h2><p>根据 ACL 权限控制的原理，一旦对一个数据节点设置了 ACL 权限控制，那么其他没有被授权的 ZooKeeper 客户端将无法访问该数据节点，这的确很好地保证了 ZooKeeper 的数据安全。但同时，ACL 权限控制也给 ZooKeeper 的运维人员带来了一个困扰：如果一个持久数据节点包含了 ACL 权限控制，而其创建者客户端已经退出或已不再使用，那么这些数据节点该如何清理呢？这个时候，就需要在 ACL 的 Super 模式下，使用超级管理员权限来进行处理了。要使用超级管理员权限，首先需要在 ZooKeeper 服务器上开启 Super 模式，方法是在 ZooKeeper 服务器启动的时候，添加如下系统属性：</p>
<blockquote>
<p>-Dzookeeper.DigestAuthenticationProvider.superDigest=foo:kWN6aNSbjcKWPqjiv7cgoN24raU=</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ZooKeeper/" rel="tag"># ZooKeeper</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9/" rel="tag"># 数据节点</a>
              <a href="/tags/Watcher/" rel="tag"># Watcher</a>
              <a href="/tags/ACL/" rel="tag"># ACL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/17/ZooKeeper-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E4%BC%9A%E8%AF%9D/" rel="prev" title="ZooKeeper 客户端与会话">
      <i class="fa fa-chevron-left"></i> ZooKeeper 客户端与会话
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/17/ZooKeeper-%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="next" title="ZooKeeper 通信协议">
      ZooKeeper 通信协议 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9"><span class="nav-number">1.</span> <span class="nav-text">数据节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">节点结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%89%B9%E6%80%A7"><span class="nav-number">1.2.</span> <span class="nav-text">节点特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%EF%BC%88%E4%BF%9D%E8%AF%81%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8E%9F%E5%AD%90%E6%80%A7%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">版本（保证分布式数据原子性操作）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Watcher%EF%BC%88%E6%95%B0%E6%8D%AE%E5%8F%98%E6%9B%B4%E7%9A%84%E9%80%9A%E7%9F%A5%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">Watcher（数据变更的通知）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E7%BB%84%E6%88%90"><span class="nav-number">2.1.</span> <span class="nav-text">参数组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-number">2.2.</span> <span class="nav-text">工作机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B3%A8%E5%86%8CWatcher"><span class="nav-number">2.2.1.</span> <span class="nav-text">客户端注册Watcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86Watcher"><span class="nav-number">2.2.2.</span> <span class="nav-text">服务端处理Watcher</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerCnxn%E5%AD%98%E5%82%A8"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">ServerCnxn存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Watcher%E8%A7%A6%E5%8F%91"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">Watcher触发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">过程总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9B%9E%E8%B0%83Watcher"><span class="nav-number">2.2.3.</span> <span class="nav-text">客户端回调Watcher</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SendThread%E6%8E%A5%E6%94%B6%E6%97%B6%E9%97%B4%E9%80%9A%E7%9F%A5"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">SendThread接收时间通知</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EventThread%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">EventThread处理事件通知</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%80%A7%E6%80%BB%E7%BB%93"><span class="nav-number">2.3.</span> <span class="nav-text">特性总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ACL%EF%BC%88%E4%BF%9D%E9%9A%9C%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%EF%BC%89"><span class="nav-number">3.</span> <span class="nav-text">ACL（保障数据安全）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.1.</span> <span class="nav-text">模式介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%A8%A1%E5%BC%8F%EF%BC%9AScheme"><span class="nav-number">3.1.1.</span> <span class="nav-text">权限模式：Scheme</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%A8%A1%E5%BC%8F%EF%BC%9APermission"><span class="nav-number">3.1.2.</span> <span class="nav-text">权限模式：Permission</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%89%A9%E5%B1%95%E4%BD%93%E7%B3%BB"><span class="nav-number">3.2.</span> <span class="nav-text">权限扩展体系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">3.2.1.</span> <span class="nav-text">实现自定义权限控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">3.2.2.</span> <span class="nav-text">注册自定义权限控制器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Super%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.3.</span> <span class="nav-text">Super模式</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Wang Zihao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">163</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">311</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Zihao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
