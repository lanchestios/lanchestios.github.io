<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="在 JUC 包中有许多支持 Executor 线程池执行的 Task，它们提供了：执行、回调、延时、定时、分治、流式调用等功能，为多线程的易用性、健壮性提供保证。">
<meta property="og:type" content="article">
<meta property="og:title" content="JUC Task任务">
<meta property="og:url" content="http://example.com/2021/03/30/JUC-Task/index.html">
<meta property="og:site_name" content="Lanchester Blog">
<meta property="og:description" content="在 JUC 包中有许多支持 Executor 线程池执行的 Task，它们提供了：执行、回调、延时、定时、分治、流式调用等功能，为多线程的易用性、健壮性提供保证。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/JDK/Task.png">
<meta property="og:image" content="http://example.com/images/JDK/FutureTask状态转换.png">
<meta property="article:published_time" content="2021-03-30T03:16:21.000Z">
<meta property="article:modified_time" content="2023-05-27T06:30:24.511Z">
<meta property="article:author" content="Wang Zihao">
<meta property="article:tag" content="JDK">
<meta property="article:tag" content="JUC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/JDK/Task.png">

<link rel="canonical" href="http://example.com/2021/03/30/JUC-Task/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>JUC Task任务 | Lanchester Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lanchester Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Leave a leaf</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/30/JUC-Task/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Wang Zihao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lanchester Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JUC Task任务
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-30 11:16:21" itemprop="dateCreated datePublished" datetime="2021-03-30T11:16:21+08:00">2021-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-27 14:30:24" itemprop="dateModified" datetime="2023-05-27T14:30:24+08:00">2023-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在 JUC 包中有许多支持 Executor 线程池执行的 Task，它们提供了：执行、回调、延时、定时、分治、流式调用等功能，为多线程的易用性、健壮性提供保证。 </p>
<span id="more"></span>
<p><img src="/images/JDK/Task.png" alt=""></p>
<h1 id="Task接口"><a href="#Task接口" class="headerlink" title="Task接口"></a>Task接口</h1><h2 id="Runnable-和-Callable"><a href="#Runnable-和-Callable" class="headerlink" title="Runnable 和 Callable"></a>Runnable 和 Callable</h2><p><strong>Runnable</strong></p>
<p>线程的执行单元，其并不返回执行结果，接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//在接口定义中 public abstract 关键字为默认可忽略</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Callable</strong></p>
<p>Callable 是一个支持泛型的接口，其在执行完毕后支持返回结果并且可能抛出异常。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h2><p>当需要获取线程的执行结果时，需要用到 Future。Callable 用于产生结果，Future 用于获取结果。Future 是一个接口。它用于表示异步计算的结果。提供了检查计算是否完成的方法，以等待计算的完成，并获取计算的结果。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public interface Future&lt;V&gt; &#123;

    boolean cancel(boolean mayInterruptIfRunning);

    boolean isCancelled();

    boolean isDone();

    V get();
    
    V get(long timeout, TimeUnit unit);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ThreadPoolExecutor-Task"><a href="#ThreadPoolExecutor-Task" class="headerlink" title="ThreadPoolExecutor Task"></a>ThreadPoolExecutor Task</h1><h2 id="RunnableFuture"><a href="#RunnableFuture" class="headerlink" title="RunnableFuture"></a>RunnableFuture</h2><p>RunnableFuture 合并了 Runnable 和 Future 这两个接口，</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Sets this Future to the result of its computation
     * unless it has been cancelled.
     */</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>我们可以看到 run 方法的定义完全就是多余的，我能想到它唯一的用途就是在 Javadoc 增加了新的注释。</p>
</blockquote>
<h2 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h2><p>FutureTask 实现了 RunnableFuture 接口，间接实现了 Runnable 接口和 Future 接口，所以 FutureTask 以一个适配器的形式将线程池需要实现的接口 ExecutorService 统一起来，而不是实现多个不同版本的方法。</p>
<p>另外，FutureTask 清晰的划分了任务执行的状态，方便调用后的逻辑处理。状态转换关系如下图。</p>
<p><img src="/images/JDK/FutureTask状态转换.png" style="zoom:80%;" /></p>
<p>在 FutureTask 被创建时，其状态被初始化为 New，其也被称之为初始态。New 表示新的任务或者还没被执行完的任务。除 New 之外，其他状态被分成两种类别，中间态和最终态。Completing 和 Interrupting 是中间态，Normal、Exceptional、Cancelled 和 Interrupted 为最终态。</p>
<ul>
<li>Completing（中间态）：任务执行完成或者执行任务时发生异常，此时任务执行结果或者异常原因还没有保存到 outcome 字段时任务所处的状态。</li>
<li>Normal（最终态）：任务执行完成并且任务执行结果保存到 outcome 字段，状态从 COMPLETING 转换到 NORMAL。</li>
<li>Exceptional（最终态）：任务执行异常并且异常原因保存到 outcome 字段中，状态从 COMPLETING 转换到 EXCEPTIONAL。</li>
<li>Cancel（最终态）：任务未开始执行或已经开始执行但是还没有执行完成时，用户调用了 cancel(false) 方法取消任务且不中断任务执行线程。状态从 NEW 转化为 CANCELLED 状态。</li>
<li>Interrupting（中间态）：任务未开始执行或已经执行但还未执行完成时，用户调用了 cancel(true) 方法取消任务并且要中断任务执行线程但是还没有中断任务执行线程之前，状态从 NEW 转化为 INTERRUPTING。</li>
<li>Interrupted（最终态）：调用 interrupt() 中断任务执行线程之后状态会从 INTERRUPTING 转换到 INTERRUPTED。</li>
</ul>
<p>需要注意的是，FutureTask 与 Runnable/Callable 的调用方式并不同（虽然看起来差不多）。FutureTask 主动封装了 Callable 中的 call 方法，并对其捕获了异常记录在 outcome 成员变量中。当然对于使用 <code>get()</code> 获得经过 <code>report()</code> 返回的数据，可以正常捕获异常。需要捕获异常可通过线程池的后处理模式 afterExecute 和线程的异常捕获机制 UncaughtExceptionHandler 两种方式。</p>
<h1 id="ScheduledThreadPoolExecutor-Task"><a href="#ScheduledThreadPoolExecutor-Task" class="headerlink" title="ScheduledThreadPoolExecutor Task"></a>ScheduledThreadPoolExecutor Task</h1><h2 id="RunnableScheduledFuture"><a href="#RunnableScheduledFuture" class="headerlink" title="RunnableScheduledFuture"></a>RunnableScheduledFuture</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Delayed</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Delayed</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Delayed</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">boolean</span> <span class="token function">isPeriodic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ScheduledFutureTask"><a href="#ScheduledFutureTask" class="headerlink" title="ScheduledFutureTask"></a>ScheduledFutureTask</h2><p>精华实现都体现在 ScheduledThreadPoolExecutor 中阻塞队列的实现，该 Task 只是提供基础的支持。</p>
<h1 id="ForkJoinPool-Task"><a href="#ForkJoinPool-Task" class="headerlink" title="ForkJoinPool Task"></a>ForkJoinPool Task</h1><p>ForkJoin 框架包含 ForkJoinTask、ForkJoinWorkerThread、ForkJoinPool 和若干 ForkJoinTask 的子类，它的核心在于分治和工作窍取，最大程度利用线程池中的工作线程。</p>
<h2 id="ForkJoinTask"><a href="#ForkJoinTask" class="headerlink" title="ForkJoinTask"></a>ForkJoinTask</h2><p>ForkJoinTask 可以理解为类线程但比线程轻量的实体，在 ForkJoinPool 中运行的少量 ForkJoinWorkerThread 可以持有大量的 ForkJoinTask 和它的子任务。ForkJoinTask 同时也是一个轻量的 Future，使用时应避免较长阻塞。</p>
<p>ForkJoinTask 实现了 future，也可以序列化，但它不是一个 Runnable 或 Callable。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="运行状态"><a href="#运行状态" class="headerlink" title="运行状态"></a>运行状态</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//volatie修饰的任务状态值,由ForkJoinPool或工作线程修改.</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span> 
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DONE_MASK   <span class="token operator">=</span> <span class="token number">0xf0000000</span><span class="token punctuation">;</span><span class="token comment">//用于屏蔽完成状态位. </span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NORMAL      <span class="token operator">=</span> <span class="token number">0xf0000000</span><span class="token punctuation">;</span><span class="token comment">//表示正常完成,是负值.</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CANCELLED   <span class="token operator">=</span> <span class="token number">0xc0000000</span><span class="token punctuation">;</span><span class="token comment">//表示被取消,负值,且小于NORMAL</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCEPTIONAL <span class="token operator">=</span> <span class="token number">0x80000000</span><span class="token punctuation">;</span><span class="token comment">//异常完成,负值,且小于CANCELLED</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIGNAL      <span class="token operator">=</span> <span class="token number">0x00010000</span><span class="token punctuation">;</span><span class="token comment">//用于signal,必须不小于1&lt;&lt;16,默认为1&lt;&lt;16.</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SMASK       <span class="token operator">=</span> <span class="token number">0x0000ffff</span><span class="token punctuation">;</span><span class="token comment">//后十六位的task标签</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="执行和异常处理"><a href="#执行和异常处理" class="headerlink" title="执行和异常处理"></a>执行和异常处理</h3><p><code>doExec()</code> 方法调用了留给子类实现的方法。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;&#x2F;final修饰,运行ForkJoinTask的核心方法.
final int doExec() &#123;
    int s; boolean completed;
    &#x2F;&#x2F;仅未完成的任务会运行,其他情况会忽略.
    if ((s &#x3D; status) &gt;&#x3D; 0) &#123;
        try &#123;
            &#x2F;&#x2F;调用exec，留给子类实现
            completed &#x3D; exec();
        &#125; catch (Throwable rex) &#123;
            &#x2F;&#x2F;发生异常,用setExceptionalCompletion设置结果
            return setExceptionalCompletion(rex);
        &#125;
        if (completed)
            &#x2F;&#x2F;正常完成,调用setCompletion,参数为normal,并将返回值作为结果s.
            s &#x3D; setCompletion(NORMAL);
    &#125;
    &#x2F;&#x2F;返回s
    return s;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>正常完成调用 setCompletion</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//标记当前task的completion状态,同时根据情况唤醒等待该task的线程.</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">setCompletion</span><span class="token punctuation">(</span><span class="token keyword">int</span> completion<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//开启一个循环,如果当前task的status已经是各种完成(小于0),则直接返回status,这个status可能是某一次循环前被其他线程完成.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> s<span class="token punctuation">;</span>
        <span class="token comment">//尝试将原来的status设置为它与completion按位或的结果.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> completion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">//此处体现了SIGNAL的标记作用,很明显,只要task完成(包含取消或异常),或completion传入的值不小于1&lt;&lt;16,</span>
                <span class="token comment">//就可以起到唤醒其他线程的作用.</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
            <span class="token comment">//cas成功,返回参数中的completion.</span>
            <span class="token keyword">return</span> completion<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>发生异常调用 setExceptionalCompletion</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//记录异常并且在符合条件时传播异常行为</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">setExceptionalCompletion</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//首先记录异常信息到结果</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">recordExceptionalCompletion</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&amp;</span> DONE_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> EXCEPTIONAL<span class="token punctuation">)</span>
        <span class="token comment">//status去除非完成态标志位(只保留前4位),等于EXCEPTIONAL.内部传播异常</span>
        <span class="token function">internalPropagateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//internalPropagateException方法是一个空方法,留给子类实现,可用于completer之间的异常传递</span>
<span class="token keyword">void</span> <span class="token function">internalPropagateException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">//记录异常完成</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">recordExceptionalCompletion</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//只能是异常态的status可以记录.</span>
        <span class="token comment">//hash值禁止重写,不使用子类的hashcode函数.</span>
        <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> exceptionTableLock<span class="token punctuation">;</span>
        <span class="token comment">//异常锁,加锁</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//抹除脏异常,后面叙述</span>
            <span class="token function">expungeStaleExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//异常表数组.ExceptionNode后面叙述.</span>
            <span class="token class-name">ExceptionNode</span><span class="token punctuation">[</span><span class="token punctuation">]</span> t <span class="token operator">=</span> exceptionTable<span class="token punctuation">;</span><span class="token comment">//exceptionTable是一个全局的静态常量,后面叙述</span>
            <span class="token comment">//用hash值和数组长度进行与运算求一个初始的索引</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> h <span class="token operator">&amp;</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExceptionNode</span> e <span class="token operator">=</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//找到空的索引位,就创建一个新的ExceptionNode,保存this,异常对象并退出循环</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    t<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ex<span class="token punctuation">,</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(1)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">//已设置在相同的索引位置的链表中,退出循环.//2</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">//否则e指向t[i]的next,进入下个循环,直到发现判断包装this这个ForkJoinTask的ExceptionNode已经出现在t[i]这个链表并break(2),</span>
            <span class="token comment">//或者直到e是null,意味着t[i]出发开始的链表并无包装this的ExceptionNode,则将构建一个新的ExceptionNode并置换t[i],</span>
            <span class="token comment">//将原t[i]置为它的next(1).整个遍历判断和置换过程处在锁中进行.</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//记录成功,将当前task设置为异常完成.</span>
        s <span class="token operator">=</span> <span class="token function">setCompletion</span><span class="token punctuation">(</span>EXCEPTIONAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//exceptionTable声明</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExceptionNode</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptionTable<span class="token punctuation">;</span><span class="token comment">//全局异常node表</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> exceptionTableLock<span class="token punctuation">;</span><span class="token comment">//上面用到的锁,就是一个普通的可重入锁.</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> exceptionTableRefQueue<span class="token punctuation">;</span><span class="token comment">//变量表引用队列,后面详述.</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCEPTION_MAP_CAPACITY <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token comment">//异常表的固定容量,不大,只有32而且是全局的.</span>

<span class="token comment">//初始化在一个静态代码块.</span>
<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
    exceptionTableLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exceptionTableRefQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exceptionTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionNode</span><span class="token punctuation">[</span>EXCEPTION_MAP_CAPACITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//容量</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">U</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> k <span class="token operator">=</span> <span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        STATUS <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span>objectFieldOffset
            <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//先来看ExceptionNode内部类的实现</span>
<span class="token comment">//签名,实现了一个ForkJoinTask的弱引用.</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionNode</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ForkJoinTask</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">;</span>
    <span class="token class-name">ExceptionNode</span> next<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> thrower<span class="token punctuation">;</span>  <span class="token comment">// use id not ref to avoid weak cycles</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> hashCode<span class="token punctuation">;</span>  <span class="token comment">// store task hashCode before weak ref disappears</span>
    <span class="token class-name">ExceptionNode</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> task<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">,</span> <span class="token class-name">ExceptionNode</span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> exceptionTableRefQueue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指向弱引用的构造函数,保存引用为task,队列为全局的exceptionTableRefQueue.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ex <span class="token operator">=</span> ex<span class="token punctuation">;</span><span class="token comment">//抛出的异常的引用</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span><span class="token comment">//数组中的ExceptionNode以链表形式存在,前面分析过,先入者为后入者的next</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thrower <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存抛出异常的线程id(严格来说是创建了this的线程)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hashCode <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//哈希码保存关联task的哈希值.</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//清除掉异常表中的脏数据,仅在持有全局锁时才可使用.前面看到在记录新的异常信息时要进行一次清除尝试</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">expungeStaleExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//循环条件,全局exceptionTableRefQueue队列不为空,前面说过ExceptionNode是弱引用,当它被回收时会被放入此队列.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> x<span class="token punctuation">;</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> exceptionTableRefQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//从队首依次取出元素.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionNode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//计算在全局exceptionTable中的索引.</span>
            <span class="token keyword">int</span> hashCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExceptionNode</span><span class="token punctuation">)</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>hashCode<span class="token punctuation">;</span>
            <span class="token class-name">ExceptionNode</span><span class="token punctuation">[</span><span class="token punctuation">]</span> t <span class="token operator">=</span> exceptionTable<span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> hashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取出node</span>
            <span class="token class-name">ExceptionNode</span> e <span class="token operator">=</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">ExceptionNode</span> pred <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">//不停遍历,直到e是null为止.</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//e的next</span>
                <span class="token class-name">ExceptionNode</span> next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span><span class="token comment">//2</span>
                <span class="token comment">//x是队首出队的元素.它与e相等说明找到</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//e是一个链表的元素,pred表示它是否有前置元素</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token comment">//无前置元素,说明e在链表首部,直接将首部元素指向next即可.</span>
                        t<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> next<span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token comment">//有前置元素,说明循环过若干次,将当前e出链表</span>
                        pred<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
                    <span class="token comment">//在链表中发现x即break掉内循环,继续从exceptionTableRefQueue的队首弹出新的元素.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">//只要发现当前e不是x,准备下一次循环,pred指向e.e指向next,进行下一个元素的比较.</span>
                pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                e <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>等待任务完成</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//内部等待任务完成,直到完成或超时.</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">internalWait</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token comment">//status小于0代表已完成,直接忽略wait.</span>
    <span class="token comment">//未完成,则试着加上SIGNAL的标记,令完成任务的线程唤醒这个等待.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> 
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//加锁,只有一个线程可以进入.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//再次判断未完成.等待timeout,且忽略扰动异常.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> <span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
                <span class="token comment">//已完成则响醒其他等待者.</span>
                <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时，它的使用方法目前只有一个 ForkJoinPool::awaitJoin，在该方法中使用循环的方式进行 internalWait，满足了每次按截止时间或周期进行等待，同时也顺便解决了虚假唤醒。</p>
<p>继续看 externalAwaitDone 函数，它体现了ForkJoin框架的一个核心：外部帮助。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//外部线程等待一个common池中的任务完成.</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span> <span class="token operator">?</span> 
    <span class="token comment">//当前task是一个CountedCompleter,尝试使用common ForkJoinPool去外部帮助完成,并将完成状态返回.</span>
             <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalHelpComplete</span><span class="token punctuation">(</span>
                 <span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
            <span class="token comment">//当前task不是CountedCompleter,则调用common pool尝试外部弹出该任务并进行执行,</span>
            <span class="token comment">//status赋值doExec函数的结果,若弹出失败(其他线程先行弹出)赋0.</span>
             <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//检查上一步的结果,即外部使用common池弹出并执行的结果(不是CountedCompleter的情况),或外部尝试帮助CountedCompleter完成的结果</span>
        <span class="token comment">//status大于0表示尝试帮助完成失败.</span>
        <span class="token comment">//扰动标识,初值false</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//循环尝试,先给status标记SIGNAL标识,便于后续唤醒操作.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token comment">//CAS成功,进同步块发现double check未完成,则等待.</span>
                            <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token comment">//若在等待过程中发生了扰动,不停止等待,标记扰动.</span>
                            interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">else</span>
                        <span class="token comment">//进同步块发现已完成,则唤醒所有等待线程.</span>
                        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//循环条件,task未完成.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
            <span class="token comment">//循环结束,若循环中间曾有扰动,则中断当前线程.</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//返回status</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>externalAwaitDone 的逻辑不复杂，在当前 task 为 ForkJoinPool.common 的情况下可以在外部进行等待和尝试帮助完成。方法会首先根据 ForkJoinTask 的类型进行尝试帮助，并返回当前的 status，若发现未完成，则进入下面的等待唤醒逻辑。该方法的调用者为非worker线程。</p>
<p>相似的方法：externalInterruptibleAwaitDone</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">externalInterruptibleAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
    <span class="token comment">//不同于externalAwaitDone,入口处发现当前线程已中断,则立即抛出中断异常.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">CountedCompleter</span><span class="token punctuation">)</span> <span class="token operator">?</span>
              <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalHelpComplete</span><span class="token punctuation">(</span>
                  <span class="token punctuation">(</span><span class="token class-name">CountedCompleter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span>
              <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">tryExternalUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
              <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STATUS<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token comment">//wait时也不catch中断异常,发生即抛出.</span>
                        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>externalInterruptibleAwaitDone 的逻辑与 externalAwaitDone 相似，只是对中断异常的态度为抛，后者为 catch。</p>
<p>它们的使用点，externalAwaitDone 为 doJoin 或 doInvoke 方法调用，externalInterruptibleAwaitDone 为 get 方法调用。很明显，join 操作不可扰动，get 则可以扰动。</p>
<p><strong>Get</strong></p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;&#x2F;get方法还有get(long time)的变种.
public final V get() throws InterruptedException, ExecutionException &#123;
    int s &#x3D; (Thread.currentThread() instanceof ForkJoinWorkerThread) ?
        &#x2F;&#x2F;当前线程是ForkJoinWorkerThread则调用前面提过的doJoin方法.
        &#x2F;&#x2F;否则调用前述externalInterruptibleAwaitDone
        doJoin() : externalInterruptibleAwaitDone();
    Throwable ex;
    if ((s &amp;&#x3D; DONE_MASK) &#x3D;&#x3D; CANCELLED)
        &#x2F;&#x2F;异常处理,取消的任务,抛出CancellationException.
        throw new CancellationException();
    if (s &#x3D;&#x3D; EXCEPTIONAL &amp;&amp; (ex &#x3D; getThrowableException()) !&#x3D; null)
        &#x2F;&#x2F;异常处理,调用getThrowableException获取异常,封进ExecutionException.
        throw new ExecutionException(ex);
    &#x2F;&#x2F;无异常处理,返回原始结果.
    return getRawResult();
&#125;
&#x2F;&#x2F;getRawResult默认为一个抽象实现,在ForkJoinTask中,并未保存该结果的字段.
 public abstract V getRawResult();

&#x2F;&#x2F;getThrowableException方法
private Throwable getThrowableException() &#123;
    &#x2F;&#x2F;不是异常标识,直接返回null,从方法名的字面意思看,要返回一个可抛出的异常.
    if ((status &amp; DONE_MASK) !&#x3D; EXCEPTIONAL)
        return null;
    &#x2F;&#x2F;系统哈希码来定位ExceptionNode
    int h &#x3D; System.identityHashCode(this);
    ExceptionNode e;
    final ReentrantLock lock &#x3D; exceptionTableLock;
    &#x2F;&#x2F;加异常表全局锁
    lock.lock();
    try &#123;
        &#x2F;&#x2F;先清理已被回收的异常node,前面已述.
        expungeStaleExceptions();
        ExceptionNode[] t &#x3D; exceptionTable;
        e &#x3D; t[h &amp; (t.length - 1)];
        &#x2F;&#x2F;循环找出this匹配的异常node
        while (e !&#x3D; null &amp;&amp; e.get() !&#x3D; this)
            e &#x3D; e.next;
    &#125; finally &#123;
        lock.unlock();
    &#125;
    Throwable ex;
    &#x2F;&#x2F;前面找不出异常node或异常node中存放的异常为null,则返回null
    if (e &#x3D;&#x3D; null || (ex &#x3D; e.ex) &#x3D;&#x3D; null)
        return null;
    if (e.thrower !&#x3D; Thread.currentThread().getId()) &#123;
        &#x2F;&#x2F;不是当前线程抛出的异常.
        Class&lt;? extends Throwable&gt; ec &#x3D; ex.getClass();
        try &#123;
            Constructor&lt;?&gt; noArgCtor &#x3D; null;&#x2F;&#x2F;该异常的无参构造器
            Constructor&lt;?&gt;[] cs &#x3D; ec.getConstructors();&#x2F;&#x2F;该异常类公有构造器
            for (int i &#x3D; 0; i &lt; cs.length; ++i) &#123;
                Constructor&lt;?&gt; c &#x3D; cs[i];
                Class&lt;?&gt;[] ps &#x3D; c.getParameterTypes();
                if (ps.length &#x3D;&#x3D; 0)
                    &#x2F;&#x2F;构建器参数列表长度0说明存在无参构造器,存放.
                    noArgCtor &#x3D; c;
                else if (ps.length &#x3D;&#x3D; 1 &amp;&amp; ps[0] &#x3D;&#x3D; Throwable.class) &#123;
                    &#x2F;&#x2F;发现有参构造器且参数长度1且第一个参数类型是Throwable,说明可以存放cause.
                    &#x2F;&#x2F;反射将前面取出的ex作为参数,反射调用该构造器创建一个要抛出的Throwable.
                    Throwable wx &#x3D; (Throwable)c.newInstance(ex);
                    &#x2F;&#x2F;反射失败,异常会被catch,返回ex,否则返回wx.
                    return (wx &#x3D;&#x3D; null) ? ex : wx;
                &#125;
            &#125;
            if (noArgCtor !&#x3D; null) &#123;
                &#x2F;&#x2F;在尝试了寻找有参无参构造器,并发现只存在无参构造器的情况,用无参构造器初始化异常.
                Throwable wx &#x3D; (Throwable)(noArgCtor.newInstance());
                if (wx !&#x3D; null) &#123;
                    &#x2F;&#x2F;将ex设置为它的cause并返回它的实例.
                    wx.initCause(ex);
                    return wx;
                &#125;
            &#125;
        &#125; catch (Exception ignore) &#123;
            &#x2F;&#x2F;此方法不可抛出异常,一定要成功返回.
        &#125;
    &#125;
    &#x2F;&#x2F;有参无参均未成功,返回找到的异常.
    return ex;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Join</strong></p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;&#x2F;join公有方法
public final V join() &#123;
    int s;
    if ((s &#x3D; doJoin() &amp; DONE_MASK) !&#x3D; NORMAL)
        &#x2F;&#x2F;调用doJoin方法阻塞等待的结果不是NORMAL,说明有异常或取消.报告异常.
        reportException(s);
    &#x2F;&#x2F;等于NORMAL,正常执行完毕,返回原始结果.
    return getRawResult();
&#125;

&#x2F;&#x2F;报告异常,可在前一步判断执行status是否为异常态,然后获取并重抛异常.
private void reportException(int s) &#123;
    &#x2F;&#x2F;参数s必须用DONE_MASK处理掉前4位以后的位.
    if (s &#x3D;&#x3D; CANCELLED)
        &#x2F;&#x2F;传入的状态码等于取消,抛出取消异常.
        throw new CancellationException();
    if (s &#x3D;&#x3D; EXCEPTIONAL)
        &#x2F;&#x2F;使用前面的getThrowableException方法获取异常并重新抛出.
        rethrow(getThrowableException());
&#125;

&#x2F;&#x2F;invoke公有方法.
public final V invoke() &#123;
    int s;
    &#x2F;&#x2F;先尝试执行
    if ((s &#x3D; doInvoke() &amp; DONE_MASK) !&#x3D; NORMAL)
        &#x2F;&#x2F;doInvoke方法的结果status只保留完成态位表示非NORMAL,则报告异常.
        reportException(s);
    &#x2F;&#x2F;正常完成,返回原始结果.
    return getRawResult();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>doJoin&amp;doInvoke</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//join的核心方法</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token class-name">Thread</span> t<span class="token punctuation">;</span> <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span> <span class="token class-name">ForkJoinPool<span class="token punctuation">.</span>WorkQueue</span> w<span class="token punctuation">;</span>
    <span class="token comment">//已完成,返回status,未完成再尝试后续</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> status<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> 
    <span class="token comment">//未完成,当前线程是ForkJoinWorkerThread</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//当前task出队然后执行,执行的结果是完成则返回状态</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w <span class="token operator">=</span> <span class="token punctuation">(</span>wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">tryUnpush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> s<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> 
            <span class="token comment">//否则使用当线程池所在的ForkJoinPool的awaitJoin方法等待.</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> wt<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">awaitJoin</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token comment">//当前线程不是ForkJoinWorkerThread,调用前面说的externalAwaitDone方法.</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span>  <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>   
<span class="token punctuation">&#125;</span>

<span class="token comment">//invoke的核心方法</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token class-name">Thread</span> t<span class="token punctuation">;</span> <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span>
    <span class="token comment">//先尝试本线程执行,不成功才走后续流程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">doExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">awaitJoin</span><span class="token punctuation">(</span>wt<span class="token punctuation">.</span>workQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">externalAwaitDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ForkJoinTask 是个抽象类，且它并未保存任务的完成结果，也不负责这个结果的处理，但声明并约束了返回结果的抽象方法 getRawResult 供子类实现。因此，ForkJoinTask 的自身关注任务的完成/异常/未完成，子类关注这个结果的处理。</p>
<p>每当获取到任务的执行状态时，ForkJoinTask 可根据 status 来判断是否是异常/正常完成，并进入相应的处理逻辑，最终使用子类实现的方法完成一个闭环。如果理解为将 ForkJoinTask 和子类的有关代码合并起来，在结果/完成状态/异常信息这一块，相当于同时有三个部分在合作。</p>
<ol>
<li><p>status：</p>
<p>它同时表示了未完成/正常完成/取消/异常完成等状态，也同时告诉有关等待线程是否要唤醒其他线程(每个线程等待前会设置SIGNAL)，同时留出了后面 16 位对付其他情况。</p>
</li>
<li><p>result：</p>
<p>在 ForkJoinTask 见不到它，也没有相应的字段，子类也未必需要提供这个 result 字段。CountedCompleter 就没有提供这个 result，它的 getRawResult 会固定返回 null。但是 CountedCompleter 可以继承子类并实现这个 result 的保存与返回。在 JAVA8 中，stream api 中的并行流也会保存每一步的计算结果，并对结果进行合并。</p>
</li>
<li><p>异常：</p>
<p>在 ForkJoinTask 中已经完成了所有异常处理流程和执行流程的定义，重点在于异常的存放，它是由 ForkJoinTask 的类变量进行存放的，结构为数组+链表，且元素利用了弱引用，借 gc 帮助清除掉已经被回收的 ExceptionNode，显然在 gc 之前必须得到使用。而异常随时可以发生并进行 record 入列，但相应的能消费掉这个异常的只有相应的外部的<code>get</code>、<code>join</code>、<code>invoke</code> 等方法或者内部扩展了 <code>exec()</code> 等方式，得到其他线程执行的 task 异常结果的情况。巧妙的是，只有外部调用者调用（<code>get</code>、<code>invoke</code>、<code>join</code>）时，这个异常信息才足够重要，需要 rethrow 出去并保存关键的堆栈信息；而内部线程在访问一些非自身执行的任务时，往往只需要 status 判断是否异常即可，在 <code>exec()</code> 中 fork 新任务的，也往往必须立即 join 这些新的子任务，这就保证了能够及时得到子任务中的异常堆栈（即使拿不到堆栈也知道它失败了）。</p>
</li>
</ol>
<h3 id="Task的运行过程"><a href="#Task的运行过程" class="headerlink" title="Task的运行过程"></a>Task的运行过程</h3><p>Task 可由三种方式启动</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>     
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">externalPush</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> task<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   
    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>        
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">externalPush</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//Fork方法，将当前任务入池.</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span> t<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>
        <span class="token comment">//如果当前线程是ForkJoinWorkerThread,将任务压入该线程的任务队列.</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>workQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">//否则调用common池的externalPush方法入队.</span>
        <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token function">externalPush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对一个task，先 <code>fork()</code> 压队，再 <code>join()</code> 等待执行结果，这是一个 ForkJoinTask 的执行周期闭环（但不要简单理解为生命周期，前面提到过，任务可以被重新初始化，而且重新初始化时还会清空 ExceptionNode 数组上的已回收成员）。</p>
<h2 id="CountedCompleter"><a href="#CountedCompleter" class="headerlink" title="CountedCompleter"></a>CountedCompleter</h2><h2 id="RecursiveAction"><a href="#RecursiveAction" class="headerlink" title="RecursiveAction"></a>RecursiveAction</h2><h2 id="RecursiveTask"><a href="#RecursiveTask" class="headerlink" title="RecursiveTask"></a>RecursiveTask</h2><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public class Main &#123;

    public static void main(String[] args) &#123;
        &#x2F;&#x2F;创建ForkJoinPool
        ForkJoinPool pool &#x3D; new ForkJoinPool();
        &#x2F;&#x2F;异步提交RecursiveTask任务
        ForkJoinTask&lt;Integer&gt; forkJoinTask &#x3D; pool.submit(new CalculatedRecursiveTask(0, 10));
        try &#123;
            &#x2F;&#x2F;根据返回类型获取返回值
            Integer result &#x3D; forkJoinTask.get();
            System.out.println(&quot;结果为：&quot; + result);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    private static class CalculatedRecursiveTask extends RecursiveTask&lt;Integer&gt; &#123;
        private int start;
        private int end;

        public CalculatedRecursiveTask(int start, int end) &#123;
            this.start &#x3D; start;
            this.end &#x3D; end;
        &#125;

        @Override
        protected Integer compute() &#123;
            &#x2F;&#x2F;判断计算范围，如果小于等于5，那么一个线程计算就够了，否则进行分割
            if ((end - start) &lt;&#x3D; 5) &#123;
                return IntStream.rangeClosed(start, end).sum();
            &#125; else &#123;
                &#x2F;&#x2F;任务分割
                int middle &#x3D; (end + start) &#x2F; 2;
                CalculatedRecursiveTask task1 &#x3D; new CalculatedRecursiveTask(start, middle);
                CalculatedRecursiveTask task2 &#x3D; new CalculatedRecursiveTask(middle + 1, end);
                &#x2F;&#x2F;执行
                task1.fork();
                task2.fork();
                &#x2F;&#x2F;等待返回结果
                return task1.join() + task2.join();
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h1><h2 id="CompletionStage"><a href="#CompletionStage" class="headerlink" title="CompletionStage"></a>CompletionStage</h2><p>CompletionStage 表示一个可能异步运行的“阶段”，在该阶段内要执行相应的行为，而这些运算会在另一个 CompletionStage 完成后开始，它自身完成后又可触发另一个依赖的 CompletionStage。CompletionStage 只是一个接口定义。</p>
<p><strong>方法宏观横向分类</strong></p>
<ul>
<li><p>Consumer（消费型）</p>
<p>  用上一个阶段的结果作为指定函数的参数执行函数产生新的结果。这一类接口方法名中基本都有 appl y字样，接口的参数是 (Bi)Function 类型。</p>
</li>
<li><p>Function（函数型）</p>
<p>  用上一个阶段的结果作为指定操作的参数执行指定的操作，但不对阶段结果产生影响。这一类接口方法名中基本都有 accept 字样，接口的参数就是 (Bi)Consumer 类型。</p>
</li>
<li><p>Runnable（接续型）</p>
<p>  不依据上一个阶段的执行结果，只要上一个阶段完成（但一般要求正常完成），就执行指定的操作，且不对阶段的结果产生影响。这一类接口方法名中基本都有 run 字样，接口的参数是 Runnable 类型。</p>
</li>
<li><p>Compose（组合型）</p>
<p>  它以依赖阶段本身作为参数而不是阶段产生的结果进行产出型（或函数型）操作。</p>
</li>
</ul>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>CompletableFuture 实现了 CompletableStage 和 Future 的所有接口，这意味着它即满足 CompletableStage 的阶段执行，也提供了 Future 中获取该执行结果的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> 
  <span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其执行可大概概括为以下三个部分：Create（创建）、Process Control（过程控制）、Exception Handle（异常处理）。</p>
<h3 id="Create-阶段"><a href="#Create-阶段" class="headerlink" title="Create 阶段"></a>Create 阶段</h3><h4 id="有返回值的调用链"><a href="#有返回值的调用链" class="headerlink" title="有返回值的调用链"></a>有返回值的调用链</h4><p><strong>静态生成（completedFuture）</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token class-name">U</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>Lambda Supplier生成（supplyAsync）</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> supplier<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>也可以当作 Callable 的特性使用。</p>
<h4 id="执行后生成调用链"><a href="#执行后生成调用链" class="headerlink" title="执行后生成调用链"></a>执行后生成调用链</h4><p><strong>执行无返回值异步任务（runAsync）</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="聚合后生成调用链"><a href="#聚合后生成调用链" class="headerlink" title="聚合后生成调用链"></a>聚合后生成调用链</h4><p><strong>全部 CompletableFuture 执行完成后 Trigger（allOf）</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">allOf</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cfs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>任一 CompletableFuture 执行完成后，返回其返回值（anyOf）</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cfs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Process-Control-阶段"><a href="#Process-Control-阶段" class="headerlink" title="Process Control 阶段"></a>Process Control 阶段</h3><p>因为几乎都是对一些关键字的组合，因此在这里介绍关键字的含义。</p>
<h4 id="阶段性依赖"><a href="#阶段性依赖" class="headerlink" title="阶段性依赖"></a>阶段性依赖</h4><ul>
<li>then 方法，在上一个 future 执行完成后触发。</li>
<li>combine/both 方法，完成指定的两个 future 后触发。</li>
<li>either 方法，完成指定的两个 future 中任一个触发。</li>
</ul>
<h4 id="状态性依赖"><a href="#状态性依赖" class="headerlink" title="状态性依赖"></a>状态性依赖</h4><p>依赖任务执行返回的状态。</p>
<ul>
<li>whenComplete 方法是 Consumer 型接口，接收计算结果或异常并进行进一步处理。</li>
<li>handle 方法是 Function 类接口，接收计算结果或异常并进行进一步处理。</li>
<li>exceptionally 方法可以在上一个阶段以异常完成时进行处理，它可以根据上一个阶段的异常产出新的结果，使该结果可以由其他相关阶段继续进一步处理。</li>
</ul>
<h4 id="异步状态标识"><a href="#异步状态标识" class="headerlink" title="异步状态标识"></a>异步状态标识</h4><ul>
<li>Async 方法会在指定线程池进行任务的执行</li>
<li>non-Async 方法会在当前线程进行任务的执行</li>
</ul>
<h4 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h4><ul>
<li>Apply 方法：Function 型方法</li>
<li>Accept 方法：Consumer 型方法</li>
<li>Run 方法：执行 Runnable 方法</li>
<li>Compose 方法：将上一个 Future 的执行结果作为参数</li>
</ul>
<h3 id="Exception-Handle-阶段"><a href="#Exception-Handle-阶段" class="headerlink" title="Exception Handle 阶段"></a>Exception Handle 阶段</h3><p>handle 方法能同时接受执行结果和异常信息，在 BiFunction 进行处理。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">></span></span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">handleAsync</span><span class="token punctuation">(</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">></span></span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">handleAsync</span><span class="token punctuation">(</span>
	<span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">></span></span> fn<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>exceptionally 方法可以在上一个阶段以异常完成时进行处理，它可以根据上一个阶段的异常产出新的 CompletableFuture。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Completion"><a href="#Completion" class="headerlink" title="Completion"></a>Completion</h2><p>整个调用过程通过调用链的方式实现，并将调用方式分成了四种调用方式：</p>
<ul>
<li>zero-input source actions</li>
<li>single-input source actions（UniCompletion）</li>
<li>two-input source actions<ul>
<li>projected（BiCompletion used by either (not both) of two inputs）</li>
<li>shared（CoCompletion used by the second of two sources）</li>
</ul>
</li>
</ul>
<ul>
<li>Signallers（Signallers is unblock waiters）</li>
</ul>
<p>Completion 继承了 ForkJoinTask 支持异步执行，并且利用 ForkJoinTask Tag 并没有增加开销。</p>
<p>具体继承关系如下：</p>
<ul>
<li>ForkJoinTask<code>&lt;V&gt;</code><ul>
<li>Completion<ul>
<li>CoCompletion</li>
<li>Signaller</li>
<li>UniCompletion<code>&lt;T, V&gt;</code><ul>
<li>BiCompletion<code>&lt;T, U, V&gt;</code><ul>
<li>BiAccept、BiApply、BiRelay、BiRun</li>
<li>OrAccept、OrApply、OrRelay、OrRun</li>
</ul>
</li>
<li>UniAccept<code>&lt;T&gt;</code>、UniApply<code>&lt;T, V&gt;</code>、UniRelay<code>&lt;T&gt;</code>、UniRun<code>&lt;T&gt;</code></li>
<li>UniCompose<code>&lt;T, V&gt;</code></li>
<li>UniExceptionally<code>&lt;T&gt;</code></li>
<li>UniHandle<code>&lt;T, V&gt;</code></li>
<li>UniWhenComplete<code>&lt;T&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>下面挑几个来进行讲解，由于 Completion 流程使用了策略模式，所以大概流程基本相似。</p>
<h3 id="UniCompletion-调用逻辑"><a href="#UniCompletion-调用逻辑" class="headerlink" title="UniCompletion 调用逻辑"></a>UniCompletion 调用逻辑</h3><p>以 thenApply（对前一任务有依赖性）为例</p>
<p><strong>1. 解除外观模式</strong></p>
<p>将为了方便调用的外观模式 thenApply、thenApplyAsync，聚合为更集中的 Apply 操作：uniApplyStage。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">thenApply</span><span class="token punctuation">(</span>
    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">></span></span> fn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">uniApplyStage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">></span></span> fn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">uniApplyStage</span><span class="token punctuation">(</span>asyncPool<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">></span></span> <span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">></span></span> fn<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">uniApplyStage</span><span class="token punctuation">(</span><span class="token function">screenExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>2. 将同步异步分离</strong></p>
<p>需要清楚的是，无论是同步还是异步，所做的操作都是相同的，只不过由不同的线程执行而已。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">uniApplyStage</span><span class="token punctuation">(</span>
    <span class="token class-name">Executor</span> e<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//参数合法性校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> d <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//同步异步分离，妙用基础语法</span>
    <span class="token comment">//1. 存在线程池时，直接执行 if 语法块内逻辑</span>
    <span class="token comment">//2. 不存在线程池时，执行 !d.uniApply(this, f, null)，即同步逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>d<span class="token punctuation">.</span><span class="token function">uniApply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UniApply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UniApply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//对于Completion操作来说，push有三种：push、bipush、orpush</span>
        <span class="token comment">//push Pushes the given completion (if it exists) unless done.</span>
        <span class="token comment">//bipush Pushes completion to this and b unless both done.</span>
        <span class="token comment">//orpush Pushes completion to this and b unless either done.</span>
        <span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span><span class="token function">tryFire</span><span class="token punctuation">(</span>SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>3. 异步执行逻辑</strong></p>
<p>首先创建 UniApply 任务，根据 UniApply &gt; UniCompletion &gt; Completion 的继承关系，创建一个 Completion 操作。再压到 stack 中，尝试以同步的方式触发一下。</p>
<p><strong>3.1 压栈操作</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">UniCompletion</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//以 CAS 方式尝试入栈</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">tryPushStack</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//在 CAS 失败后，清除 c.next 的引用</span>
            <span class="token function">lazySetNext</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear on failure</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryPushStack</span><span class="token punctuation">(</span><span class="token class-name">Completion</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Completion</span> h <span class="token operator">=</span> stack<span class="token punctuation">;</span>
    <span class="token comment">//将当前 Completion 的 next 设置为栈顶</span>
    <span class="token function">lazySetNext</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//CAS替换栈顶，成功返回true，失败返回false</span>
    <span class="token keyword">return</span> UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> STACK<span class="token punctuation">,</span> h<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们需要注意的是，压栈操作是进行了反向压栈。举个例子：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">命令的执行：
A -> B -> C
(A) -> A1 -> A2 -> A3 -> A4
(B) -> B1 -> B2 -> B3 -> B4
(C) -> C1 -> C2 -> C3 -> C4

压栈顺序：
C -> B -> A
(A) -> A4 -> A3 -> A2 -> A1
(B) -> B4 -> B3 -> B2 -> B1
(C) -> C4 -> C3 -> C2 -> C1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为这种压栈机制，所以并不是依赖栈的顺序执行任务，而是直接在 Future 中定义了 depenence 和 source 维护相关的调用依赖关系。但要避免过深的递归调用，我们还需要将树形逆向的压栈方式修改为正向链式的方式，由 PostCompletion 解决这个问题。因此我们可将调用顺序理解为：在任务可直接执行时直接调用；否则等重排序好进行顺序传播触发。</p>
<p>反向压栈有问题吗？答案是没有。因为栈中的每一个 Completion 在执行上互不影响，它们的顺序只影响到 cleanStack 和 postComplete 的处理顺序。CompletableFuture 和它的栈元素产生的 CompletableFuture 彼此间有顺序要求，但对同一个 CompletableFuture 的栈内的 Completion 元素彼此间没有顺序要求，决定他们顺序的是对源 CompletionFuture 调用 orApply，thenApply 等等方法的顺序，后续运行也完全独立。只不过在源 CompletableFuture 进行 postComplete 时，执行的顺序将会与原本的”先来先出“相反。</p>
<p><strong>3.2 尝试触发</strong></p>
<p>tryFire 函数是在 UniApply 中实现的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UniApply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">UniCompletion</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> fn<span class="token punctuation">;</span>
    <span class="token class-name">UniApply</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> dep<span class="token punctuation">,</span>
             <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> src<span class="token punctuation">,</span>
             <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> fn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> dep<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> d<span class="token punctuation">;</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> a<span class="token punctuation">;</span>
        <span class="token comment">//dependence 为空，说明已经调用过了</span>
        <span class="token comment">//如果是异步模式(mode = 1),就不判断任务是否结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">=</span> dep<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token operator">!</span>d<span class="token punctuation">.</span><span class="token function">uniApply</span><span class="token punctuation">(</span>a <span class="token operator">=</span> src<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> mode <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//摘除引用</span>
        dep <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> src <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> fn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//触发后处理</span>
        <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">postFire</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//绑定一个依赖源</span>
<span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">postFire</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//当前future不为空且stack不为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>stack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//NESTED = -1（以嵌套的方式调用tryFire）或 result = null（src的任务未执行完毕）</span>
        <span class="token comment">//才会 cleanStack</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> a<span class="token punctuation">.</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            a<span class="token punctuation">.</span><span class="token function">cleanStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清理 Stack 直到有结果产生</span>
        <span class="token comment">//否则将所有元素出栈并执行存活元素</span>
        <span class="token keyword">else</span>
            a<span class="token punctuation">.</span><span class="token function">postComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> stack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">postComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//清除Stack中执行完毕的节点(node=null)</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">cleanStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Completion</span> p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> q <span class="token operator">=</span> stack<span class="token punctuation">;</span> q <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//遍历Stack</span>
        <span class="token class-name">Completion</span> s <span class="token operator">=</span> q<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment">//q是Live状态，跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            p <span class="token operator">=</span> q<span class="token punctuation">;</span>
            q <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//q不是Live状态，将stack中对q的引用摘除掉</span>
        <span class="token comment">//此时分为两种情况：</span>
        <span class="token comment">//1. p本身就是过期的节点时(=null)，直接将下一节点设为栈顶</span>
        <span class="token comment">//2. p不为null时摘掉q引用即可</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//说明p节点本身就是执行过的节点</span>
            <span class="token function">casStack</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            q <span class="token operator">=</span> stack<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            p<span class="token punctuation">.</span>next <span class="token operator">=</span> s<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//再次判断p结点是否还或者(在这期间是否有别的线程改动了)</span>
                q <span class="token operator">=</span> s<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                p <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment">//restart</span>
                q <span class="token operator">=</span> stack<span class="token punctuation">;</span> 
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//将树形的调用链调整为链式调用链, 在每次任务创建初和任务执行后反复进行触发</span>
<span class="token comment">//解决了轮询和阻塞带来的对性能方面的影响</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">postComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> f <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token class-name">Completion</span> h<span class="token punctuation">;</span>
    
    <span class="token comment">//当f的stack为空时，使f重新指向当前的CompletableFuture，继续后面的结点</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> f<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
           <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">this</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> d<span class="token punctuation">;</span> <span class="token class-name">Completion</span> t<span class="token punctuation">;</span>
        <span class="token comment">//从头遍历stack</span>
        <span class="token comment">//将栈顶的下一个元素设置为栈顶，将旧栈顶弹出</span>
        <span class="token comment">//此时新栈顶为t，旧栈顶为h</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">casStack</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> t <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果栈顶不为空且栈顶不是当前future，压入栈---该行为是将树形的调用链调整为链式调用链</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">pushStack</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//继续下一个节点</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">//如果是当前CompletableFuture, 解除头节点与栈的联系</span>
                h<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//调用头节点的tryFire()方法，该方法可看作Completion的钩子方法，执行完逻辑后，</span>
            <span class="token comment">//会向后传播的   </span>
            f <span class="token operator">=</span> <span class="token punctuation">(</span>d <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">tryFire</span><span class="token punctuation">(</span>NESTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> d<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>3.3 逻辑执行</strong></p>
<p>对于不同的 Completion 来说，异同都主要集中在这一步操作。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token keyword">boolean</span> <span class="token function">uniApply</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> a<span class="token punctuation">,</span>
                           <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">S</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> f<span class="token punctuation">,</span>
                           <span class="token class-name">UniApply</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> r<span class="token punctuation">;</span> <span class="token class-name">Throwable</span> x<span class="token punctuation">;</span>
    <span class="token comment">//只有上一个任务执行完才会触发下面的逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> a<span class="token punctuation">.</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//设置result或者throwable</span>
    tryComplete<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token keyword">instanceof</span> <span class="token class-name">AltResult</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AltResult</span><span class="token punctuation">)</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span>ex<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">completeThrowable</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span> tryComplete<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            r <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> <span class="token class-name">S</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">)</span> r<span class="token punctuation">;</span>
            <span class="token comment">//这里不同的实现可能不同，有些不需要返回值的会被直接设置成 null</span>
            <span class="token function">completeValue</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">completeThrowable</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//主要异步调用逻辑</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Executor</span> e <span class="token operator">=</span> executor<span class="token punctuation">;</span>
    <span class="token comment">//如果当前任务可以被执行，返回true，否则，返回false; 保证任务只被执行一次</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetForkJoinTaskTag</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        executor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// disable</span>
        e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="BiCompletion-调用逻辑"><a href="#BiCompletion-调用逻辑" class="headerlink" title="BiCompletion 调用逻辑"></a>BiCompletion 调用逻辑</h3><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">final void bipush(CompletableFuture&lt;?&gt; b, BiCompletion&lt;?,?,?&gt; c) &#123;
    if (c !&#x3D; null) &#123;
        Object r;
        &#x2F;&#x2F;a的result还没准备好，c压入栈
        while ((r &#x3D; result) &#x3D;&#x3D; null &amp;&amp; !tryPushStack(c))
            lazySetNext(c, null); &#x2F;&#x2F; clear on failure
        &#x2F;&#x2F;b的result也还没准备好 
        if (b !&#x3D; null &amp;&amp; b !&#x3D; this &amp;&amp; b.result &#x3D;&#x3D; null) &#123;
            &#x2F;&#x2F;根据a的result决定是否构建CoCompletion       
            &#x2F;&#x2F;如果a未结束，则构建一个CoCompletion   
            &#x2F;&#x2F;CoCompletion最后调用的也是BiCompletion的tryFire    
            Completion q &#x3D; (r !&#x3D; null) ? c : new CoCompletion(c);
            while (b.result &#x3D;&#x3D; null &amp;&amp; !b.tryPushStack(q))
                lazySetNext(q, null); &#x2F;&#x2F; clear on failure
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="CoCompletion-调用逻辑"><a href="#CoCompletion-调用逻辑" class="headerlink" title="CoCompletion 调用逻辑"></a>CoCompletion 调用逻辑</h3><p>以 applyToEither（对前一任务有依赖性）为例。</p>
<p>与 UniCompletion 基本相同，区别在于 orpush 和 BiCompletion。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">final void orpush(CompletableFuture&lt;?&gt; b, BiCompletion&lt;?, ?, ?&gt; c) &#123;   
    if (c !&#x3D; null) &#123;     
        &#x2F;&#x2F; a和b的result都没好，才会考虑入栈        
        while ((b &#x3D;&#x3D; null || b.result &#x3D;&#x3D; null) &amp;&amp; result &#x3D;&#x3D; null) &#123;    
            if (tryPushStack(c)) &#123; &#x2F;&#x2F; 先入a的栈      
                &#x2F;&#x2F; 入a的栈成功，b的result还没好       
                if (b !&#x3D; null &amp;&amp; b !&#x3D; this &amp;&amp; b.result &#x3D;&#x3D; null) &#123;      
                    Completion q &#x3D; new CoCompletion(c); &#x2F;&#x2F; a还未结束，用c构建CoCompletion     
                    &#x2F;&#x2F; 再次判断，a和b的result都没好，才会考虑入栈    
                    while (result &#x3D;&#x3D; null &amp;&amp; b.result &#x3D;&#x3D; null &amp;&amp; !b.tryPushStack(q))    
                        lazySetNext(q, null); &#x2F;&#x2F; 失败置空q的next域    
                &#125;                     
                break;          
            &#125;                 
            lazySetNext(c, null); &#x2F;&#x2F; 失败置空c的next域          
        &#125;       
    &#125;   
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">static final class OrApply&lt;T,U extends T,V&gt; extends BiCompletion&lt;T,U,V&gt; &#123;
    Function&lt;? super T,? extends V&gt; fn;
    OrApply(Executor executor, CompletableFuture&lt;V&gt; dep,
            CompletableFuture&lt;T&gt; src,
            CompletableFuture&lt;U&gt; snd,
            Function&lt;? super T,? extends V&gt; fn) &#123;
        super(executor, dep, src, snd); this.fn &#x3D; fn;
    &#125;
    final CompletableFuture&lt;V&gt; tryFire(int mode) &#123;
        CompletableFuture&lt;V&gt; d;
        CompletableFuture&lt;T&gt; a;
        CompletableFuture&lt;U&gt; b;
        if ((d &#x3D; dep) &#x3D;&#x3D; null ||
            !d.orApply(a &#x3D; src, b &#x3D; snd, fn, mode &gt; 0 ? null : this))
            return null;
        dep &#x3D; null; src &#x3D; null; snd &#x3D; null; fn &#x3D; null;
        return d.postFire(a, b, mode);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Signaller-调用逻辑"><a href="#Signaller-调用逻辑" class="headerlink" title="Signaller 调用逻辑"></a>Signaller 调用逻辑</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> r<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">reportGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">waitingGet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">:</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> r<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">reportJoin</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">waitingGet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">:</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>get</code> 和 <code>join</code> 方法都会在获取不到结果是按条件轮循 watingGet 方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">waitingGet</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> interruptible<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Signaller</span> q <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//信号器</span>
    <span class="token keyword">boolean</span> queued <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//是否入队</span>
    <span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//自旋次数</span>
    <span class="token class-name">Object</span> r<span class="token punctuation">;</span><span class="token comment">//结果引用</span>
    <span class="token comment">//循环条件是只等待result，内部有根据扰动决定的break</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//自旋次数只有第一次进来是负值，后续只能是0或其他正数。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">//自旋次数，多处理器下初始化为16，否则为0，即不自旋。设置值后此次循环结束。</span>
            spins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//第二次循环时才会判断自旋次数。只要spins大于0就继续循环，直到达到0为止再执行下面的else代码。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//仅当下一个种子数不小于0时，减小一次自旋次数。nextSecondarySeed是Thread类中使用@Contended注解标识的变量，</span>
            <span class="token comment">//这与传说中的伪共享有关。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">--</span>spins<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//停止自旋后的第一轮循环，result依旧是null，则对q进行初始化，关于Signaller后续再讲。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signaller</span><span class="token punctuation">(</span>interruptible<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化q后的下一轮循环（停止自旋后的第二轮），queued是false，将上一轮循环初始化的q压入栈。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued<span class="token punctuation">)</span>
            queued <span class="token operator">=</span> <span class="token function">tryPushStack</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//停止自旋后的若干次循环（上一步可能压栈失败，则下一轮自旋会再次压栈，直到成功）后，判断是否可扰动。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span>interruptControl <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//扰动信号匹配，将q的有关字段全部置空，顺带清一下栈，返回null。</span>
            q<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">//这个清栈的过程，细看上面的解释还有有关的源码，可能会发出一个疑问，cleanStack只能清除isLive判断false的Completion，</span>
            <span class="token comment">//但目前的实现，基本上都只能在dep为null，base为null等仅当dep执行完成的情况发生，而dep完成的情况是当前CompletableFuture的</span>
            <span class="token comment">//result不是null，而方法运行到此，很明显result必然是null，那么还有必要清栈吗？</span>
            <span class="token comment">//答案是必要的，首先将来也许能出现存活或死亡状态与source的result无关的Completion，那么此处清一下栈也是帮助后面的工作。</span>
            <span class="token comment">//其次，刚才压入栈的q在thread指向null时即已死亡，它也必须要进行清除。</span>
            <span class="token function">cleanStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//q关联的线程存在，即q存活，且依旧没有执行完毕，使用ForkJoinPool的阻塞管理机制，q的策略进行阻塞。</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span><span class="token function">managedBlock</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//阻塞是可以扰动的，此时会将q的扰动控制信号设置为-1，则下一次循环时将可能进入上一个else if。</span>
                q<span class="token punctuation">.</span>interruptControl <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//前面的循环没有break，能执行到此，只有result获得非null值的情况。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//若q不是null，说明没有在自旋阶段获取到result，需要对它进行禁用。</span>
        q<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>interruptControl <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible<span class="token punctuation">)</span>
                <span class="token comment">//可扰动且有扰动信号，则说明扰动后未能进入上面带有cleanStack的那个else if，</span>
                <span class="token comment">//可能是恰好在这次循环开始时获取到了非空result，从而退出循环，也可能是参数interruptible为假，</span>
                <span class="token comment">//在外部扰动了当前线程后，依旧等到了result。</span>
                <span class="token comment">//只要发生了扰动，就将结果置null，外面调用者如果是join，可以报出扰动。</span>
                r <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// report interruption</span>
            <span class="token keyword">else</span>
                <span class="token comment">//如果不可扰动，则中断当前线程（创建q的线程）。</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//当前future已经有结果，进行postComplete逻辑并返回r。</span>
    <span class="token function">postComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据该方法的注释，waitingGet方法只会有两个结果，null（可扰动并且扰动了）和原始的 result。而 get 方法可扰动，也即可返回 null，join 方法不可扰动，只能等待结束或抛出异常。</p>
<p>waitingGet 方法中出现了 Signaller。Signaller 是一个 Completion 的直接子类，同时实现了 ForkJoinPool 的内部接口 ManagedBlocker，这使得它可以在当 ForkJoinPool 出现大量线程阻塞堆积时避免饥饿。Signaller 的作用是持有和释放一个线程，并提供相应的阻塞策略。前面提到的 waitingGet 方法创建了一个 <code>Signaller(interruptible, 0L, 0L)</code>，类似的，可以看到 timedGet 方法使用 <code>Signaller(true, nanos, d == 0L ? 1L : d)</code> 来进行阻塞的管理，管理的方法依赖 ForkJoinPool 内部的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Signaller</span> <span class="token keyword">extends</span> <span class="token class-name">Completion</span>
    <span class="token keyword">implements</span> <span class="token class-name">ForkJoinPool<span class="token punctuation">.</span>ManagedBlocker</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> nanos<span class="token punctuation">;</span>                    <span class="token comment">// 计时的情况下，要等待的时间。</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> deadline<span class="token punctuation">;</span>           <span class="token comment">// 计时的情况下指定不为0的值</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> interruptControl<span class="token punctuation">;</span> <span class="token comment">// 大于0代表可扰动，小于0代表已扰动。</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span><span class="token comment">//持有的线程</span>
 
    <span class="token class-name">Signaller</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> interruptible<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">,</span> <span class="token keyword">long</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>interruptControl <span class="token operator">=</span> interruptible <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//不可扰动，赋0</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nanos <span class="token operator">=</span> nanos<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deadline <span class="token operator">=</span> deadline<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token keyword">int</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ignore无用</span>
        <span class="token class-name">Thread</span> w<span class="token punctuation">;</span> <span class="token comment">//Signaller自持有创建者线程，tryFire只是单纯唤醒创建它的线程。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w <span class="token operator">=</span> thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//释放引用</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解除停顿。</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//返回null，当action已执行并进行postComlete调用时，f依旧指向当前CompletableFuture引用并解除停顿。</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//线程是空，允许释放。这可能是某一次调用本方法或tryFire方法造成。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果调用isReleasable方法的线程被扰动了，则置扰动信号为-1</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> interruptControl<span class="token punctuation">;</span>
            interruptControl <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">//原扰动信号是”可扰动“，则是本次调用置为”已扰动“，返回true。</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//未定时（deadline是0）的情况只能在上面释放，定时的情况，本次计算nanos(deadline-System.nanoTime())</span>
        <span class="token comment">//或上次计算的nanos不大于0时，说明可以释放。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">!=</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> <span class="token number">0L</span> <span class="token operator">||</span> <span class="token punctuation">(</span>nanos <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//只要可释放，将创建者线程的引用释放。下次调用直接返回true，线程运行结束销毁后可被gc回收。</span>
            thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//仍持有创建者线程，调用此方法的线程未扰动或当前扰动不是第一次，未定时或不满足定时设置的一律返回false。</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//block方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//判断可释放，直接return true。</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//判断deadline是0，说明不计时，默认park。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span>
            <span class="token comment">//计时情况，park指定nanos。</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//睡醒后再次返回isReleasable的结果。</span>
        <span class="token keyword">return</span> <span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//创建者线程引用被释放即代表死亡。</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ForkJoinPool.managedBlock(q) 来实现，而这用到了被 Signaller 实现的 ForkJoinPool.ManagedBlocker。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//ForkJoinPool的managedBlock方法。</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">managedBlock</span><span class="token punctuation">(</span><span class="token class-name">ManagedBlocker</span> blocker<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ForkJoinPool</span> p<span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用此方法的线程，即前面的Signaller的创建者线程。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span>wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>pool<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//调用managedBlock方法的线程是ForkJoinWorkerThread，则它可运行在ForkJoinPool中。此处要求内部持有pool的引用。</span>
        <span class="token class-name">WorkQueue</span> w <span class="token operator">=</span> wt<span class="token punctuation">.</span>workQueue<span class="token punctuation">;</span>
        <span class="token comment">//循环，只要判断blocker(即Signaller）不可释放。</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>blocker<span class="token punctuation">.</span><span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//尝试用ForkJoinPool对当前线程的工作队列进行补偿。</span>
            <span class="token comment">//tryCompensate方法会尝试减少活跃数并可能创建或释放一个准备阻塞的worker线程，</span>
            <span class="token comment">//它会在发生竞态，脏数据，松弛或池终止时返回false。</span>
            <span class="token comment">//关于ForkJoinPool的详情单独准备文章。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">tryCompensate</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                 
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//补偿成功，不停地对线程池尝试先isReleasable再block，任何一个方法返回true则终止循环。</span>
                    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>blocker<span class="token punctuation">.</span><span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                 <span class="token operator">!</span>blocker<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//出现任何异常，或循环终止时，控制信号加上一个活跃数单元，因为前面通过补偿才会进入循环，已减少了一个单元。</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getAndAddLong</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> CTL<span class="token punctuation">,</span> AC_UNIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//当前线程不是ForkJoinWorkerThread或不持有ForkJoinPool的引用。连续先尝试isReleasable再尝试block，直到有一者返回true为止。</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>blocker<span class="token punctuation">.</span><span class="token function">isReleasable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token operator">!</span>blocker<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="特别说明：allOf-amp-anyOf"><a href="#特别说明：allOf-amp-anyOf" class="headerlink" title="特别说明：allOf &amp; anyOf"></a>特别说明：allOf &amp; anyOf</h3><p>allOf 和 anyOf 使用分治法来解决对任务完成的结果进行触发的功能。</p>
<h4 id="allOf"><a href="#allOf" class="headerlink" title="allOf"></a>allOf</h4><p>allOf 方法，当所有 cfs 列表中的成员进入完成态后完成（使用空结果），或有任何一个列表成员异常完成时完成（使用同一个异常）。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">allOf</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cfs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">andTree</span><span class="token punctuation">(</span>cfs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cfs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">andTree</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> cfs<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> lo<span class="token punctuation">,</span> <span class="token keyword">int</span> hi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//声明一个后续返回的dep</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lo <span class="token operator">></span> hi<span class="token punctuation">)</span> <span class="token comment">// empty</span>
        d<span class="token punctuation">.</span>result <span class="token operator">=</span> NIL<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
        <span class="token comment">//二分分治</span>
        <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>lo <span class="token operator">+</span> hi<span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token punctuation">(</span>lo <span class="token operator">==</span> mid <span class="token operator">?</span> cfs<span class="token punctuation">[</span>lo<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token comment">//只剩两个元素时，a作为偏左元素</span>
                                        <span class="token comment">//否则继续进行数组左部分元素拆分</span>
                  <span class="token function">andTree</span><span class="token punctuation">(</span>cfs<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token punctuation">(</span>lo <span class="token operator">==</span> hi <span class="token operator">?</span> a <span class="token operator">:</span> <span class="token punctuation">(</span>hi <span class="token operator">==</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> cfs<span class="token punctuation">[</span>hi<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token comment">//如果只剩下一个值，b=a</span>
                  <span class="token function">andTree</span><span class="token punctuation">(</span>cfs<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> hi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">//只剩两个元素时，b作为偏右元素</span>
                                                      <span class="token comment">//否则继续进行数组右部分拆分</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>d<span class="token punctuation">.</span><span class="token function">biRelay</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             <span class="token comment">//不满足完成条件，生成一个中继并压栈，再次尝试同步完成。若不满足条件，ab任何一个完成后都会再间接调用它的tryFire。</span>
            <span class="token class-name">BiRelay</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BiRelay</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span><span class="token function">bipush</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span><span class="token function">tryFire</span><span class="token punctuation">(</span>SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="anyOf"><a href="#anyOf" class="headerlink" title="anyOf"></a>anyOf</h4><p>anyOf方法，返回一个 CompletableFuture 对象，任何一个 cfs 列表中的成员进入完成态（正常完成或异常），则它也一并完成，结果一致。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public static CompletableFuture&lt;Object&gt; anyOf(CompletableFuture&lt;?&gt;... cfs) &#123;
    &#x2F;&#x2F;直接调用orTree
    return orTree(cfs, 0, cfs.length - 1);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其与 allOf 的区别主要在后面 push 的处理逻辑上，一个是接收两者，一个是接收其一，它们本质是分治法拆分的子任务。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JDK/" rel="tag"># JDK</a>
              <a href="/tags/JUC/" rel="tag"># JUC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/29/JDK-%E7%BD%91%E7%BB%9CIO%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94/" rel="prev" title="JDK 网络IO方式对比">
      <i class="fa fa-chevron-left"></i> JDK 网络IO方式对比
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/30/JUC-ThreadPool/" rel="next" title="JUC ThreadPool">
      JUC ThreadPool <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Task%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.</span> <span class="nav-text">Task接口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Runnable-%E5%92%8C-Callable"><span class="nav-number">1.1.</span> <span class="nav-text">Runnable 和 Callable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Future"><span class="nav-number">1.2.</span> <span class="nav-text">Future</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ThreadPoolExecutor-Task"><span class="nav-number">2.</span> <span class="nav-text">ThreadPoolExecutor Task</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RunnableFuture"><span class="nav-number">2.1.</span> <span class="nav-text">RunnableFuture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FutureTask"><span class="nav-number">2.2.</span> <span class="nav-text">FutureTask</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ScheduledThreadPoolExecutor-Task"><span class="nav-number">3.</span> <span class="nav-text">ScheduledThreadPoolExecutor Task</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RunnableScheduledFuture"><span class="nav-number">3.1.</span> <span class="nav-text">RunnableScheduledFuture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ScheduledFutureTask"><span class="nav-number">3.2.</span> <span class="nav-text">ScheduledFutureTask</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ForkJoinPool-Task"><span class="nav-number">4.</span> <span class="nav-text">ForkJoinPool Task</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ForkJoinTask"><span class="nav-number">4.1.</span> <span class="nav-text">ForkJoinTask</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="nav-number">4.1.1.</span> <span class="nav-text">运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%92%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">4.1.2.</span> <span class="nav-text">执行和异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Task%E7%9A%84%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">4.1.3.</span> <span class="nav-text">Task的运行过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CountedCompleter"><span class="nav-number">4.2.</span> <span class="nav-text">CountedCompleter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RecursiveAction"><span class="nav-number">4.3.</span> <span class="nav-text">RecursiveAction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RecursiveTask"><span class="nav-number">4.4.</span> <span class="nav-text">RecursiveTask</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CompletableFuture"><span class="nav-number">5.</span> <span class="nav-text">CompletableFuture</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CompletionStage"><span class="nav-number">5.1.</span> <span class="nav-text">CompletionStage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Usage"><span class="nav-number">5.2.</span> <span class="nav-text">Usage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-%E9%98%B6%E6%AE%B5"><span class="nav-number">5.2.1.</span> <span class="nav-text">Create 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E8%BF%94%E5%9B%9E%E5%80%BC%E7%9A%84%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">有返回值的调用链</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%90%8E%E7%94%9F%E6%88%90%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">执行后生成调用链</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%90%8E%E7%94%9F%E6%88%90%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-number">5.2.1.3.</span> <span class="nav-text">聚合后生成调用链</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Process-Control-%E9%98%B6%E6%AE%B5"><span class="nav-number">5.2.2.</span> <span class="nav-text">Process Control 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E6%80%A7%E4%BE%9D%E8%B5%96"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">阶段性依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%80%A7%E4%BE%9D%E8%B5%96"><span class="nav-number">5.2.2.2.</span> <span class="nav-text">状态性依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E6%A0%87%E8%AF%86"><span class="nav-number">5.2.2.3.</span> <span class="nav-text">异步状态标识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">5.2.2.4.</span> <span class="nav-text">操作流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exception-Handle-%E9%98%B6%E6%AE%B5"><span class="nav-number">5.2.3.</span> <span class="nav-text">Exception Handle 阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Completion"><span class="nav-number">5.3.</span> <span class="nav-text">Completion</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UniCompletion-%E8%B0%83%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-number">5.3.1.</span> <span class="nav-text">UniCompletion 调用逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BiCompletion-%E8%B0%83%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-number">5.3.2.</span> <span class="nav-text">BiCompletion 调用逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CoCompletion-%E8%B0%83%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-number">5.3.3.</span> <span class="nav-text">CoCompletion 调用逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Signaller-%E8%B0%83%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-number">5.3.4.</span> <span class="nav-text">Signaller 调用逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%88%AB%E8%AF%B4%E6%98%8E%EF%BC%9AallOf-amp-anyOf"><span class="nav-number">5.3.5.</span> <span class="nav-text">特别说明：allOf &amp; anyOf</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#allOf"><span class="nav-number">5.3.5.1.</span> <span class="nav-text">allOf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#anyOf"><span class="nav-number">5.3.5.2.</span> <span class="nav-text">anyOf</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Wang Zihao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">291</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Zihao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
