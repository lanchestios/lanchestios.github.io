<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="主要介绍了 ZooKeeper 的部署、客户端脚本的使用以及开发人员使用的原生客户端 API 以及 Curator 封装的更易用的客户端 API。">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper API清单及使用方法">
<meta property="og:url" content="http://example.com/2021/03/04/ZooKeeper-API%E6%B8%85%E5%8D%95%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/index.html">
<meta property="og:site_name" content="Lanchester Blog">
<meta property="og:description" content="主要介绍了 ZooKeeper 的部署、客户端脚本的使用以及开发人员使用的原生客户端 API 以及 Curator 封装的更易用的客户端 API。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Zookeeper构造函数参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeepercreate方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/processResult方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeeperdelete方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeepergetChildren方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeepergetData方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeepersetData方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeeperexistsAPI方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/ZooKeeperaddAuthInfo方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/Nodecache构造方法参数说明.png">
<meta property="og:image" content="http://example.com/images/ZooKeeper/PathChildrenCache构造方法参数说明.png">
<meta property="article:published_time" content="2021-03-04T03:46:04.000Z">
<meta property="article:modified_time" content="2023-02-06T06:39:42.624Z">
<meta property="article:author" content="Wang Zihao">
<meta property="article:tag" content="zkServer">
<meta property="article:tag" content="zkClient">
<meta property="article:tag" content="Curator">
<meta property="article:tag" content="ZooKeeper">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/ZooKeeper/Zookeeper构造函数参数说明.png">

<link rel="canonical" href="http://example.com/2021/03/04/ZooKeeper-API%E6%B8%85%E5%8D%95%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ZooKeeper API清单及使用方法 | Lanchester Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lanchester Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Leave a leaf</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/ZooKeeper-API%E6%B8%85%E5%8D%95%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Wang Zihao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lanchester Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ZooKeeper API清单及使用方法
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 11:46:04" itemprop="dateCreated datePublished" datetime="2021-03-04T11:46:04+08:00">2021-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-06 14:39:42" itemprop="dateModified" datetime="2023-02-06T14:39:42+08:00">2023-02-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index"><span itemprop="name">ZooKeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>主要介绍了 ZooKeeper 的部署、客户端脚本的使用以及开发人员使用的原生客户端 API 以及 Curator 封装的更易用的客户端 API。</p>
<span id="more"></span>
<h1 id="客户端脚本"><a href="#客户端脚本" class="headerlink" title="客户端脚本"></a>客户端脚本</h1><h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sh zkCli.sh</code></td>
<td>默认连接 localhost:2181</td>
</tr>
<tr>
<td><code>sh zkCli.sh -server ip:port</code></td>
<td>连接指定 zk 服务器</td>
</tr>
</tbody>
</table>
</div>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>create [-s] [-e] path data acl</code></td>
<td>创建一个 zk 节点，不添加<code>[-s][-e]</code>参数默认为持久节点，<code>[-s]</code>为顺序节点，<code>[-e]</code>为临时节点</td>
</tr>
</tbody>
</table>
</div>
<h2 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h2><div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ls path [watch]</code></td>
<td>列出 ZooKeeper 指定节点下的所有子节点</td>
</tr>
<tr>
<td><code>get path [watch]</code></td>
<td>获取 ZooKeeper 指定节点的数据内容和属性信息</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>第一次部署的 ZooKeeper 集群，默认在根节点<code>/</code>下面有一个叫作<code>/zookeeper</code>的保留节点。</p>
</blockquote>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>set path data [version]</code></td>
<td>更新指定节点的数据内容</td>
</tr>
</tbody>
</table>
</div>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>delete path [version]</code></td>
<td>删除指定节点</td>
</tr>
</tbody>
</table>
</div>
<h1 id="原生客户端API"><a href="#原生客户端API" class="headerlink" title="原生客户端API"></a>原生客户端API</h1><p>ZooKeeper 作为一个分布式服务框架，主要用来解决分布式数据一致性问题，它提供了简单的分布式原语，并且对多种编程语言提供了 API。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;zookeeper.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建会话"><a href="#创建会话" class="headerlink" title="创建会话"></a>创建会话</h2><p>客户端可以通过创建一个 ZooKeeper（<code>org.apache.zookeeper.ZooKeeper</code>）实例来连接 ZooKeeper 服务器。ZooKeeper 的 4 种构造方法如下。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public ZooKeeper(
        String connectString,
        int sessionTimeout,
        Watcher watcher,
        boolean canBeReadOnly
);
public ZooKeeper(
        String connectString,
        int sessionTimeout,
        Watcher watcher,
        long sessionId,
        byte[] sessionPasswd
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用任意一个构造方法都可以顺利完成与 ZooKeeper 服务器的会话（Session）创建。</p>
<p><img src="/images/ZooKeeper/Zookeeper构造函数参数说明.png" alt=""></p>
<blockquote>
<p>注意：</p>
<p>ZooKeeper 客户端和服务端会话的建立是一个异步的过程，也就是说在程序中，构造方法会在处理完客户端初始化工作后立即返回，在大多数情况下，此时并没有真正建立好一个可用的会话，在会话的生命周期中处于“CONNECTION”的状态。</p>
<p>当该会话真正创建完毕后，ZooKeeper 服务端会向会话对应的客户端发送一个事件通知，以告知客户端，客户端只有在获取这个通知之后，才算真正建立了会话。</p>
<p>构造方法内部实现了与 ZooKeeper 服务器之间的 TCP 连接创建，负责维护客户端会话的生命周期。</p>
</blockquote>
<p><strong>创建一个最基本的 Zookeeper 会话实例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CountDownLatch</span> cdl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive watched event: "</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span> <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                cdl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cdl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Zookeeper session established."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h2><p>客户端可以通过 ZooKeeper 的 API 来创建一个数据节点，有如下两个接口</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;&#x2F;同步创建节点
public String create(
        final String path,
        byte[] data,
        List&lt;ACL&gt; acl,
        CreateMode createMode);
&#x2F;&#x2F;异步创建节点
public void create(
        final String path,
        byte[] data,
        List&lt;ACL&gt; acl,
        CreateMode createMode,
        StringCallback cb,
        Object ctx);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeepercreate方法参数说明.png" alt=""></p>
<p>需要注意几点，无论是同步还是异步接口，ZooKeeper 都不支持递归创建，即无法在父节点不存在的情况下创建一个子节点。另外，如果一个节点已经存在了，那么创建同名节点的时候，会抛出 NodeExistsException 异常。</p>
<p>目前，ZooKeeper 的节点内容只支持<code>byte[]</code>类型，也就是说，ZooKeeper 不负责为节点内容进行序列化，开发人员需要自己使用序列化工具将节点内容进行序列化和反序列化。对于字符串，可以简单地使用<code>String.getBytes()</code>来生成一个字节数组；对于其他复杂对象，可以使用专门的序列化工具来进行序列化。</p>
<p>关于权限控制，如果你的应用场景没有太高的权限要求，那么可以不关注这个参数，只需要在 acl 参数中传入参数<code>Ids.OPEN_ACL_UNSAFE</code>，这就表明之后对这个节点的任何操作都不受权限控制。</p>
<p><strong>使用同步API创建一个节点</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CountDownLatch</span> cdl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive watched event: "</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span> <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                cdl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cdl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Zookeeper session established."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> path1 <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"zk-test-ephemeral-"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span>
            <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Success create znode: "</span> <span class="token operator">+</span> path1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> path2 <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"zk-test-ephemeral-"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span>
            <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Success create znode: "</span> <span class="token operator">+</span> path2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Receive watched event: WatchedEvent state:SyncConnected type:None path:null</span>
<span class="token comment">//Zookeeper session established.</span>
<span class="token comment">//Success create znode: /zk-test-ephemeral-</span>
<span class="token comment">//Success create znode: /zk-test-ephemeral-0000000002</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>临时顺序节点（EPHEMERAL_SEQUENTIAL）会比临时节点（EPHEMERAL）在创建时，节点后缀多加一个数字。</p>
</blockquote>
<p><strong>使用异步API创建一个节点</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CountDownLatch</span> cdl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive watched event: "</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span> <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                cdl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cdl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Zookeeper session established."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/zk-test-ephemera-"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span>
            <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">IStringCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"I am context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/zk-test-ephemera-"</span><span class="token punctuation">,</span>
            <span class="token string">"data"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span>
            <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">IStringCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"ctx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">IStringCallback</span> <span class="token keyword">implements</span> <span class="token class-name">AsyncCallback<span class="token punctuation">.</span>StringCallback</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> rc<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Create path result：["</span> <span class="token operator">+</span> rc <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">", "</span>
                <span class="token operator">+</span> ctx <span class="token operator">+</span> <span class="token string">", real path name："</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AsyncCallback 包含 StatCallback、DataCallback、ACLCallback、ChildrenCallback、Children2Callback、StringCallback 和 VoidCallback 七种不同的回调接口，用户可以在不同的异步接口中实现不同的接口。</p>
<p>和同步接口方法最大的区别在于，节点的创建过程（包括网络通信和服务端的节点创建过程）是异步的。并且，在同步接口调用过程中，我们需要关注接口抛出异常的可能；但是在异步接口中，接口本身是不会抛出异常的，所有的异常都会在回调函数中通过 Result Code（响应码）来体现。</p>
<p>processResult方法参数说明</p>
<p><img src="/images/ZooKeeper/processResult方法参数说明.png" alt=""></p>
<h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><p>客户端可以通过 ZooKeeper 的 API 来删除一个节点，有如下两个接口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token class-name">VoidCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeeperdelete方法参数说明.png" alt=""></p>
<p>需要注意的是，在 Zookeeper 中，只允许删除叶子节点。也就是说，如果一个节点存在至少一个子节点的话，那么该节点将无法被直接删除，必须先删除掉其所有子节点。</p>
<h2 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h2><p>读取数据，包括子节点列表的获取和节点数据的获取。ZooKeeper 分别提供了不同的 API 来获取数据。</p>
<h3 id="getChildren"><a href="#getChildren" class="headerlink" title="getChildren"></a>getChildren</h3><p>客户端可以通过 ZooKeeper 的 API 来获取一个节点的所有子节点，有如下8个接口可供使用：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public List&lt;String&gt; getChildren(final String path, Watcher watcher);
public List&lt;String&gt; getChildren(String path, boolean watch);
public void getChildren(final String path, Watcher watcher, ChildrenCallback cb, Object ctx);
public void getChildren(String path, boolean watch, ChildrenCallback cb, Object ctx);
public List&lt;String&gt; getChildren(final String path, Watcher watcher, Stat stat);
public List&lt;String&gt; getChildren(String path, boolean watch, Stat stat);
public void getChildren(final String path, Watcher watcher, Children2Callback cb, Object ctx);
public void getChildren(String path, boolean watch, Children2Callback cb, Object ctx);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeepergetChildren方法参数说明.png" alt=""></p>
<p>关于 Watcher，这里简单提一点，ZooKeeper 服务端在向客户端发送 Watcher “Node Children Changed” 事件通知的时候，仅仅只会发出一个通知，而不会把节点的变化情况发送给客户端，需要客户端自己重新获取。另外，由于 Watcher 通知是一次性的，即一旦触发一次通知后，该 Watcher 就失效了，因此客户端需要反复注册 Watcher。</p>
<h3 id="getData"><a href="#getData" class="headerlink" title="getData"></a>getData</h3><p>客户端可以通过 ZooKeeper 的 API 来获取一个节点的数据内容，有如下 4 个接口：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public byte[] getData(final String path, Watcher watcher, Stat stat);
public byte[] getData(String path, boolean watch, Stat stat);
public void getData(final String path, Watcher watcher, DataCallback cb, Object ctx);
public void getData(String path, boolean watch, DataCallback cb, Object ctx);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeepergetData方法参数说明.png" alt=""></p>
<h2 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h2><p>客户端可以通过 ZooKeeper 的 APl 来更新一个节点的数据内容，有如下两个接口：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public Stat setData(final String path, byte[] data, int version);
public void setData(final String path, byte[] data, int version, StatCallback cb, Object ctx)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeepersetData方法参数说明.png" alt=""></p>
<p>version 参数用于指定节点的数据版本，表明本次更新操作是针对指定的数据版本进行的。但是，上面提到的读取数据的接口 getData 中，并没有提供根据指定数据版本来获取数据的接口，那么，这里指定数据版本更新的意义何在呢？</p>
<p>这与 CAS 的原理有关，通俗地讲，CAS 的意思就是：“对于值 V，每次更新前都会比对其值是否是预期值 A，只有符合预期，才会将 V 原子化地更新到新值 B。”。ZooKeeper 的 setData 接口中的 version 参数正是由 CAS 原理衍化而来的。ZooKeeper 每个节点都有数据版本的概念，在调用更新操作的时候，就可以添加 version 这个参数，该参数可以对应于 CAS 原理中的“预期值”，表明是针对该数据版本进行更新的。具体来说，假如一个客户端试图进行更新操作，它会携带上次获取到的 version 值进行更新。而如果在这段时间内，ZooKeeper 服务器上该节点的数据恰好已经被其他客户端更新了，那么其数据版本一定也发生了变化，因此肯定与客户端携带的 version 无法匹配，于是便无法更新成功——因此可以有效地避免些分布式更新的并发问题，ZooKeeper 的客户端就可以利用该特性构建更复杂的应用场景，例如分布式锁服务等。</p>
<blockquote>
<p>版本号如果传入 -1，说明客户端需要基于数据的最新版本进行更新操作。</p>
<p>每次更新都会将版本号增一。</p>
</blockquote>
<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><p>客户端可以通过 ZooKeeper 的 APl 来删除一个节点的数据内容，有如下两个接口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token class-name">VoidCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="检测节点是否存在"><a href="#检测节点是否存在" class="headerlink" title="检测节点是否存在"></a>检测节点是否存在</h2><p>客户端可以通过 ZooKeeper 的 API 来检测节点是否存在，有如下 4 个接口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">Stat</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> watch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">Watcher</span> watcher<span class="token punctuation">,</span> <span class="token class-name">StatCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> watch<span class="token punctuation">,</span> <span class="token class-name">StatCallback</span> cb<span class="token punctuation">,</span> <span class="token class-name">Object</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeeperexistsAPI方法参数说明.png" alt=""></p>
<blockquote>
<p>exists 接口特性</p>
<ul>
<li>无论指定节点是否存在，通过调用 exists 接口都可以注册 Watcher。</li>
<li>exists 接口中注册的 Watcher，能够对节点创建、节点删除和节点数据更新事件进行监听。</li>
<li>对于指定节点的子节点的各种变化，都不会通知客户端</li>
</ul>
</blockquote>
<h2 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h2><p>在 ZooKeeper 的实际使用中，我们的做法往往是搭建一个共用的 ZooKeeper 集群，统一为若干个应用提供服务。在这种情况下，不同的应用之间往往是不会存在共享数据的使用场景的，因此需要解决不同应用之间的权限问题。</p>
<p>为了避免存储在 ZooKeeper 服务器上的数据被其他进程干扰或人为操作修改，需要对 ZooKeeper 上的数据访问进行权限控制（Access Control）。ZooKeeper 提供了 ACL 的权限控制机制，简单的讲，就是通过设置 ZooKeeper 服务器上数据节点的 ACL，来控制客户端对该数据节点的访问权限：如果一个客户端符合该 ACL 控制，那么就可以对其进行访问，否则将无法操作。</p>
<p>开发人员如果要使用 ZooKeeper 的权限控制功能，需要在完成 ZooKeeper 会话创建后，给该会话添加上相关的权限信息（AuthInfo）。ZooKeeper 客户端提供了相应的 API 接口来进行权限信息的设置，如下：</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">addAuthInfo(String scheme, byte[] auth);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/ZooKeeperaddAuthInfo方法参数说明.png" alt=""></p>
<p><strong>使用包含权限信息的ZooKeeper会话创建数据节点</strong></p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public static void main(String[] args) throws Exception &#123;
    ZooKeeper zooKeeper &#x3D; new ZooKeeper(&quot;127.0.0.1:2181&quot;, 50000, null);

    zooKeeper.addAuthInfo(&quot;digest&quot;, &quot;foo:true&quot;.getBytes());

    zooKeeper.create(&quot;&#x2F;zk-test-ephemera&quot;,
                     &quot;init&quot;.getBytes(),
                     ZooDefs.Ids.CREATOR_ALL_ACL,
                     CreateMode.EPHEMERAL);

    Thread.sleep(Integer.MAX_VALUE);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>使用无权限信息的ZooKeeper会话访问含权限信息的数据节点</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    zooKeeper<span class="token punctuation">.</span><span class="token function">addAuthInfo</span><span class="token punctuation">(</span><span class="token string">"digest"</span><span class="token punctuation">,</span> <span class="token string">"foo:true"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/zk-test-ephemera"</span><span class="token punctuation">,</span>
                     <span class="token string">"init"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>CREATOR_ALL_ACL<span class="token punctuation">,</span>
                     <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ZooKeeper</span> zooKeeper2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        zooKeeper2.addAuthInfo("digest", "foo:true".getBytes());</span>
    zooKeeper2<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/zk-test-ephemera"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>不包含权限信息的客户端会话对其进行访问会输出相关异常信息：<br>KeeperErrorCode = NoAuth for /zk-test-ephemera</p>
</blockquote>
<p><strong>删除节点接口的权限控制</strong></p>
<p>删除节点接口的权限控制比较特殊，当客户端对一个数据节点添加了权限信息后，对于删除操作而言，其作用范围是其子节点。也就是说，当我们对一个数据节点添加权限信息后，依然可以自由地删除这个节点，但是对于这个节点的子节点，就必须使用相应的权限信息才能够删除它。</p>
<h1 id="Curator客户端API"><a href="#Curator客户端API" class="headerlink" title="Curator客户端API"></a>Curator客户端API</h1><p>Curator 是 Netflix 公司开源的一套 ZooKeeper 客户端框架，作者是 Jordan Zimmerman。和 ZkClient 一样，Curator 解决了很多 ZooKeeper 客户端非常底层的细节开发工作，包括连接重连、反复注册 Watcher 和 NodeExistsException 异常等，目前已经成为了 Apache 的顶级项目，是全世界范围内使用最广泛的 ZooKeeper 客户端之一，Patrick Hunt（ZooKeeper 代码的核心提交者）以一句 Guava is to Java what Curator is to ZooKeeper 对其进行了高度评价。</p>
<p>除了封装一些开发人员不需要特别关注的底层细节之外，Curator 还在 ZooKeeper 原生 API 的基础上进行了包装，提供了一套易用性和可读性更强的 Fluent 风格的客户端 API 框架。</p>
<p>除此之外，Curator 中还提供了 ZooKeeper 各种应用场景（Recipe，如共享锁服务、Master 选举机制和分布式计数器等）的抽象封装。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建会话-1"><a href="#创建会话-1" class="headerlink" title="创建会话"></a>创建会话</h2><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">CuratorFramework client &#x3D; CuratorFrameworkFactory.builder()
                .connectString(&quot;127.0.0.1:2181&quot;)
                .retryPolicy(new ExponentialBackoffRetry(1000, 3))
                &#x2F;&#x2F;隔离命名空间
                .namespace(&quot;base&quot;)
                .build();
client.start();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th>重试策略</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ExponentialBackoffRetry</td>
<td>指数增长间隔型重试</td>
</tr>
<tr>
<td>RetryNTimes</td>
<td>重试多次</td>
</tr>
<tr>
<td>RetryOneTime</td>
<td>重试一次</td>
</tr>
<tr>
<td>RetryUntilElapsed</td>
<td>超时重试</td>
</tr>
</tbody>
</table>
</div>
<p>也可以通过实现 RetryPolicy 接口的方式自定义重试策略</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RetryPolicy</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Called when an operation has failed for some reason. This method should return
     * true to make another attempt.
     *
     *
     * @param retryCount the number of times retried so far (0 the first time)
     * @param elapsedTimeMs the elapsed time in ms since the operation was attempted
     * @param sleeper use this to sleep - DO NOT call Thread.sleep
     * @return true/false
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span>      <span class="token function">allowRetry</span><span class="token punctuation">(</span><span class="token keyword">int</span> retryCount<span class="token punctuation">,</span> <span class="token keyword">long</span> elapsedTimeMs<span class="token punctuation">,</span> <span class="token class-name">RetrySleeper</span> sleeper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建节点-1"><a href="#创建节点-1" class="headerlink" title="创建节点"></a>创建节点</h2><p>在 Curator 中，可以通过以下 API 来创建节点：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">CuratorFramework
-- CreateBuilder create();
CreateBuilder
-- ProtectACLCreateModePathAndBytesable&lt;String> creatingParentsIfNeeded();
-- ACLPathAndBytesable&lt;String>              withProtectedEphemeralSequential();
-- ACLCreateModeBackgroundPathAndBytesable&lt;String>    withProtection();
CreateModable
-- T withMode(CreateMode mode);
PathAndBytesable
-- T forPath(String path, byte[] data);
-- T forPath(String path);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下是适用场景及示例</p>
<ol>
<li><p>创建一个节点，初始内容为空</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.create().forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 注意，如果没有设置节点属性，那么 Curator 默认创建的是持久节点，内容默认是空。这里的 client 是指上文中提到的一个已经完成会话创建并启动的 Curator 客户端实例，即 CuratorFramework 对象实例。</p>
</li>
<li><p>创建一个节点，附带初始内容</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.create().forPath(path, &quot;init&quot;.getBytes());<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 也可以在创建节点的时候写入初始节点内容。和 ZkClient 不同的是，Curator 仍然是按照 ZooKeeper 原生 API 的风格，使用<code>byte[]</code>作为方法参数。</p>
</li>
<li><p>创建一个临时节点，初始内容为空</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.create().withMode(CreateMode.EPHEMERAL).forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建一个临时节点，并自动递归创建父节点</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 这个接口非常有用，在使用 ZooKeeper 的过程中，开发人员经常会碰到 NoNodeException 异常，其中一个可能的原因就是试图对一个不存在的父节点创建子节点。因此，开发人员不得不在每次创建节点之前，都判断一下该父节点是否存在 —— 这个处理通常让人厌恶。在使用 Curator 之后，通过调用<code>creatingParentsIfNeeded</code>接口，Curator 就能够自动地递归创建所有需要的父节点。</p>
<p> 同时要注意的一点是，由于在 ZooKeeper 中规定了所有非叶子节点必须为持久节点，调用上面这个 API 之后，只有 path 参数对应的数据节点是临时节点，其父节点均为持久节点。</p>
</li>
</ol>
<h2 id="删除节点-1"><a href="#删除节点-1" class="headerlink" title="删除节点"></a>删除节点</h2><p>在 Curator 中，可以通过以下 API 来删除指定节点：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">CuratorFramework
-- DeleteBuilder delete();
Versionable&lt;T>
-- T withVersion(int version);
DeleteBuilder 
-- DeleteBuilderBase guaranteed();
PathAndBytesable&lt;T>
-- T forPath(String path, byte[] data);
-- T forPath(String path);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下是适用场景及示例</p>
<ol>
<li><p>删除一个节点</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.delete().forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 注意，使用该接口，只能删除叶子节点。</p>
</li>
<li><p>删除一个节点，并递归删除其所有子节点</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.delete().deletingChildrenIfNeeded().forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>删除一个节点，强制指定版本进行删除</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.delete().withVersion(version).forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>删除一个节点，强制保证删除</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.delete().guaranteed().forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 注意，<code>guaranteed()</code>接口是一个保障措施，只要客户端会话有效，那么 Curator 会在后台持续进行删除操作，直到节点删除成功。</p>
</li>
</ol>
<p>这里重点讲解<code>guaranteed()</code>这个方法。正如该接口的官方文档中所注明的，在 ZooKeeper 客户端使用过程中，可能会碰到这样的问题：客户端执行一个删除节点操作，但是由于一些网络原因，导致删除操作失败。对于这个异常，在有些场景中是致命的，如“Master选举” —— 在这个场景中，ZooKeeper 客户端通常是通过节点的创建与删除来实现的。针对这个问题，Curator 中引入了一种重试机制：如果我们调用了<code>guaranteed()</code>方法，那么当客户端碰到上面这些网络异常的时候，会记录下这次失败的删除操作，只要客户端会话有效，那么其就会在后台反复重试，直到节点删除成功。通过这样的措施，就可以保证节点删除操作一定会生效。</p>
<h2 id="读取数据-1"><a href="#读取数据-1" class="headerlink" title="读取数据"></a>读取数据</h2><p>在 Curator 中，可以通过以下 API 来获取节点的数据内容：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">CuratorFramework
-- GetDataBuilder getData();
Statable&lt;T>
-- T storingStatIn(Stat stat);
Pathable&lt;T>
-- T forPath(String path);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下是适用场景及示例</p>
<ol>
<li><p>读取一个节点的数据内容</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.getData().forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>读取一个节点的数据内容，同时获取到该节点的 stat</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.getData().storingStatIn(stat).forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<pre><code>Curator 通过传入一个旧的 stat 变量的方式来存储服务端返回的最新的节点状态信息。
</code></pre><h2 id="更新数据-1"><a href="#更新数据-1" class="headerlink" title="更新数据"></a>更新数据</h2><p>在 Curator 中，可以通过以下 API 来获取节点的数据内容：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">CuratorFramework
-- SetDataBuilder setData();
Versionable&lt;T>
-- T withVersion(int version);
PathAndBytesable&lt;T>
-- T forPath(String path, byte[] data);
-- T forPath(String path);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下是适用场景及示例</p>
<ol>
<li><p>更新一个节点的数据内容</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.setData().forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 调用该接口后，会返回一个 stat 对象。</p>
</li>
<li><p>更新一个节点的数据内容，强制指定版本进行更新</p>
 <pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">client.setData().withVersion(version).forPath(path);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> 注意，withVersion 接口就是用来实现 CAS 的，version（版本信息）通常是从一个旧的 stat 对象中获取到的。</p>
</li>
</ol>
<h2 id="异步接口"><a href="#异步接口" class="headerlink" title="异步接口"></a>异步接口</h2><p>Curator 中引入了 BackgroundCallback 接口，用来处理异步接口调用之后服务端返回的结果信息，其接口定义如下。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Functor for an async background operation
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BackgroundCallback</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Called when the async background operation completes
     *
     * @param client the client
     * @param event operation result details
     * @throws Exception errors
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processResult</span><span class="token punctuation">(</span><span class="token class-name">CuratorFramework</span> client<span class="token punctuation">,</span> <span class="token class-name">CuratorEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>client</td>
<td>当前客户端实例</td>
</tr>
<tr>
<td>event</td>
<td>服务端实例</td>
</tr>
</tbody>
</table>
</div>
<p>对于 BackgroundCallback 接口，我们重点来看 CuratorEvent 这个参数。</p>
<p>CuratorEvent 定义了 ZooKeeper 服务端发送到客户端的一系列事件参数，其中比较重要的有事件类型和响应码两个参数。</p>
<p><strong>事件类型（CuratorEventType）</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>事件类型</th>
<th>代表操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>CREATE</td>
<td>Curator Framework#create()</td>
</tr>
<tr>
<td>DELETE</td>
<td>Curator Framework#delete()</td>
</tr>
<tr>
<td>EXISTS</td>
<td>Curator Framework#checkExists()</td>
</tr>
<tr>
<td>GET_DATA</td>
<td>Curator Framework#getData()</td>
</tr>
<tr>
<td>SET_DATA</td>
<td>Curator Framework#setData()</td>
</tr>
<tr>
<td>CHILDREN</td>
<td>Curator Framework#getChildren()</td>
</tr>
<tr>
<td>SYNC</td>
<td>Curator Framework#sync(String, Object)</td>
</tr>
<tr>
<td>GET_ACL</td>
<td>Curator Framework#getACL()</td>
</tr>
<tr>
<td>WATCHED</td>
<td>Watchable#usingWatcher(Watcher) / Watchable#watched()</td>
</tr>
<tr>
<td>CLOSING</td>
<td>ZooKeeper客户端与服务端连接断开事件</td>
</tr>
</tbody>
</table>
</div>
<p><strong>响应码（int）</strong><br>响应码用于标识事件的结果状态，所有响应码都被定义在<code>org.apache.zookeeper.KeeperException.Code</code>类中，比较常见的响应码有 0（Ok）、-4（ConnectionLoss）、-110（NodeExists）和 -112（Session Expired）等，分别代表接口调用成功、客户端与服务端连接已断开、指定节点已存在和会话已过期等。</p>
<p>在 Curator 中，可以通过以下 API 来进行异步操作：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Backgroundable&lt;T>
-- T inBackground();
-- T inBackground(Object context);
-- T inBackground(BackgroundCallback callback);
-- T inBackground(BackgroundCallback callback, Object context);
-- T inBackground(BackgroundCallback callback, Executor executor);
-- T inBackground(BackgroundCallback callback, Object context, Executor executor);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 ZooKeeper 中，所有异步通知事件处理都是由 EventThread 这个线程来处理的 —— EventThread线程用于串行处理所有的事件通知。EventThread 的“串行处理机制”在绝大部分应用场景下能够保证对事件处理的顺序性，但这个特性也有其弊端，就是一旦碰上一个复杂的处理单元，就会消耗过长的处理时间，从而影响对其他事件的处理。因此，在上面的 inBackground 接口中，允许用户传入一个 Executor 实例，这样一来，就可以把那些比较复杂的事件处理放到一个专门的线程池中去。</p>
<h1 id="Curator典型使用场景API"><a href="#Curator典型使用场景API" class="headerlink" title="Curator典型使用场景API"></a>Curator典型使用场景API</h1><p>Curator 不仅为开发者提供了更为便利的 API 接口，而且还提供了一些典型场景的使用参考。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h2><p>ZooKeeper 原生支持通过注册 Watcher 来进行事件监听，但是其使用并不是特别方便，需要开发人员自己反复注册 Watcher，比较繁琐。Curator 引入了 Cache 来实现对 ZooKeeper 服务端事件的监听。Cache 是 Curator 中对事件监听的包装，其对事件的监听其实可以近似看作是一个本地缓存视图和远程 ZooKeeper 视图的对比过程。同时 Curator 能够自动为开发人员处理反复注册监听，从而大大简化了原生 API 开发的繁琐过程。</p>
<p>Cache 分为两类监听类型：节点监听和子节点监听。</p>
<h3 id="NodeCache"><a href="#NodeCache" class="headerlink" title="NodeCache"></a>NodeCache</h3><p>NodeCache 用于监听指定 ZooKeeper 数据节点本身的变化</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">NodeCache</span><span class="token punctuation">(</span><span class="token class-name">CuratorFramework</span> client<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">)</span>；
<span class="token keyword">public</span> <span class="token class-name">NodeCache</span><span class="token punctuation">(</span><span class="token class-name">CuratorFramework</span> client<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dataIsCompressed<span class="token punctuation">)</span>；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/Nodecache构造方法参数说明.png" alt=""></p>
<p>同时，NodeCache 定义了事件处理的回调接口 NodeCacheListener。当数据节点的内容发生变化的时候，就会回调该方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">NodeCacheListener</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Called when a change has occurred
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span>     <span class="token function">nodeChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>NodeCache 使用实例</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">CuratorFramework client &#x3D; CuratorFrameworkFactory.builder()
                .connectString(&quot;127.0.0.1:2181&quot;)
                .retryPolicy(new ExponentialBackoffRetry(1000, 3))
                .build();
client.start();
client.create()
    .creatingParentsIfNeeded()
    .withMode(CreateMode.EPHEMERAL)
    .forPath(&quot;&#x2F;zk&quot;, &quot;init&quot;.getBytes());
final NodeCache cache &#x3D; new NodeCache(client, &quot;&#x2F;zk&quot;, false);
cache.start(true);
cache.getListenable().addListener(new NodeCacheListener() &#123;
    @Override
    public void nodeChanged() throws Exception &#123;
        System.out.println(&quot;Node data update&quot;);
    &#125;
&#125;);
client.setData().forPath(&quot;&#x2F;zk&quot;, &quot;changed&quot;.getBytes());
Thread.sleep(1000);
client.delete().deletingChildrenIfNeeded().forPath(&quot;&#x2F;zk&quot;);
Thread.sleep(Integer.MAX_VALUE);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的示例程序中，首先构造了一个 NodeCache 实例，然后调用 start 方法，该方法有个 boolean 类型的参数，默认是 false，如果设置为 true，那么 NodeCache 在第一次启动的时候就会立刻从 ZooKeeper 上读取对应节点的数据内容，并保存在 Cache 中 NodeCache 不仅可以用于监听数据节点的内容变更，也能监听指定节点是否存在如果原本节点不存在，那么 Cache 就会在节点被创建后触发 NodeCacheListener。但是，如果该数据节点被删除，那么 Curator 就无法触发 NodeCacheListener。</p>
<h3 id="PathChildrenCache"><a href="#PathChildrenCache" class="headerlink" title="PathChildrenCache"></a>PathChildrenCache</h3><p>PathChildrenCache 用于监听指定 ZooKeeper 数据节点的子节点变化情况。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public PathChildrenCache(CuratorFramework client, String path, boolean cacheData);
public PathChildrenCache(CuratorFramework client, String path, boolean cacheData, ThreadFactory threadFactory);
public PathChildrenCache(CuratorFramework client, String path, boolean cacheData, boolean dataIsCompressed, ThreadFactory threadFactory);
public PathChildrenCache(CuratorFramework client, String path, boolean cacheData, boolean dataIsCompressed, final ExecutorService executorService);
public PathChildrenCache(CuratorFramework client, String path, boolean cacheData, boolean dataIsCompressed, final CloseableExecutorService executorService);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/ZooKeeper/PathChildrenCache构造方法参数说明.png" alt=""></p>
<p>PathChildrenCache 定义了事件处理的回调接口 PathChildrenCacheListener。当数据节点的内容发生变化的时候，就会回调该方法。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;**
 * Listener for PathChildrenCache changes
 *&#x2F;
public interface PathChildrenCacheListener
&#123;
    &#x2F;**
     * Called when a change has occurred
     *
     * @param client the client
     * @param event describes the change
     * @throws Exception errors
     *&#x2F;
    public void     childEvent(CuratorFramework client, PathChildrenCacheEvent event) throws Exception;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当指定节点的子节点发生变化时，就会回调该方法。PathChildrenCacheEvent 类中定义了所有的事件类型，主要包括新增子节点（CHILD<em> ADDED）、子节点数据变更（CHILD</em> UPDATED）和子节点删除（CHILD_ REMOVED）三类。</p>
<p>PathChildrenCache 使用实例</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">CuratorFramework client &#x3D; CuratorFrameworkFactory.builder()
    .connectString(&quot;127.0.0.1:2181&quot;)
    .retryPolicy(new ExponentialBackoffRetry(1000, 3))
    .build();
client.start();
PathChildrenCache cache &#x3D; new PathChildrenCache(client, &quot;&#x2F;zk&quot;, true);
cache.start(PathChildrenCache.StartMode.POST_INITIALIZED_EVENT);
cache.getListenable().addListener(new PathChildrenCacheListener() &#123;
    @Override
    public void childEvent(CuratorFramework client, PathChildrenCacheEvent event) throws Exception &#123;
        switch (event.getType()) &#123;
            case CHILD_ADDED:
                System.out.println(&quot;CHILD_ADDED &quot;+event.getData().getPath());
                break;
            case CHILD_UPDATED:
                System.out.println(&quot;CHILD_UPDATED &quot;+event.getData().getPath());
                break;
            case CHILD_REMOVED:
                System.out.println(&quot;CHILD_REMOVED &quot;+event.getData().getPath());
                break;
            default:
                break;
        &#125;
    &#125;
&#125;);
client.create().withMode(CreateMode.PERSISTENT).forPath(&quot;&#x2F;zk&quot;);
Thread.sleep(1000);
client.create().withMode(CreateMode.PERSISTENT).forPath(&quot;&#x2F;zk&#x2F;v1&quot;);
Thread.sleep(1000);
client.delete().forPath(&quot;&#x2F;zk&#x2F;v1&quot;);
Thread.sleep(1000);
client.delete().forPath(&quot;&#x2F;zk&quot;);
Thread.sleep(Integer.MAX_VALUE);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面这个示例程序中，对<code>/zk</code>节点进行了子节点变更事件的监听，一旦该节点新增/删除子节点，或者子节点数据发生变更，就会回调 PathChildrenCacheListener，并根据对应的事件类型进行相关的处理。同时，我们也看到，对于节点<code>/zk</code>本身的变更，并没有通知到客户端。</p>
<p>另外，和其他 ZooKeeper 客户端产品一样，Curator 也无法对二级子节点进行事件监听。也就是说，如果使用 PathChildrenCache 对<code>/zk</code>进行监听，那么当<code>/zk/v1/v2</code>节点被创建或删除的时候，是无法触发子节点变更事件的</p>
<h2 id="Master选举"><a href="#Master选举" class="headerlink" title="Master选举"></a>Master选举</h2><p>在分布式系统中，经常会碰到这样的场景：对于一个复杂的任务，仅需要从集群中选举出一台进行处理即可。诸如此类的分布式问题，我们统称为“Master选举”。借助 ZooKeeper，我们可以比较方便地实现 Master 选举的功能，其大体思路非常简单：</p>
<p>选择一个根节点，例如<code>/master_select</code>，多台机器同时向该节点创建一个子节点<code>/master_select/lock</code>，利用 ZooKeeper 的特性，最终只有一台机器能够创建成功，成功的那台机器就作为 Master。</p>
<p>Curator 也是基于这个思路，但是它将节点创建、事件监听和自动选举过程进行了封装，开发人员只需要调用简单的 API 即可实现 Master 选举。下面我们通过一个示例程序来看看如何使用 Curator 实现 Master 选举功能</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LeaderSelector</span> selector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeaderSelector</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/master"</span><span class="token punctuation">,</span> 
    <span class="token comment">//成功获取Master权利后调用该监听器，执行完释放Master权利，重新开始选举</span>
    <span class="token keyword">new</span> <span class="token class-name">LeaderSelectorListenerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">takeLeadership</span><span class="token punctuation">(</span><span class="token class-name">CuratorFramework</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"成为 Master 角色"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"完成 Master 操作，释放 Master 权利"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
selector<span class="token punctuation">.</span><span class="token function">autoRequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
selector<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当一个应用程序完成 Master 逻辑后，另一个应用程序的 takeLeadership 方法才会被调用。这也就说明，当一个应用实例成为 Master 后，其他应用实例会进入等待，直到当前 Master 挂了或退出后才会开始选举新的 Master。</p>
<p>每选举一次 Master，就有类似<code>/master/_c_5a394510-44fb-4c28-a00b-d2c37d0403d7-lock-0000000018</code>的节点被创建出来。后缀的数字不断增加。</p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>在分布式环境中，为了保证数据的一致性，经常在程序的某个运行点（例如，减库存操作或流水号生成等）需要进行同步控制。</p>
<p>下面是分布式锁接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InterProcessLock</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Acquire the mutex - blocking until it's available. Each call to acquire must be balanced by a call
     * to &#123;@link #release()&#125;
     *
     * @throws Exception ZK errors, connection interruptions
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Acquire the mutex - blocks until it's available or the given time expires. Each call to acquire that returns true must be balanced by a call
     * to &#123;@link #release()&#125;
     *
     * @param time time to wait
     * @param unit time unit
     * @return true if the mutex was acquired, false if not
     * @throws Exception ZK errors, connection interruptions
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Perform one release of the mutex.
     *
     * @throws Exception ZK errors, interruptions, current thread does not own the lock
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns true if the mutex is acquired by a thread in this JVM
     *
     * @return true/false
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isAcquiredInThisProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面是分布式锁示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InterProcessMutex</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CountDownLatch</span> cdl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            cdl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"HH:mm:ss|SSS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"订单流水号："</span> <span class="token operator">+</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
cdl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="分布式计数器"><a href="#分布式计数器" class="headerlink" title="分布式计数器"></a>分布式计数器</h2><p>有了上述分布式锁实现的基础之后，我们就很容易基于其实现一个分布式计数器。分布式计数器的一个典型场景是统计系统的在线人数。基于 ZooKeeper 的分布式计数器的实现思路也非常简单：</p>
<p>指定一个 Zookeeper 数据节点作为计数器，多个应用实例在分布式锁的控制下，通过更新该数据节点的内容来实现计数功能。</p>
<p>Curator 将一系列逻辑封装在了 DistributedAtomicInteger 类中。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DistributedAtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedAtomicInteger</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/counter"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RetryOneTime</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AtomicValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> value <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Result: "</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">succeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="分布式Barrier"><a href="#分布式Barrier" class="headerlink" title="分布式Barrier"></a>分布式Barrier</h2><p>Barrier 是一种用来控制多线程之间同步的方式。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public class CyclicBarrierTest &#123;

    private static CyclicBarrier cb;
    public static void main(String[] args) &#123;

        cb &#x3D; new CyclicBarrier(5);

        &#x2F;&#x2F; 新建5个任务
        for(int i&#x3D;0; i&lt;SIZE; i++)
            new InnerThread().start();
    &#125;

    static class InnerThread extends Thread&#123;
        public void run() &#123;
            try &#123;
                System.out.println(Thread.currentThread().getName() + &quot; wait for CyclicBarrier.&quot;);

                &#x2F;&#x2F; 将cb的参与者数量加1
                cb.await();

                &#x2F;&#x2F; cb的参与者数量等于5时，才继续往后执行
                System.out.println(Thread.currentThread().getName() + &quot; continued.&quot;);
            &#125; catch (Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>CyclicBarrier 会准确地等待所有线程都处于就绪状态后才开始同时执行其他业务逻辑。如果是在同一个JVM中的话，使用 CyclicBarrier 完全可以解决诸如此类的多线程同步问题。但是，如果是在分布式环境中又该如何解决呢？ Curator 中提供的 DistributedBarrier 就是用来实现分布式 Barrier 的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">CuratorFramework</span> clientM <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
clientM<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DistributedBarrier</span> barrierM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedBarrier</span><span class="token punctuation">(</span>clientM<span class="token punctuation">,</span> <span class="token string">"/barrier"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DistributedBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedBarrier</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/barrier"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"进入线程设置 Barrier"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            barrier<span class="token punctuation">.</span><span class="token function">setBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            barrier<span class="token punctuation">.</span><span class="token function">waitOnBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"退出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//手动解除Barrier</span>
barrierM<span class="token punctuation">.</span><span class="token function">removeBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与上面不同的是，DistributedDoubleBarrier 提供了线程自发触发 Barrier 释放的模式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:2181"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DistributedDoubleBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedDoubleBarrier</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/barrier"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"进入线程"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            barrier<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            barrier<span class="token punctuation">.</span><span class="token function">leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"退出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><h3 id="ZKPaths"><a href="#ZKPaths" class="headerlink" title="ZKPaths"></a>ZKPaths</h3><p>提供了一些简单的 API 来构建 ZNode 路径、递归创建和删除节点等。</p>
<h3 id="EnsurePath"><a href="#EnsurePath" class="headerlink" title="EnsurePath"></a>EnsurePath</h3><p>EnsurePath 提供了一种能够确保数据节点存在的机制，多用于这样的业务场景中：上层业务希望对一个数据节点进行一些操作，但是操作之前需要确保该节点存在。基于 ZooKeeper 提供的原始 API 接口，为解决上述场景的问题，开发人员需要首先对该节点进行一个判断，如果该节点不存在，那么就需要创建节点。而与此同时，在分布式环境中，在 A 机器试图进行节点创建的过程中，由于并发操作的存在，另一台机器，如 B 机器，也在同时创建这个节点，于是 A 机器创建的时候，可能会抛出诸如“节点已经存在”的异常。因此开发人员还必须对这些异常进行单独的处理，逻辑通常非常琐碎。</p>
<p>EnsurePath 正好可以用来解决这些烦人的问题，它采取了静默的节点创建方式，其内部实现就是试图创建指定节点，如果节点已经存在，那么就不进行任何操作，也不对外抛出异常，否则正常创建数据节点。</p>
<h3 id="TestingServer"><a href="#TestingServer" class="headerlink" title="TestingServer"></a>TestingServer</h3><p>为了便于开发人员进行 ZooKeeper 的开发与测试，Curator 提供了一种启动简易 Zookeeper 服务的方法 —— TestingServer。TestingServer 允许开发人员非常方便地启动一个标准的 ZooKeeper 服务器，并以此来进行一系列的单元测试。TestingServer 在 Curator 的 test 包中，读者需要单独依赖以下 Maven 依赖来获取。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下是代码示例</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">TestingServer server &#x3D; new TestingServer(2181);
CuratorFramework client &#x3D; CuratorFrameworkFactory.builder()
    .connectString(server.getConnectString())
    .retryPolicy(new RetryOneTime(1000))
    .build();
client.start();
System.out.println(client.getChildren());
server.close();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="TestingCluster"><a href="#TestingCluster" class="headerlink" title="TestingCluster"></a>TestingCluster</h3><p>上文中提到，开发人员可以利用 TestingServer 来非常方便地在单元测试中启动一个 ZooKeeper 服务器，同样，Curator 也提供了启动 ZooKeeper 集群的工具类。</p>
<p>TestingCluster 是一个可以模拟 ZooKeeper 集群环境的 Curator 工具类，能够便于开发人员在本地模拟由 n 台机器组成的集群环境。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">TestingCluster cluster &#x3D; new TestingCluster(4);
cluster.start();
Thread.sleep(3000);

TestingZooKeeperServer leader &#x3D; null;
for (TestingZooKeeperServer zs : cluster.getServers()) &#123;
    System.out.println(zs.getInstanceSpec().getServerId() + &quot; &quot; + zs.getQuorumPeer().getServerState());
    System.out.println(zs.getInstanceSpec().getDataDirectory().getAbsolutePath());
    if (zs.getQuorumPeer().getServerState().equals(&quot;leading&quot;)) &#123;
        leader &#x3D; zs;
    &#125;
&#125;
leader.kill();
System.out.println(&quot;--After Kill Leader&quot;);
for (TestingZooKeeperServer zs : cluster.getServers()) &#123;
    System.out.println(zs.getInstanceSpec().getServerId() + &quot;\n&quot; + zs.getQuorumPeer().getServerState());
    System.out.println(zs.getInstanceSpec().getDataDirectory().getAbsolutePath());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/zkServer/" rel="tag"># zkServer</a>
              <a href="/tags/zkClient/" rel="tag"># zkClient</a>
              <a href="/tags/Curator/" rel="tag"># Curator</a>
              <a href="/tags/ZooKeeper/" rel="tag"># ZooKeeper</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/01/Note-Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" rel="prev" title="Memo Java动态代理">
      <i class="fa fa-chevron-left"></i> Memo Java动态代理
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/06/ZooKeeper-%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" rel="next" title="ZooKeeper 典型应用场景">
      ZooKeeper 典型应用场景 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%84%9A%E6%9C%AC"><span class="nav-number">1.</span> <span class="nav-text">客户端脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.1.</span> <span class="nav-text">连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.</span> <span class="nav-text">创建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96"><span class="nav-number">1.3.</span> <span class="nav-text">读取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0"><span class="nav-number">1.4.</span> <span class="nav-text">更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">1.5.</span> <span class="nav-text">删除</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F%E5%AE%A2%E6%88%B7%E7%AB%AFAPI"><span class="nav-number">2.</span> <span class="nav-text">原生客户端API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D"><span class="nav-number">2.1.</span> <span class="nav-text">创建会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%8A%82%E7%82%B9"><span class="nav-number">2.2.</span> <span class="nav-text">创建节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="nav-number">2.3.</span> <span class="nav-text">删除节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">2.4.</span> <span class="nav-text">读取数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getChildren"><span class="nav-number">2.4.1.</span> <span class="nav-text">getChildren</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getData"><span class="nav-number">2.4.2.</span> <span class="nav-text">getData</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="nav-number">2.5.</span> <span class="nav-text">更新数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="nav-number">2.6.</span> <span class="nav-text">删除数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E6%B5%8B%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">2.7.</span> <span class="nav-text">检测节点是否存在</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">2.8.</span> <span class="nav-text">权限控制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Curator%E5%AE%A2%E6%88%B7%E7%AB%AFAPI"><span class="nav-number">3.</span> <span class="nav-text">Curator客户端API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D-1"><span class="nav-number">3.1.</span> <span class="nav-text">创建会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%8A%82%E7%82%B9-1"><span class="nav-number">3.2.</span> <span class="nav-text">创建节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9-1"><span class="nav-number">3.3.</span> <span class="nav-text">删除节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE-1"><span class="nav-number">3.4.</span> <span class="nav-text">读取数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE-1"><span class="nav-number">3.5.</span> <span class="nav-text">更新数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.6.</span> <span class="nav-text">异步接口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Curator%E5%85%B8%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AFAPI"><span class="nav-number">4.</span> <span class="nav-text">Curator典型使用场景API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="nav-number">4.1.</span> <span class="nav-text">事件监听</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NodeCache"><span class="nav-number">4.1.1.</span> <span class="nav-text">NodeCache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PathChildrenCache"><span class="nav-number">4.1.2.</span> <span class="nav-text">PathChildrenCache</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Master%E9%80%89%E4%B8%BE"><span class="nav-number">4.2.</span> <span class="nav-text">Master选举</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">4.3.</span> <span class="nav-text">分布式锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">4.4.</span> <span class="nav-text">分布式计数器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8FBarrier"><span class="nav-number">4.5.</span> <span class="nav-text">分布式Barrier</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">4.6.</span> <span class="nav-text">常用工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZKPaths"><span class="nav-number">4.6.1.</span> <span class="nav-text">ZKPaths</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EnsurePath"><span class="nav-number">4.6.2.</span> <span class="nav-text">EnsurePath</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TestingServer"><span class="nav-number">4.6.3.</span> <span class="nav-text">TestingServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TestingCluster"><span class="nav-number">4.6.4.</span> <span class="nav-text">TestingCluster</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Wang Zihao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">287</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Zihao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
