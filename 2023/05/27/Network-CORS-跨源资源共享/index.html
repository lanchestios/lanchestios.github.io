<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="跨源资源共享（CORS，或通俗地译为跨域资源共享）是一种基于 HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其他源（域、协议或端口），使得浏览器允许这些源访问加载自己的资源。跨源资源共享还通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的“预检”请求。在预检中，浏览器发送的头中标示有 HTTP 方法和真实请求中会用到的头。">
<meta property="og:type" content="article">
<meta property="og:title" content="CORS 跨源资源共享">
<meta property="og:url" content="http://example.com/2023/05/27/Network-CORS-%E8%B7%A8%E6%BA%90%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB/index.html">
<meta property="og:site_name" content="Lanchester Blog">
<meta property="og:description" content="跨源资源共享（CORS，或通俗地译为跨域资源共享）是一种基于 HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其他源（域、协议或端口），使得浏览器允许这些源访问加载自己的资源。跨源资源共享还通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的“预检”请求。在预检中，浏览器发送的头中标示有 HTTP 方法和真实请求中会用到的头。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/Linux/cors_principle.png">
<meta property="og:image" content="http://example.com/images/Linux/simple-req.png">
<meta property="og:image" content="http://example.com/images/Linux/preflight_correct.png">
<meta property="og:image" content="http://example.com/images/Linux/cred-req-updated.png">
<meta property="og:image" content="http://example.com/images/Linux/CORS-不配置跨域请求示例.png">
<meta property="og:image" content="http://example.com/images/Linux/CORS-配置跨域请求示例.png">
<meta property="og:image" content="http://example.com/images/Linux/CORS-不配置跨域允许请求头.png">
<meta property="og:image" content="http://example.com/images/Linux/CORS-配置跨域允许请求头.png">
<meta property="og:image" content="http://example.com/images/Linux/CORS-跨域Cookie处理.png">
<meta property="og:image" content="http://example.com/images/Linux/CORS-跨域后端Cookie处理.png">
<meta property="article:published_time" content="2023-05-27T05:43:50.000Z">
<meta property="article:modified_time" content="2023-08-01T02:17:20.556Z">
<meta property="article:author" content="Wang Zihao">
<meta property="article:tag" content="Network">
<meta property="article:tag" content="HTTP">
<meta property="article:tag" content="CORS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Linux/cors_principle.png">

<link rel="canonical" href="http://example.com/2023/05/27/Network-CORS-%E8%B7%A8%E6%BA%90%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>CORS 跨源资源共享 | Lanchester Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lanchester Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Leave a leaf</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/27/Network-CORS-%E8%B7%A8%E6%BA%90%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Wang Zihao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lanchester Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CORS 跨源资源共享
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-05-27 13:43:50" itemprop="dateCreated datePublished" datetime="2023-05-27T13:43:50+08:00">2023-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-01 10:17:20" itemprop="dateModified" datetime="2023-08-01T10:17:20+08:00">2023-08-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>跨源资源共享</strong>（<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CORS">CORS</a>，或通俗地译为跨域资源共享）是一种基于 HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其他源（域、协议或端口），使得浏览器允许这些源访问加载自己的资源。跨源资源共享还通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的“预检”请求。在预检中，浏览器发送的头中标示有 HTTP 方法和真实请求中会用到的头。</p>
<span id="more"></span>
<p>跨源 HTTP 请求的一个例子：运行在 <code>https://domain-a.com</code> 的 JavaScript 代码使用 <code>XMLHttpRequest</code> 来发起一个到 <code>https://domain-b.com/data.json</code> 的请求。</p>
<p>出于安全性，浏览器限制脚本内发起的跨源 HTTP 请求。例如，<code>XMLHttpRequest</code> 和 <code>Fetch API</code> 遵循<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">同源策略</a>。这意味着使用这些 API 的 Web 应用程序只能从加载应用程序的同一个域请求 HTTP 资源，除非响应报文包含了正确 CORS 响应头。</p>
<p><img src="/images/Linux/cors_principle.png" alt="CORS 机制的图表表示"></p>
<p>CORS 机制允许 Web 应用服务器进行跨源访问控制，从而使跨源数据传输得以安全进行。现代浏览器支持在 API 容器中（例如 <code>XMLHttpRequest</code> 或 <code>Fetch</code>）使用 CORS，以降低跨源 HTTP 请求所带来的风险。</p>
<h1 id="理论解释"><a href="#理论解释" class="headerlink" title="理论解释"></a>理论解释</h1><h2 id="功能概述"><a href="#功能概述" class="headerlink" title="功能概述"></a>功能概述</h2><p>跨源资源共享标准新增了一组 HTTP 标头字段，允许服务器声明哪些源站通过浏览器有权限访问哪些资源。另外，规范要求，对那些可能对服务器数据产生副作用的 HTTP 请求方法（特别是 <code>GET</code> 以外的 HTTP 请求，或者搭配某些 MIME 类型的 <code>POST</code> 请求），浏览器必须首先使用 <code>OPTIONS</code> 方法发起一个预检请求（preflight request），从而获知服务端是否允许该跨源请求。服务器确认允许之后，才发起实际的 HTTP 请求。在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证（例如 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies">Cookie</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Authentication">HTTP 认证</a>相关数据）。</p>
<p>CORS 请求失败会产生错误，但是为了安全，在 JavaScript 代码层面无法获知到底具体是哪里出了问题。你只能查看浏览器的控制台以得知具体是哪里出现了错误。</p>
<h2 id="若干访问控制场景"><a href="#若干访问控制场景" class="headerlink" title="若干访问控制场景"></a>若干访问控制场景</h2><p>这里，我们使用三个场景来解释跨源资源共享机制的工作原理。这些例子都使用在任意所支持的浏览器上都可以发出跨域请求的 <code>XMLHttpRequest</code> 对象。</p>
<h3 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h3><p>某些请求不会触发 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Preflight_request">CORS 预检请求</a>。在废弃的 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/2014/REC-cors-20140116/#terminology">CORS 规范</a>中称这样的请求为简单请求，但是目前的 <a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/">Fetch 规范</a>（CORS 的现行定义规范）中不再使用这个词语。</p>
<p>其动机是，HTML 4.0 中的 <code>&lt;form&gt;</code> 元素（早于跨站 <code>XMLHttpRequest</code> 或 <code>Fetch</code> ）可以向任何来源提交简单请求，所以任何编写服务器的人一定已经在保护<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CSRF">跨站请求伪造攻击</a>（CSRF）。在这个假设下，服务器不必选择加入（通过响应预检请求）来接收任何看起来像表单提交的请求，因为 CSRF 的威胁并不比表单提交的威胁差。然而，服务器仍然必须提供 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin"><code>Access-Control-Allow-Origin</code></a> 的选择，以便与脚本共享响应。</p>
<p>若请求<strong>满足所有下述条件</strong>，则该请求可视为简单请求：</p>
<ul>
<li>使用下列方法之一：<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET"><code>GET</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/HEAD"><code>HEAD</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST"><code>POST</code></a></li>
</ul>
</li>
<li>除了被用户代理自动设置的标头字段（例如 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Connection"><code>Connection</code></a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/User-Agent"><code>User-Agent</code></a> 或其他在 Fetch 规范中定义为<a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#forbidden-header-name">禁用标头名称</a>的标头），允许人为设置的字段为 Fetch 规范定义的<a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">对 CORS 安全的标头字段集合</a>。该集合为：<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept"><code>Accept</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language"><code>Accept-Language</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language"><code>Content-Language</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type"><code>Content-Type</code></a>（需要注意额外的限制）</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range"><code>Range</code></a>（只允许<a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#simple-range-header-value">简单的范围标头值</a> 如 <code>bytes=256-</code> 或 <code>bytes=127-255</code>）</li>
</ul>
</li>
</ul>
<p><strong>备注：</strong> Firefox 还没有将 <code>Range</code> 实现为安全的请求标头。参见 <a target="_blank" rel="noopener" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1733981">bug 1733981</a>。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type"><code>Content-Type</code></a> 标头所指定的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/MIME_type">媒体类型</a>的值仅限于下列三者之一：<ul>
<li><code>text/plain</code></li>
<li><code>multipart/form-data</code></li>
<li><code>application/x-www-form-urlencoded</code></li>
</ul>
</li>
<li>如果请求是使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code></a> 对象发出的，在返回的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload"><code>XMLHttpRequest.upload</code></a> 对象属性上没有注册任何事件监听器；也就是说，给定一个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code></a> 实例 <code>xhr</code>，没有调用 <code>xhr.upload.addEventListener()</code>，以监听该上传请求。</li>
<li>请求中没有使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream"><code>ReadableStream</code></a> 对象。</li>
</ul>
<p><strong>备注：</strong> WebKit Nightly 和 Safari Technology Preview 为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept"><code>Accept</code></a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language"><code>Accept-Language</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language"><code>Content-Language</code></a> 标头字段的值添加了额外的限制。如果这些标头字段的值是“非标准”的，WebKit/Safari 就不会将这些请求视为“简单请求”。WebKit/Safari 并没有在文档中列出哪些值是“非标准”的，不过我们可以在这里找到相关讨论：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bugs.webkit.org/show_bug.cgi?id=165178">Require preflight for non-standard CORS-safelisted request headers Accept, Accept-Language, and Content-Language</a></li>
<li><a target="_blank" rel="noopener" href="https://bugs.webkit.org/show_bug.cgi?id=165566">Allow commas in Accept, Accept-Language, and Content-Language request headers for simple CORS</a></li>
<li><a target="_blank" rel="noopener" href="https://bugs.webkit.org/show_bug.cgi?id=166363">Switch to a blacklist model for restricted Accept headers in simple CORS requests</a></li>
</ul>
<p>其他浏览器并不支持这些额外的限制，因为它们不属于规范的一部分。</p>
<p>比如说，假如站点 <code>https://foo.example</code> 的网页应用想要访问 <code>https://bar.other</code> 的资源。<code>foo.example</code> 的网页中可能包含类似于下面的 JavaScript 代码：</p>
<pre class="line-numbers language-none"><code class="language-none">const xhr &#x3D; new XMLHttpRequest();
const url &#x3D; &#39;https:&#x2F;&#x2F;bar.other&#x2F;resources&#x2F;public-data&#x2F;&#39;;

xhr.open(&#39;GET&#39;, url);
xhr.onreadystatechange &#x3D; someHandler;
xhr.send();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此操作实行了客户端和服务器之间的简单交换，使用 CORS 标头字段来处理权限：</p>
<p><img src="/images/Linux/simple-req.png" alt="简单 GET 请求的示意图"></p>
<p>以下是浏览器发送给服务器的请求报文：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;resources&#x2F;public-data&#x2F; HTTP&#x2F;1.1
Host: bar.other
User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0
Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8
Accept-Language: en-us,en;q&#x3D;0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Origin: https:&#x2F;&#x2F;foo.example<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请求标头字段 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Origin"><code>Origin</code></a> 表明该请求来源于 <code>http://foo.example</code>。</p>
<p>让我们来看看服务器如何响应：</p>
<pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
Date: Mon, 01 Dec 2008 00:23:53 GMT
Server: Apache&#x2F;2
Access-Control-Allow-Origin: *
Keep-Alive: timeout&#x3D;2, max&#x3D;100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: application&#x2F;xml

[…XML Data…]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本例中，服务端返回的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin"><code>Access-Control-Allow-Origin</code></a> 标头的 <code>Access-Control-Allow-Origin: *</code> 值表明，该资源可以被<strong>任意</strong>外源访问。</p>
<pre class="line-numbers language-none"><code class="language-none">Access-Control-Allow-Origin: *<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Origin"><code>Origin</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin"><code>Access-Control-Allow-Origin</code></a> 就能完成最简单的访问控制。如果 <code>https://bar.other</code> 的资源持有者想限制他的资源只能通过 <code>https://foo.example</code> 来访问（也就是说，非 <code>https://foo.example</code> 域无法通过跨源访问访问到该资源），他可以这样做：</p>
<pre class="line-numbers language-none"><code class="language-none">Access-Control-Allow-Origin: https:&#x2F;&#x2F;foo.example<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>备注：</strong> 当响应的是<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E9%99%84%E5%B8%A6%E8%BA%AB%E4%BB%BD%E5%87%AD%E8%AF%81%E7%9A%84%E8%AF%B7%E6%B1%82">附带身份凭证的请求</a>时，服务端<strong>必须</strong>明确 <code>Access-Control-Allow-Origin</code> 的值，而不能使用通配符“<code>*</code>”。</p>
<h3 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h3><p>与简单请求不同，“需预检的请求”要求必须首先使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS"><code>OPTIONS</code></a> 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。”预检请求“的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响。</p>
<p>如下是一个需要执行预检请求的 HTTP 请求：</p>
<pre class="line-numbers language-none"><code class="language-none">const xhr &#x3D; new XMLHttpRequest();
xhr.open(&#39;POST&#39;, &#39;https:&#x2F;&#x2F;bar.other&#x2F;resources&#x2F;post-here&#x2F;&#39;);
xhr.setRequestHeader(&#39;X-PINGOTHER&#39;, &#39;pingpong&#39;);
xhr.setRequestHeader(&#39;Content-Type&#39;, &#39;application&#x2F;xml&#39;);
xhr.onreadystatechange &#x3D; handler;
xhr.send(&#39;&lt;person&gt;&lt;name&gt;Arun&lt;&#x2F;name&gt;&lt;&#x2F;person&gt;&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的代码使用 <code>POST</code> 请求发送一个 XML 请求体，该请求包含了一个非标准的 HTTP <code>X-PINGOTHER</code> 请求标头。这样的请求标头并不是 HTTP/1.1 的一部分，但通常对于 web 应用很有用处。另外，该请求的 <code>Content-Type</code> 为 <code>application/xml</code>，且使用了自定义的请求标头，所以该请求需要首先发起“预检请求”。</p>
<p><img src="/images/Linux/preflight_correct.png" alt=""></p>
<p><strong>备注：</strong> 如下所述，实际的 <code>POST</code> 请求不会携带 <code>Access-Control-Request-*</code> 标头，它们仅用于 <code>OPTIONS</code> 请求。</p>
<p>下面是服务端和客户端完整的信息交互。首次交互是预检请求/响应：</p>
<pre class="line-numbers language-none"><code class="language-none">OPTIONS &#x2F;doc HTTP&#x2F;1.1
Host: bar.other
User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0
Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8
Accept-Language: en-us,en;q&#x3D;0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Origin: https:&#x2F;&#x2F;foo.example
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER, Content-Type

HTTP&#x2F;1.1 204 No Content
Date: Mon, 01 Dec 2008 01:15:39 GMT
Server: Apache&#x2F;2
Access-Control-Allow-Origin: https:&#x2F;&#x2F;foo.example
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
Access-Control-Max-Age: 86400
Vary: Accept-Encoding, Origin
Keep-Alive: timeout&#x3D;2, max&#x3D;100
Connection: Keep-Alive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的报文中，我们看到，第 1 - 10 行使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS"><code>OPTIONS</code></a> 方法发送了预检请求，浏览器根据上面的 JavaScript 代码片断所使用的请求参数来决定是否需要发送，这样服务器就可以回应是否可以接受用实际的请求参数来发送请求。OPTIONS 是 HTTP/1.1 协议中定义的方法，用于从服务器获取更多信息，是<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Safe/HTTP">安全</a>的方法。该方法不会对服务器资源产生影响。注意 OPTIONS 预检请求中同时携带了下面两个标头字段：</p>
<pre class="line-numbers language-none"><code class="language-none">Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER, Content-Type<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>标头字段 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Method"><code>Access-Control-Request-Method</code></a> 告知服务器，实际请求将使用 <code>POST</code> 方法。标头字段 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Headers"><code>Access-Control-Request-Headers</code></a> 告知服务器，实际请求将携带两个自定义请求标头字段：<code>X-PINGOTHER</code> 与 <code>Content-Type</code>。服务器据此决定，该实际请求是否被允许。</p>
<p>第 12 - 21 行为预检请求的响应，表明服务器将接受后续的实际请求方法（<code>POST</code>）和请求头（<code>X-PINGOTHER</code>）。重点看第 15 - 18 行：</p>
<pre class="line-numbers language-none"><code class="language-none">Access-Control-Allow-Origin: https:&#x2F;&#x2F;foo.example
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
Access-Control-Max-Age: 86400<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务器的响应携带了 <code>Access-Control-Allow-Origin: https://foo.example</code>，从而限制请求的源域。同时，携带的 <code>Access-Control-Allow-Methods</code> 表明服务器允许客户端使用 <code>POST</code> 和 <code>GET</code> 方法发起请求（与 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Allow"><code>Allow</code></a> 响应标头类似，但该标头具有严格的访问控制）。</p>
<p>标头字段 <code>Access-Control-Allow-Headers</code> 表明服务器允许请求中携带字段 <code>X-PINGOTHER</code> 与 <code>Content-Type</code>。与 <code>Access-Control-Allow-Methods</code> 一样，<code>Access-Control-Allow-Headers</code> 的值为逗号分割的列表。</p>
<p>最后，标头字段 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Max-Age"><code>Access-Control-Max-Age</code></a> 给定了该预检请求可供缓存的时间长短，单位为秒，默认值是 5 秒。在有效时间内，浏览器无须为同一请求再次发起预检请求。以上例子中，该响应的有效时间为 86400 秒，也就是 24 小时。请注意，浏览器自身维护了一个<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Max-Age">最大有效时间</a>，如果该标头字段的值超过了最大有效时间，将不会生效。</p>
<p>预检请求完成之后，发送实际请求：</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;doc HTTP&#x2F;1.1
Host: bar.other
User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0
Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8
Accept-Language: en-us,en;q&#x3D;0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
X-PINGOTHER: pingpong
Content-Type: text&#x2F;xml; charset&#x3D;UTF-8
Referer: https:&#x2F;&#x2F;foo.example&#x2F;examples&#x2F;preflightInvocation.html
Content-Length: 55
Origin: https:&#x2F;&#x2F;foo.example
Pragma: no-cache
Cache-Control: no-cache

&lt;person&gt;&lt;name&gt;Arun&lt;&#x2F;name&gt;&lt;&#x2F;person&gt;

HTTP&#x2F;1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:40 GMT
Server: Apache&#x2F;2
Access-Control-Allow-Origin: https:&#x2F;&#x2F;foo.example
Vary: Accept-Encoding, Origin
Content-Encoding: gzip
Content-Length: 235
Keep-Alive: timeout&#x3D;2, max&#x3D;99
Connection: Keep-Alive
Content-Type: text&#x2F;plain

[Some XML payload]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="预检请求与重定向"><a href="#预检请求与重定向" class="headerlink" title="预检请求与重定向"></a>预检请求与重定向</h4><p>并不是所有浏览器都支持预检请求的重定向。如果一个预检请求发生了重定向，一部分浏览器将报告错误：</p>
<blockquote>
<p>The request was redirected to ‘<a href="https://example.com/foo">https://example.com/foo</a>‘, which is disallowed for cross-origin requests that require preflight. Request requires preflight, which is disallowed to follow cross-origin redirects.</p>
</blockquote>
<p>CORS 最初要求浏览器具有该行为，不过在后续的<a target="_blank" rel="noopener" href="https://github.com/whatwg/fetch/commit/0d9a4db8bc02251cc9e391543bb3c1322fb882f2">修订</a>中废弃了这一要求。但并非所有浏览器都实现了这一变更，而仍然表现出最初要求的行为。</p>
<p>在浏览器的实现跟上规范之前，有两种方式规避上述报错行为：</p>
<ul>
<li>在服务端去掉对预检请求的重定向；</li>
<li>将实际请求变成一个简单请求。</li>
</ul>
<p>如果上面两种方式难以做到，我们仍有其他办法：</p>
<ol>
<li>发出一个简单请求（使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Response/url"><code>Response.url</code></a> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/responseURL"><code>XMLHttpRequest.responseURL</code></a>）以判断真正的预检请求会返回什么地址。</li>
<li>发出另一个请求（真正的请求），使用在上一步通过 <code>Response.url</code> 或 <code>XMLHttpRequest.responseURL</code> 获得的 URL。</li>
</ol>
<p>不过，如果请求是由于存在 <code>Authorization</code> 字段而引发了预检请求，则这一方法将无法使用。这种情况只能由服务端进行更改。</p>
<h3 id="附带身份凭证的请求"><a href="#附带身份凭证的请求" class="headerlink" title="附带身份凭证的请求"></a>附带身份凭证的请求</h3><p><strong>备注：</strong> 当发出跨源请求时，第三方 cookie 策略仍将适用。无论如何改变本章节中描述的服务器和客户端的设置，该策略都会强制执行。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code></a> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API">Fetch</a> 与 CORS 的一个有趣的特性是，可以基于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies">HTTP cookies</a> 和 HTTP 认证信息发送身份凭证。一般而言，对于跨源 <code>XMLHttpRequest</code> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API">Fetch</a> 请求，浏览器<strong>不会</strong>发送身份凭证信息。如果要发送凭证信息，需要设置 <code>XMLHttpRequest</code> 对象的某个特殊标志位，或在构造 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Request"><code>Request</code></a> 对象时设置。</p>
<p>本例中，<code>https://foo.example</code> 的某脚本向 <code>https://bar.other</code> 发起一个 GET 请求，并设置 Cookies。在 <code>foo.example</code> 中可能包含这样的 JavaScript 代码：</p>
<pre class="line-numbers language-none"><code class="language-none">const invocation &#x3D; new XMLHttpRequest();
const url &#x3D; &quot;https:&#x2F;&#x2F;bar.other&#x2F;resources&#x2F;credentialed-content&#x2F;&quot;;

function callOtherDomain() &#123;
  if (invocation) &#123;
    invocation.open(&quot;GET&quot;, url, true);
    invocation.withCredentials &#x3D; true;
    invocation.onreadystatechange &#x3D; handler;
    invocation.send();
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第 7 行将 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code></a> 的 <code>withCredentials</code> 标志设置为 <code>true</code>，从而向服务器发送 Cookies。因为这是一个简单 <code>GET</code> 请求，所以浏览器不会对其发起“预检请求”。但是，如果服务器端的响应中未携带 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials"><code>Access-Control-Allow-Credentials</code></a><code>: true</code>，浏览器将<strong>不会</strong>把响应内容返回给请求的发送者。</p>
<p><img src="/images/Linux/cred-req-updated.png" alt=""></p>
<p>客户端与服务器端交互示例如下：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;resources&#x2F;credentialed-content&#x2F; HTTP&#x2F;1.1
Host: bar.other
User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0
Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8
Accept-Language: en-us,en;q&#x3D;0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Referer: https:&#x2F;&#x2F;foo.example&#x2F;examples&#x2F;credential.html
Origin: https:&#x2F;&#x2F;foo.example
Cookie: pageAccess&#x3D;2

HTTP&#x2F;1.1 200 OK
Date: Mon, 01 Dec 2008 01:34:52 GMT
Server: Apache&#x2F;2
Access-Control-Allow-Origin: https:&#x2F;&#x2F;foo.example
Access-Control-Allow-Credentials: true
Cache-Control: no-cache
Pragma: no-cache
Set-Cookie: pageAccess&#x3D;3; expires&#x3D;Wed, 31-Dec-2008 01:34:53 GMT
Vary: Accept-Encoding, Origin
Content-Encoding: gzip
Content-Length: 106
Keep-Alive: timeout&#x3D;2, max&#x3D;100
Connection: Keep-Alive
Content-Type: text&#x2F;plain

[text&#x2F;plain payload]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>即使第 10 行指定了 Cookie 是属于 <code>https://bar.other</code> 的内容的，但是，如果 <code>https://bar.other</code> 的响应中缺失 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials"><code>Access-Control-Allow-Credentials</code></a><code>: true</code>（第 16 行），则响应内容会被忽略，不会提供给 web 内容。</p>
<h4 id="预检请求和凭据"><a href="#预检请求和凭据" class="headerlink" title="预检请求和凭据"></a>预检请求和凭据</h4><p>CORS 预检请求不能包含凭据。预检请求的<em>响应</em>必须指定 <code>Access-Control-Allow-Credentials: true</code> 来表明可以携带凭据进行实际的请求。</p>
<p><strong>备注：</strong> 一些企业认证服务要求在预检请求时发送 TLS 客户端证书，这违反了 <a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#cors-protocol-and-credentials">Fetch</a> 的规范。</p>
<p>Firefox 87 允许通过在设置中设定 <code>network.cors_preflight.allow_client_cert</code> 为 <code>true</code>（<a target="_blank" rel="noopener" href="https://bugzil.la/1511151">Firefox bug 1511151</a>）来允许这种不规范的行为。基于 chromium 的浏览器目前总是在 CORS 预检请求中发送 TLS 客户端证书（<a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=775438">Chrome bug 775438</a>）。</p>
<h3 id="附带身份凭证的请求与通配符"><a href="#附带身份凭证的请求与通配符" class="headerlink" title="附带身份凭证的请求与通配符"></a>附带身份凭证的请求与通配符</h3><p>在响应附带身份凭证的请求时：</p>
<ul>
<li>服务器<strong>不能</strong>将 <code>Access-Control-Allow-Origin</code> 的值设为通配符“<code>*</code>”，而应将其设置为特定的域，如：<code>Access-Control-Allow-Origin: https://example.com</code>。</li>
<li>服务器<strong>不能</strong>将 <code>Access-Control-Allow-Headers</code> 的值设为通配符“<code>*</code>”，而应将其设置为标头名称的列表，如：<code>Access-Control-Allow-Headers: X-PINGOTHER, Content-Type</code></li>
<li>服务器<strong>不能</strong>将 <code>Access-Control-Allow-Methods</code> 的值设为通配符“<code>*</code>”，而应将其设置为特定请求方法名称的列表，如：<code>Access-Control-Allow-Methods: POST, GET</code></li>
</ul>
<p>对于附带身份凭证的请求（通常是 <code>Cookie</code>），</p>
<p>这是因为请求的标头中携带了 <code>Cookie</code> 信息，如果 <code>Access-Control-Allow-Origin</code> 的值为“<code>*</code>”，请求将会失败。而将 <code>Access-Control-Allow-Origin</code> 的值设置为 <code>https://example.com</code>，则请求将成功执行。</p>
<p>另外，响应标头中也携带了 <code>Set-Cookie</code> 字段，尝试对 Cookie 进行修改。如果操作失败，将会抛出异常。</p>
<h3 id="第三方-cookie"><a href="#第三方-cookie" class="headerlink" title="第三方 cookie"></a>第三方 cookie</h3><p>注意在 CORS 响应中设置的 cookie 适用一般性第三方 cookie 策略。在上面的例子中，页面是在 <code>foo.example</code> 加载，但是第 19 行的 cookie 是被 <code>bar.other</code> 发送的，如果用户设置其浏览器拒绝所有第三方 cookie，那么将不会被保存。</p>
<p>请求中的 cookie（第 10 行）也可能在正常的第三方 cookie 策略下被阻止。因此，强制执行的 cookie 策略可能会使本节描述的内容无效（阻止你发出任何携带凭据的请求）。</p>
<p>Cookie 策略受 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value">SameSite</a> 属性控制。</p>
<h2 id="其他参考内容"><a href="#其他参考内容" class="headerlink" title="其他参考内容"></a>其他参考内容</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS/Errors">CORS 错误</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/43871637/no-access-control-allow-origin-header-is-present-on-the-requested-resource-whe/43881141#43881141">Stack Overflow 面对常见问题的解答</a>:</li>
<li><a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#http-cors-protocol">跨源共享标准</a></li>
</ul>
<h1 id="实践排查解决"><a href="#实践排查解决" class="headerlink" title="实践排查解决"></a>实践排查解决</h1><blockquote>
<p>部署静态页面服务 (端口号为 8888) 及后端接口服务 (端口号为 8080) ，启用不同的端口，不遵循同源策略。</p>
</blockquote>
<h2 id="若干访问控制场景-1"><a href="#若干访问控制场景-1" class="headerlink" title="若干访问控制场景"></a>若干访问控制场景</h2><h3 id="简单请求-1"><a href="#简单请求-1" class="headerlink" title="简单请求"></a>简单请求</h3><p><strong>静态页面</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>跨域请求<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>request.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  
           <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8080/server/cors'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>  
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
               document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  
               document  
            <span class="token punctuation">&#125;</span>  
           <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>后端服务</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Controller</span>  
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/server"</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CorsController</span> <span class="token punctuation">&#123;</span>  
  
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/cors"</span><span class="token punctuation">,</span> method<span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>  
    <span class="token annotation punctuation">@ResponseBody</span>  
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">ajaxCors</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">return</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在不配置跨域过滤器时，请求响应如下：</p>
<p><img src="/images/Linux/CORS-不配置跨域请求示例.png" alt=""></p>
<p>可见请求头带了 Origin，但响应并没有给出 Access-Control-Allow-Origin。控制台中浏览器输出 <code>Access to XMLHttpRequest at &#39;http://localhost:8080/server/cors&#39; from origin &#39;http://localhost:8888&#39; has been blocked by CORS policy: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource.</code> 在响应体中显示 <code>Fail load response data:No data found for resource with given identifier</code>。</p>
<p>在增加配置跨域过滤器时，请求响应如下：</p>
<p><img src="/images/Linux/CORS-配置跨域请求示例.png" alt=""></p>
<p>可见响应正常返回数据。</p>
<blockquote>
<p>注意：<br>浏览器请求是发出去了的，服务端也会正确返回，但是我们拿不到 response 的内容。但逻辑是执行了的，只是前端拿不到正确返回的数据。</p>
</blockquote>
<h3 id="预检请求-1"><a href="#预检请求-1" class="headerlink" title="预检请求"></a>预检请求</h3><p>简单请求的条件如下：</p>
<ol>
<li>HTTP 值含：GET、HEAD、POST</li>
<li>Content-Type 值含： <code>text/plain</code>、<code>multipart/form-data</code>、<code>application/x-www-form-urlencoded</code></li>
<li>请求头仅含：<code>Accept</code>、<code>Accept-Language</code>、<code>Content-Language</code>、<code>Content-Type</code>、<code>DPR</code>、<code>Downlink</code>、<code>Save-Data</code>、 <code>Viewport-Width</code>、<code>Width</code></li>
</ol>
<p>不满足上述要求的在发送正式请求前都要先发送一个预检请求，预检请求以 OPTIONS 方法发送，浏览器通过请求方法和请求头能够判断是否发送预检请求。</p>
<p><strong>Client 发送如下请求：</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8080/server/options'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>  
   <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>  
   <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  
      <span class="token literal-property property">company</span><span class="token operator">:</span> <span class="token string">'大众点评'</span>  
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  
   <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>  
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  
   <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
      document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  
   <span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Server 端处理请求的 Controller:</strong></p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">@Controller  
@RequestMapping(&quot;&#x2F;server&quot;)  
public class CorsController &#123;
    @RequestMapping(value&#x3D;&quot;&#x2F;options&quot;, method&#x3D; RequestMethod.POST)  
    @ResponseBody  
    public String options(HttpServletRequest request) throws Exception&#123;  
        return &quot;SUCCESS&quot;;  
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为请求时，请求头中塞入了 Header，<code>&#39;Content-Type&#39;: &#39;application/json&#39;</code>。根据前面讲述的可以知道，浏览器会以 OPTIONS 方法发出一个预检请求，浏览器会在请求头中加入 <code>Access-Control-Request-Headers:content-type</code> 、<code>Access-Control-Request-Method:POST</code>。这个预检请求的作用在这里就是告诉服务器：我会在后面请求中以 POST 方法发送 Request Header 带有 Content-Type 的请求，询问服务器是否允许。</p>
<p><img src="/images/Linux/CORS-不配置跨域允许请求头.png" alt=""></p>
<p>在这里服务器还没有做任何允许这种请求的设置，所以浏览器控制台报错 <code>Access to XMLHttpRequest at &#39;http://localhost:8080/server/options&#39; from origin &#39;http://localhost:8888&#39; has been blocked by CORS policy: Request header field content-type is not allowed by Access-Control-Allow-Headers in preflight response.</code>。说明了出错的原因： 服务端在预检请求的响应中没有告诉浏览器允许协议头 Content-Type，即服务端需要设置响应头 Access-Control-Allow-Headers，允许浏览器发送带 Content-Type 的请求。</p>
<p>在设置完成后可以看到请求成功。</p>
<p><img src="/images/Linux/CORS-配置跨域允许请求头.png" alt=""></p>
<p>但是这里有个问题，需要预检请求时，浏览器会发出两次请求，一次 OPTIONS，一次 POST。两次都返回了数据。这样服务端如果逻辑复杂，整体逻辑就会走两遍，浏览器会两次拿到相同的数据，所以服务端的 Filter 可以改一下，如果是 OPTIONS 请求，在设置完跨域请求响应头后就不走后面的逻辑直接返回。</p>
<blockquote>
<p>注意：</p>
<ol>
<li>对于 POST 请求设置响应头 Content-Type 为某些值、自定义请求头等情况，浏览器会先以 OPTIONS 方法发送一个预检请求，并设置相应的请求头。</li>
<li>服务端还是正常返回，但如果预检请求响应头中不设置相应的响应头，预检请求不通过，不会再发出第二次请求来获取数据。</li>
</ol>
</blockquote>
<h3 id="带凭证信息的请求"><a href="#带凭证信息的请求" class="headerlink" title="带凭证信息的请求"></a>带凭证信息的请求</h3><p>浏览器在发送请求时需要给服务端发送 Cookie，服务端根据 Cookie 中的信息做一些身份验证等。默认情况下，浏览器向不同域的发送 Ajax 请求，不会携带发送 Cookie 信息。</p>
<p><strong>Client 请求：</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> containerElem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span>  
<span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8080/server/testCookie'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>  
   <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>  
 <span class="token comment">//  withCredentials: true,  </span>
   <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>  
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  
   <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
      containerElem<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data  
   <span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Server 响应：</strong></p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">@RequestMapping(value&#x3D;&quot;&#x2F;testCookie&quot;)  
@ResponseBody  
public String testCookie(HttpServletRequest request, HttpServletResponse response) throws Exception&#123;  
    String str &#x3D; &quot;SUCCESS&quot;;  
    Cookie[] cookies &#x3D; request.getCookies();  
    String school &#x3D; getSchool(cookies);  
    if(school &#x3D;&#x3D; null || school.length() &#x3D;&#x3D; 0)&#123;  
        addCookie(response);  
    &#125;    return str + buildText(cookies);  
&#125;  
  
private String buildText(Cookie[] cookies)&#123;  
    String text &#x3D; &quot;&quot;;  
    if(cookies!&#x3D;null)&#123;  
        for(int i&#x3D;0; i&lt;cookies.length;i++)&#123;  
            text &#x3D; text + new StringBuilder().append(&quot;&lt;br&#x2F;&gt;&quot;)  
                    .append(cookies[i].getName())  
                    .append(&quot;&#x3D;&quot;)  
                    .append((cookies[i].getValue())).toString();  
        &#125;    &#125;    return text;  
&#125;  
  
private static String getSchool(Cookie[] cookies) &#123;  
    String school &#x3D; &quot;&quot;;  
    if(cookies &#x3D;&#x3D; null)&#123;  
        return school;  
    &#125;  
    int len &#x3D; cookies.length;  
    for(int i &#x3D; 0; i &lt; len; i++) &#123;  
        Cookie cookie &#x3D; cookies[i];  
        if(cookie !&#x3D; null &amp;&amp; &quot;school&quot;.equals(cookie.getName())) &#123;  
            school &#x3D; cookie.getValue();  
            break;  
        &#125;    &#125;    return school;  
&#125;  
  
  
private static void addCookie(HttpServletResponse response) &#123;  
    int maxAge &#x3D; -1;  
    Cookie cookie &#x3D; new Cookie(&quot;school&quot;, &quot;seu&quot;);  
    cookie.setDomain(&quot;localhost&quot;);  
    cookie.setPath(&quot;&#x2F;&quot;);  
    cookie.setMaxAge(maxAge);  
    response.addCookie(cookie);  
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务端收到请求，判断 Cookie 中有没有 school，没有就添加 Cookie.</p>
<p><img src="/images/Linux/CORS-跨域Cookie处理.png" alt=""></p>
<p>可以看到响应头中有 Set-Cookie，再次请求时，如果是同源请求，浏览器会将 Set-Cookie 中的值放在请求头中，但是<strong>对于跨域请求，默认是不发送这个 Cookie 的。</strong>如果要让浏览器发送 Cookie，需要在 Client 设置 XMLHttpRequest 的 withCredentials 属性为 true。</p>
<p>设置后，再次请求控制台报错：<code>Access to XMLHttpRequest at &#39;http://localhost:8080/server/testCookie&#39; from origin &#39;http://localhost:8888&#39; has been blocked by CORS policy: Response to preflight request doesn&#39;t pass access control check: The value of the &#39;Access-Control-Allow-Credentials&#39; header in the response is &#39;&#39; which must be &#39;true&#39; when the request&#39;s credentials mode is &#39;include&#39;. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.</code>。</p>
<p>即需要在后端将 <code>Access-Control-Allow-Credentials</code> 请求头置为 <code>true</code>。</p>
<p><img src="/images/Linux/CORS-跨域后端Cookie处理.png" alt=""></p>
<p>此时可看到在第二次请求该接口时会带上请求头 Cookie 并包含 school 信息。</p>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><h3 id="request-js"><a href="#request-js" class="headerlink" title="request.js"></a>request.js</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Request <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Request</span><span class="token punctuation">&#123;</span>  
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'GET'</span>  
    <span class="token punctuation">&#125;</span>  
  
    <span class="token function">getXMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>  
            xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
            <span class="token keyword">try</span><span class="token punctuation">&#123;</span>  
                <span class="token comment">//IE5和IE6  </span>
                xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"microsoft.xmlhttp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
                window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"您的浏览器不支持Ajax,换一个浏览器试试吧！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">&#125;</span>  
        <span class="token punctuation">&#125;</span>  
        <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
      
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span>opts<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getXMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>method <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">,</span>url<span class="token punctuation">,</span>opts<span class="token punctuation">.</span>asyn <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> opts<span class="token punctuation">.</span>withCredentials<span class="token punctuation">;</span>  
        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
            <span class="token keyword">switch</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
                <span class="token keyword">case</span> <span class="token number">0</span> <span class="token operator">:</span>   
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"请求未初始化"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  
                <span class="token keyword">case</span> <span class="token number">1</span> <span class="token operator">:</span>  
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"服务器连接已建立"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  
                <span class="token keyword">case</span> <span class="token number">2</span> <span class="token operator">:</span>  
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"请求已接收"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  
                <span class="token keyword">case</span> <span class="token number">3</span> <span class="token operator">:</span>  
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"请求处理中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  
                <span class="token keyword">case</span> <span class="token number">4</span> <span class="token operator">:</span>  
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"请求已完成，且响应已就绪"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">>=</span><span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token operator">||</span> xhr <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                        opts<span class="token punctuation">.</span>success <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>  
                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>  
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>xhr<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">，请求出错</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token punctuation">&#125;</span>  
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  
            <span class="token punctuation">&#125;</span>  
        <span class="token punctuation">&#125;</span>  
        opts<span class="token punctuation">.</span>header <span class="token operator">=</span> opts<span class="token punctuation">.</span>header <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> opts<span class="token punctuation">.</span>header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
            xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>header<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span>  
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="SpringBoot-设置跨域请求配置"><a href="#SpringBoot-设置跨域请求配置" class="headerlink" title="SpringBoot 设置跨域请求配置"></a>SpringBoot 设置跨域请求配置</h1><h2 id="CrossOrigin-注解"><a href="#CrossOrigin-注解" class="headerlink" title="CrossOrigin 注解"></a>CrossOrigin 注解</h2><p>Controller 层级的配置，并且配置读取的优先级高于 Filter。需要注意的是 origin 的配置需要包含：协议 <code>http</code>、服务 <code>www</code>、域名 <code>localhost</code>、端口 <code>8888</code>。</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">@RestController  
@RequestMapping(&quot;&#x2F;server&quot;)  
@CrossOrigin(
	origins &#x3D; &#123;&quot;http:&#x2F;&#x2F;localhost:8888&quot;&#125;, 
	methods &#x3D; &#123;RequestMethod.GET&#125;
)  
public class CorsController &#123;
	...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Filter-过滤器"><a href="#Filter-过滤器" class="headerlink" title="Filter 过滤器"></a>Filter 过滤器</h2><p>请求层级的配置。根据上述介绍的 CORS 协议进行设置即可。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CORSFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HttpServletResponse</span> resp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span>servletResponse<span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:8888"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Methods"</span><span class="token punctuation">,</span> <span class="token string">"GET,POST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Headers"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Credentials"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//OPTION请求就直接返回</span>
        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resp<span class="token punctuation">.</span><span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span>servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Network/" rel="tag"># Network</a>
              <a href="/tags/HTTP/" rel="tag"># HTTP</a>
              <a href="/tags/CORS/" rel="tag"># CORS</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/05/22/Linux-VIM%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/" rel="prev" title="IDEA VIM文本编辑器">
      <i class="fa fa-chevron-left"></i> IDEA VIM文本编辑器
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/06/01/%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F-1-%E6%9E%B6%E6%9E%84/" rel="next" title="架构设计 支付系统架构">
      架构设计 支付系统架构 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%90%86%E8%AE%BA%E8%A7%A3%E9%87%8A"><span class="nav-number">1.</span> <span class="nav-text">理论解释</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">功能概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8B%A5%E5%B9%B2%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E5%9C%BA%E6%99%AF"><span class="nav-number">1.2.</span> <span class="nav-text">若干访问控制场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82"><span class="nav-number">1.2.1.</span> <span class="nav-text">简单请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82"><span class="nav-number">1.2.2.</span> <span class="nav-text">预检请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">预检请求与重定向</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%B8%A6%E8%BA%AB%E4%BB%BD%E5%87%AD%E8%AF%81%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="nav-number">1.2.3.</span> <span class="nav-text">附带身份凭证的请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82%E5%92%8C%E5%87%AD%E6%8D%AE"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">预检请求和凭据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%B8%A6%E8%BA%AB%E4%BB%BD%E5%87%AD%E8%AF%81%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%8E%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="nav-number">1.2.4.</span> <span class="nav-text">附带身份凭证的请求与通配符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9-cookie"><span class="nav-number">1.2.5.</span> <span class="nav-text">第三方 cookie</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="nav-number">1.3.</span> <span class="nav-text">其他参考内容</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E6%8E%92%E6%9F%A5%E8%A7%A3%E5%86%B3"><span class="nav-number">2.</span> <span class="nav-text">实践排查解决</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8B%A5%E5%B9%B2%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E5%9C%BA%E6%99%AF-1"><span class="nav-number">2.1.</span> <span class="nav-text">若干访问控制场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82-1"><span class="nav-number">2.1.1.</span> <span class="nav-text">简单请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82-1"><span class="nav-number">2.1.2.</span> <span class="nav-text">预检请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%A6%E5%87%AD%E8%AF%81%E4%BF%A1%E6%81%AF%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="nav-number">2.1.3.</span> <span class="nav-text">带凭证信息的请求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">附件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#request-js"><span class="nav-number">2.2.1.</span> <span class="nav-text">request.js</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot-%E8%AE%BE%E7%BD%AE%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">SpringBoot 设置跨域请求配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CrossOrigin-%E6%B3%A8%E8%A7%A3"><span class="nav-number">3.1.</span> <span class="nav-text">CrossOrigin 注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filter-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.2.</span> <span class="nav-text">Filter 过滤器</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Wang Zihao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">162</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">310</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Zihao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
